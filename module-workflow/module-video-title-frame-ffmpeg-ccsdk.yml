name: module-video-title-frame-ffmpeg-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      video-url:
        description: 'å…ƒå‹•ç”»URL'
        required: true
        type: string
      title-image-url:
        description: 'ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒURL'
        required: true
        type: string
      title-duration:
        description: 'ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºæ™‚é–“ï¼ˆç§’ï¼‰'
        required: false
        type: string
        default: '3'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      video_index:
        description: 'å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      video-url:
        description: 'ã‚¿ã‚¤ãƒˆãƒ«ä»˜ãå‹•ç”»URL'
        value: ${{ jobs.title-frame.outputs.video-url }}
      completed:
        description: 'å‡¦ç†å®Œäº†ãƒ•ãƒ©ã‚°'
        value: ${{ jobs.title-frame.outputs.completed }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  title-frame:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      video-url: ${{ steps.title-complete.outputs.video-url }}
      completed: ${{ steps.title-complete.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg wget
          
          # ffmpegã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
          ffmpeg -version | head -5
      
      - name: ğŸ¬ å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ æŒ¿å…¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Claude Code SDK + ffmpeg)
        id: insert-title-frame
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ¬ Video Title Frame Insert Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_CONCEPT="${{ inputs.concept }}"
          VIDEO_URL="${{ inputs.video-url }}"
          TITLE_IMAGE_URL="${{ inputs.title-image-url }}"
          TITLE_DURATION="${{ inputs.title-duration }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          TITLE_DIR="$FOLDER_NAME/title-frame-${{ inputs.video_index }}"
          VIDEO_INDEX="${{ inputs.video_index }}"
          
          echo "User concept: $USER_CONCEPT"
          echo "Video URL: $VIDEO_URL"
          echo "Title image URL: $TITLE_IMAGE_URL"
          echo "Title duration: $TITLE_DURATION seconds"
          echo "Title directory: $TITLE_DIR"
          echo "Video index: $VIDEO_INDEX"
          
          # ã‚¿ã‚¤ãƒˆãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p "$TITLE_DIR"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯ffmpegã‚’ä½¿ç”¨ã—ãŸå‹•ç”»ç·¨é›†ã®å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚å‹•ç”»ã®å…ˆé ­ã«ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æŒ¿å…¥ã—ã¦ãã ã•ã„ã€‚

          **å…¥åŠ›æƒ…å ±**:
          - **å‹•ç”»URL**: $VIDEO_URL
          - **ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒURL**: $TITLE_IMAGE_URL
          - **ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºæ™‚é–“**: $TITLE_DURATION ç§’
          - **ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: $TITLE_DIR

          **é‡è¦**: å‹•ç”»URLã¾ãŸã¯ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒURLãŒç©ºã¾ãŸã¯\"undefined\"ã®å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã—ã¦ãã ã•ã„

          **å®Ÿè¡Œæ‰‹é †**:

          1. **ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—**:
             ```bash
             cd $TITLE_DIR
             
             # å…ƒå‹•ç”»ã®å–å¾—ï¼ˆURLã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
             if [[ \"$VIDEO_URL\" == http* ]]; then
               echo \"å‹•ç”»URLã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: $VIDEO_URL\"
               wget \"$VIDEO_URL\" -O original-video.mp4
             elif [[ \"$VIDEO_URL\" == ./* ]]; then
               echo \"ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼: $VIDEO_URL\"
               # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã®å ´åˆã€title-frameãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§å‚ç…§
               # ä¾‹: ./audio-lipsync-xxx/subtitle-overlay-1/video.mp4 â†’ ../subtitle-overlay-1/video.mp4
               RELATIVE_PATH=\"\$(echo \"$VIDEO_URL\" | sed \"s|^\\./[^/]*/|../|\")\\"
               echo \"ç›¸å¯¾ãƒ‘ã‚¹: $RELATIVE_PATH\"
               if [ -f \"$RELATIVE_PATH\" ]; then
                 cp \"$RELATIVE_PATH\" original-video.mp4
               else
                 echo \"ã‚¨ãƒ©ãƒ¼: ãƒ­ãƒ¼ã‚«ãƒ«å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $RELATIVE_PATH\"
                 exit 1
               fi
             else
               echo \"ã‚¨ãƒ©ãƒ¼: å‹•ç”»URLã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ãŒç„¡åŠ¹ã§ã™: $VIDEO_URL\"
               exit 1
             fi
             
             # ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
             wget \"$TITLE_IMAGE_URL\" -O title-image.jpg
             
             # ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
             ls -la original-video.mp4 title-image.jpg
             ```

          2. **å‹•ç”»æƒ…å ±ã®ç¢ºèª**:
             ```bash
             # å…ƒå‹•ç”»ã®æƒ…å ±ã‚’å–å¾—
             ffprobe -v quiet -print_format json -show_format -show_streams original-video.mp4 > original-video-info.json
             
             # å‹•ç”»ã®è§£åƒåº¦ã¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã‚’ç¢ºèª
             VIDEO_WIDTH=\$(ffprobe -v quiet -select_streams v:0 -show_entries stream=width -of csv=s=x:p=0 original-video.mp4)
             VIDEO_HEIGHT=\$(ffprobe -v quiet -select_streams v:0 -show_entries stream=height -of csv=s=x:p=0 original-video.mp4)
             VIDEO_FPS=\$(ffprobe -v quiet -select_streams v:0 -show_entries stream=r_frame_rate -of csv=s=x:p=0 original-video.mp4)
             
             echo \"Original video: \${VIDEO_WIDTH}x\${VIDEO_HEIGHT} @ \${VIDEO_FPS} fps\"
             ```

          3. **ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒã®å‹•ç”»åŒ–**:
             ```bash
             # ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒã‚’å…ƒå‹•ç”»ã¨åŒã˜è§£åƒåº¦ã«ãƒªã‚µã‚¤ã‚ºã—ã¦å‹•ç”»åŒ–
             ffmpeg -loop 1 -i title-image.jpg \\
               -t $TITLE_DURATION \\
               -vf \"scale=\${VIDEO_WIDTH}:\${VIDEO_HEIGHT}:force_original_aspect_ratio=increase,crop=\${VIDEO_WIDTH}:\${VIDEO_HEIGHT}\" \\
               -r \${VIDEO_FPS} \\
               -pix_fmt yuv420p \\
               -an \\
               title-segment.mp4
             
             # ã‚¿ã‚¤ãƒˆãƒ«å‹•ç”»ã®ç¢ºèª
             echo \"Title segment created:\"
             ffprobe -v quiet -show_format title-segment.mp4
             ```

          4. **éŸ³å£°å‡¦ç†**:
             ```bash
             # å…ƒå‹•ç”»ã®éŸ³å£°ã‚’æŠ½å‡º
             ffmpeg -i original-video.mp4 -vn -acodec aac -ab 128k original-audio.aac
             
             # ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ç”¨ã®ç„¡éŸ³éŸ³å£°ã‚’ä½œæˆï¼ˆå…ƒå‹•ç”»ã¨åŒã˜è¨­å®šï¼‰
             SAMPLE_RATE=\$(ffprobe -v quiet -select_streams a:0 -show_entries stream=sample_rate -of csv=s=x:p=0 original-video.mp4)
             CHANNELS=\$(ffprobe -v quiet -select_streams a:0 -show_entries stream=channels -of csv=s=x:p=0 original-video.mp4)
             
             ffmpeg -f lavfi -i \"anullsrc=channel_layout=stereo:sample_rate=\${SAMPLE_RATE}\" \\
               -t $TITLE_DURATION \\
               -c:a aac -ab 128k \\
               title-silence.aac
             ```

          5. **å‹•ç”»ã¨éŸ³å£°ã®çµåˆ**:
             ```bash
             # ã‚¿ã‚¤ãƒˆãƒ«å‹•ç”»ã«ç„¡éŸ³éŸ³å£°ã‚’è¿½åŠ 
             ffmpeg -i title-segment.mp4 -i title-silence.aac \\
               -c:v copy -c:a copy -shortest \\
               title-with-audio.mp4
             
             # å…ƒå‹•ç”»ã¨ã‚¿ã‚¤ãƒˆãƒ«å‹•ç”»ã‚’é€£çµ
             # ãƒªã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
             echo \"file 'title-with-audio.mp4'\" > concat-list.txt
             echo \"file 'original-video.mp4'\" >> concat-list.txt
             
             # å‹•ç”»ã‚’é€£çµï¼ˆç›´æ¥video.mp4ã¨ã—ã¦å‡ºåŠ›ï¼‰
             ffmpeg -f concat -safe 0 -i concat-list.txt \\
               -c copy \\
               video.mp4
             ```

          6. **å“è³ªç¢ºèª**:
             ```bash
             # æœ€çµ‚å‹•ç”»ã®ç¢ºèª
             ffprobe -v quiet -show_format -show_streams video.mp4
             
             # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨é•·ã•ã®ç¢ºèª
             echo \"Final video info:\"
             ls -lh video.mp4
             
             # éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ç¢ºèª
             ffprobe -v quiet -select_streams a -show_entries stream=codec_name,duration -of csv=s=x:p=0 video.mp4
             
             # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
             echo \"ã‚¿ã‚¤ãƒˆãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ä»˜ãå‹•ç”»ç”Ÿæˆå®Œäº†: $TITLE_DURATION ç§’ã®ã‚¿ã‚¤ãƒˆãƒ« + å…ƒå‹•ç”»\" > title-frame-log.txt
             echo \"ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒ: $TITLE_IMAGE_URL\" >> title-frame-log.txt
             echo \"å…ƒå‹•ç”»: $VIDEO_URL\" >> title-frame-log.txt
             ```

          **é‡è¦ãªæŠ€è¡“ãƒã‚¤ãƒ³ãƒˆ**:
          - å…ƒå‹•ç”»ã¨åŒã˜è§£åƒåº¦ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã§ã‚¿ã‚¤ãƒˆãƒ«å‹•ç”»ã‚’ä½œæˆ
          - éŸ³å£°ã®é€£ç¶šæ€§ã‚’ä¿æŒï¼ˆã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã¯ç„¡éŸ³ã€å‹•ç”»éƒ¨åˆ†ã¯å…ƒéŸ³å£°ï¼‰
          - concat demuxerã‚’ä½¿ç”¨ã—ãŸé«˜å“è³ªãªå‹•ç”»é€£çµ
          - éŸ³å£°ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ã®çµ±ä¸€ï¼ˆAACï¼‰

          **ã‚¨ãƒ©ãƒ¼å‡¦ç†**:
          - ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚³ãƒ”ãƒ¼ï¼‰
          - ffmpegå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
          - å‹•ç”»æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
          **å‡ºåŠ›è¦æ±‚**:
          1. ã‚¿ã‚¤ãƒˆãƒ«ä»˜ãå‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ« (video.mp4) - æœ€çµ‚çš„ãªé€£çµæ™‚ã«ç›´æ¥ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã§å‡ºåŠ›ã™ã‚‹ã“ã¨
          2. å‡¦ç†ãƒ­ã‚° (title-frame-log.txt)"
          
          echo "ğŸš€ Starting Title Frame Insert Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --max-turns 60 \
            --verbose \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          echo "::endgroup::"

      - name: Mark title frame insert complete
        id: title-complete
        run: |
          TITLE_DIR="${{ inputs.folder-name }}/title-frame-${{ inputs.video_index }}"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ğŸ“‹ Checking generated title frame files..."
          if [ -d "$TITLE_DIR" ]; then
            echo "::notice::ğŸ“ Title frame directory contents:"
            ls -la "$TITLE_DIR"
            
            # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -f "$TITLE_DIR/video.mp4" ]; then
              echo "âœ… Found: video.mp4"
              echo "video-url=./$TITLE_DIR/video.mp4" >> $GITHUB_OUTPUT
              echo "completed=true" >> $GITHUB_OUTPUT
              
            else
              echo "::error::âŒ Missing required file: video.mp4"
              echo "completed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
          else
            echo "::error::âŒ Title frame directory not found"
            echo "completed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Commit title frame files
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/title-frame-${{ inputs.video_index }}/
          if git diff --cached --quiet; then
            echo "No title frame files to commit"
          else
            git commit -m "ğŸ¬ Add title frame to video: ${{ inputs.concept }} (video-${{ inputs.video_index }})

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi