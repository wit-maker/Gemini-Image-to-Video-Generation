name: module-banner-planning-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒãƒŠãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      text_content:
        description: 'ç”»åƒã«è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ'
        required: true
        type: string
      banner_size:
        description: 'ãƒãƒŠãƒ¼ã‚µã‚¤ã‚º'
        required: false
        type: string
        default: 'square_1_1'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      total_banners:
        description: 'ç”Ÿæˆã™ã‚‹ãƒãƒŠãƒ¼ã®æ•°'
        required: false
        type: string
        default: '1'
    outputs:
      planning-completed:
        description: 'ä¼ç”»å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.planning.outputs.planning-completed }}
      # å‹•çš„å‡ºåŠ›ï¼ˆæœ€å¤§8ãƒãƒŠãƒ¼ã¾ã§å¯¾å¿œï¼‰
      base-image-prompt-1:
        description: 'ãƒãƒŠãƒ¼1ç”¨ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.base-image-prompt-1 }}
      base-image-prompt-2:
        description: 'ãƒãƒŠãƒ¼2ç”¨ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.base-image-prompt-2 }}
      base-image-prompt-3:
        description: 'ãƒãƒŠãƒ¼3ç”¨ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.base-image-prompt-3 }}
      base-image-prompt-4:
        description: 'ãƒãƒŠãƒ¼4ç”¨ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.base-image-prompt-4 }}
      base-image-prompt-5:
        description: 'ãƒãƒŠãƒ¼5ç”¨ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.base-image-prompt-5 }}
      base-image-prompt-6:
        description: 'ãƒãƒŠãƒ¼6ç”¨ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.base-image-prompt-6 }}
      base-image-prompt-7:
        description: 'ãƒãƒŠãƒ¼7ç”¨ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.base-image-prompt-7 }}
      base-image-prompt-8:
        description: 'ãƒãƒŠãƒ¼8ç”¨ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.base-image-prompt-8 }}
      banner-concept-1:
        description: 'ãƒãƒŠãƒ¼1ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.banner-concept-1 }}
      banner-concept-2:
        description: 'ãƒãƒŠãƒ¼2ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.banner-concept-2 }}
      banner-concept-3:
        description: 'ãƒãƒŠãƒ¼3ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.banner-concept-3 }}
      banner-concept-4:
        description: 'ãƒãƒŠãƒ¼4ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.banner-concept-4 }}
      banner-concept-5:
        description: 'ãƒãƒŠãƒ¼5ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.banner-concept-5 }}
      banner-concept-6:
        description: 'ãƒãƒŠãƒ¼6ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.banner-concept-6 }}
      banner-concept-7:
        description: 'ãƒãƒŠãƒ¼7ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.banner-concept-7 }}
      banner-concept-8:
        description: 'ãƒãƒŠãƒ¼8ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.banner-concept-8 }}
      text-layout-strategy-1:
        description: 'ãƒãƒŠãƒ¼1ç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥'
        value: ${{ jobs.planning.outputs.text-layout-strategy-1 }}
      text-layout-strategy-2:
        description: 'ãƒãƒŠãƒ¼2ç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥'
        value: ${{ jobs.planning.outputs.text-layout-strategy-2 }}
      text-layout-strategy-3:
        description: 'ãƒãƒŠãƒ¼3ç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥'
        value: ${{ jobs.planning.outputs.text-layout-strategy-3 }}
      text-layout-strategy-4:
        description: 'ãƒãƒŠãƒ¼4ç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥'
        value: ${{ jobs.planning.outputs.text-layout-strategy-4 }}
      text-layout-strategy-5:
        description: 'ãƒãƒŠãƒ¼5ç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥'
        value: ${{ jobs.planning.outputs.text-layout-strategy-5 }}
      text-layout-strategy-6:
        description: 'ãƒãƒŠãƒ¼6ç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥'
        value: ${{ jobs.planning.outputs.text-layout-strategy-6 }}
      text-layout-strategy-7:
        description: 'ãƒãƒŠãƒ¼7ç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥'
        value: ${{ jobs.planning.outputs.text-layout-strategy-7 }}
      text-layout-strategy-8:
        description: 'ãƒãƒŠãƒ¼8ç”¨ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥'
        value: ${{ jobs.planning.outputs.text-layout-strategy-8 }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  planning:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      # å‹•çš„å‡ºåŠ›ï¼ˆæœ€å¤§8ãƒãƒŠãƒ¼ã¾ã§å¯¾å¿œï¼‰
      base-image-prompt-1: ${{ steps.planning.outputs.base-image-prompt-1 }}
      base-image-prompt-2: ${{ steps.planning.outputs.base-image-prompt-2 }}
      base-image-prompt-3: ${{ steps.planning.outputs.base-image-prompt-3 }}
      base-image-prompt-4: ${{ steps.planning.outputs.base-image-prompt-4 }}
      base-image-prompt-5: ${{ steps.planning.outputs.base-image-prompt-5 }}
      base-image-prompt-6: ${{ steps.planning.outputs.base-image-prompt-6 }}
      base-image-prompt-7: ${{ steps.planning.outputs.base-image-prompt-7 }}
      base-image-prompt-8: ${{ steps.planning.outputs.base-image-prompt-8 }}
      banner-concept-1: ${{ steps.planning.outputs.banner-concept-1 }}
      banner-concept-2: ${{ steps.planning.outputs.banner-concept-2 }}
      banner-concept-3: ${{ steps.planning.outputs.banner-concept-3 }}
      banner-concept-4: ${{ steps.planning.outputs.banner-concept-4 }}
      banner-concept-5: ${{ steps.planning.outputs.banner-concept-5 }}
      banner-concept-6: ${{ steps.planning.outputs.banner-concept-6 }}
      banner-concept-7: ${{ steps.planning.outputs.banner-concept-7 }}
      banner-concept-8: ${{ steps.planning.outputs.banner-concept-8 }}
      text-layout-strategy-1: ${{ steps.planning.outputs.text-layout-strategy-1 }}
      text-layout-strategy-2: ${{ steps.planning.outputs.text-layout-strategy-2 }}
      text-layout-strategy-3: ${{ steps.planning.outputs.text-layout-strategy-3 }}
      text-layout-strategy-4: ${{ steps.planning.outputs.text-layout-strategy-4 }}
      text-layout-strategy-5: ${{ steps.planning.outputs.text-layout-strategy-5 }}
      text-layout-strategy-6: ${{ steps.planning.outputs.text-layout-strategy-6 }}
      text-layout-strategy-7: ${{ steps.planning.outputs.text-layout-strategy-7 }}
      text-layout-strategy-8: ${{ steps.planning.outputs.text-layout-strategy-8 }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ãƒãƒŠãƒ¼åˆ¶ä½œè¨ˆç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ“‹ Banner Planning Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_CONCEPT="${{ inputs.concept }}"
          USER_TEXT_CONTENT="${{ inputs.text_content }}"
          BANNER_SIZE="${{ inputs.banner_size }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          TOTAL_BANNERS="${{ inputs.total_banners }}"
          
          echo "User concept: $USER_CONCEPT"
          echo "User text content: $USER_TEXT_CONTENT"
          echo "Banner size: $BANNER_SIZE"
          echo "Planning folder: $PLANNING_DIR"
          echo "Total banners: $TOTAL_BANNERS"
          
          # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$PLANNING_DIR" ]; then
            mkdir -p "$PLANNING_DIR"
            echo "ğŸ“ Created planning folder: $PLANNING_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯ãƒãƒŠãƒ¼åºƒå‘Šåˆ¶ä½œã®å°‚é–€ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‹ã‚‰${TOTAL_BANNERS}ã¤ã®ãƒãƒŠãƒ¼åºƒå‘Šã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®è©³ç´°ãªè¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

          **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤º**:
          - ãƒãƒŠãƒ¼ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: $USER_CONCEPT
          - è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ: '$USER_TEXT_CONTENT'
          - ãƒãƒŠãƒ¼ã‚µã‚¤ã‚º: $BANNER_SIZE
          - ç”Ÿæˆã™ã‚‹ãƒãƒŠãƒ¼æ•°: $TOTAL_BANNERS

          **é‡è¦åˆ¶ç´„**:
          - ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã€Œ$USER_TEXT_CONTENTã€ã¯ä¸€å­—ä¸€å¥å¤‰æ›´ç¦æ­¢
          - ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã¯Flux Kontext Maxã§å¾Œã‹ã‚‰åˆæˆã™ã‚‹ãŸã‚ã€ãƒ™ãƒ¼ã‚¹ç”»åƒã«ã¯å«ã‚ãªã„
          - ãƒ™ãƒ¼ã‚¹ç”»åƒã«ã¯ãƒ†ã‚­ã‚¹ãƒˆé…ç½®ã‚¨ãƒªã‚¢ã‚’ç¢ºä¿ã™ã‚‹

          **ãƒãƒŠãƒ¼ã‚µã‚¤ã‚ºåˆ¥æˆ¦ç•¥**:
          - square_1_1 (1:1): SNSæŠ•ç¨¿å‘ã‘ã€ä¸­å¤®é…ç½®é‡è¦–
          - landscape_16_9 (16:9): Webåºƒå‘Šå‘ã‘ã€æ¨ªé•·ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
          - portrait_9_16 (9:16): ãƒ¢ãƒã‚¤ãƒ«åºƒå‘Šå‘ã‘ã€ç¸¦é•·ãƒ‡ã‚¶ã‚¤ãƒ³

          **å…¨ä½“æˆ¦ç•¥**:
          - ${TOTAL_BANNERS}ã¤ã®ãƒãƒŠãƒ¼ã§ä¸€ã¤ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’è¡¨ç¾
          - å„ãƒãƒŠãƒ¼ã¯ç‹¬ç«‹ã—ãŸé­…åŠ›ã‚’æŒã¤
          - ç•°ãªã‚‹è‰²èª¿ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»èƒŒæ™¯ã§å·®åˆ¥åŒ–
          - çµ±ä¸€æ„Ÿã®ã‚ã‚‹ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸

          **å„ãƒãƒŠãƒ¼ã®æ–¹å‘æ€§**:
          - ãƒãƒŠãƒ¼1: ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã€ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼é‡è¦–
          - ãƒãƒŠãƒ¼2: ç•°ãªã‚‹è‰²èª¿ã§ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
          - ãƒãƒŠãƒ¼3: ãƒŸãƒ‹ãƒãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ã§ã®è¡¨ç¾
          - ãƒãƒŠãƒ¼4: ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãªãƒ‡ã‚¶ã‚¤ãƒ³ã§ã®è¡¨ç¾
          - ãƒãƒŠãƒ¼5ä»¥é™: å‰µé€ çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã®ç‹¬è‡ªè¡¨ç¾

          **ã‚¿ã‚¹ã‚¯**:
          1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‚’åˆ†æã—ã€${TOTAL_BANNERS}ã¤ã®ãƒãƒŠãƒ¼ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ä¼ç”»
          2. å„ãƒãƒŠãƒ¼ç”¨ã®ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ç¢ºä¿ï¼‰
          3. å„ãƒãƒŠãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨æ–¹å‘æ€§ã‚’å®šç¾©
          4. ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥ã‚’ç­–å®š
          5. è¨ˆç”»æ›¸ã‚’ã€Œ$PLANNING_DIR/banner-plan.mdã€ã«ä¿å­˜
          6. å„ãƒãƒŠãƒ¼ç”¨ã®ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ï¼š
             - $PLANNING_DIR/base-image-prompt-1.txt
             - $PLANNING_DIR/base-image-prompt-2.txt
             - ï¼ˆä»¥ä¸‹ã€ãƒãƒŠãƒ¼æ•°åˆ†ï¼‰
          7. å„ãƒãƒŠãƒ¼ç”¨ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ä¿å­˜ï¼š
             - $PLANNING_DIR/banner-concept-1.txt
             - $PLANNING_DIR/banner-concept-2.txt
             - ï¼ˆä»¥ä¸‹ã€ãƒãƒŠãƒ¼æ•°åˆ†ï¼‰
          8. å„ãƒãƒŠãƒ¼ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥ã‚’ä¿å­˜ï¼š
             - $PLANNING_DIR/text-layout-strategy-1.txt
             - $PLANNING_DIR/text-layout-strategy-2.txt
             - ï¼ˆä»¥ä¸‹ã€ãƒãƒŠãƒ¼æ•°åˆ†ï¼‰

          **ãƒ™ãƒ¼ã‚¹ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
          - é«˜å“è³ªãªç”»åƒç”Ÿæˆã®ãŸã‚ã®è©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          - **å¿…é ˆ**: ãƒ†ã‚­ã‚¹ãƒˆé…ç½®ç”¨ã®æ˜ç¢ºãªç©ºç™½ã‚¨ãƒªã‚¢ã‚’ç¢ºä¿
          - ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã¯ä¸€åˆ‡å«ã‚ãªã„ï¼ˆé‡è¦ï¼‰
          - å„ãƒãƒŠãƒ¼ã®ç‰¹æ€§ã«æœ€é©åŒ–ã•ã‚ŒãŸèƒŒæ™¯ãƒ»è‰²èª¿
          - è¦–è¦šçš„è¦ç´ ï¼ˆè‰²å½©ã€æ§‹å›³ã€ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã‚’æ˜ç¢ºã«æŒ‡å®š
          - é«˜è§£åƒåº¦ãƒ»é«˜å“è³ªã‚’æ„è­˜ã—ãŸè¨˜è¿°
          - 50-100èªç¨‹åº¦ã®é©åˆ‡ãªé•·ã•
          - **é‡è¦**: ãƒ™ãƒ¼ã‚¹ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯è‹±èªã§ä½œæˆã—ã¦ãã ã•ã„
          - **æ–‡å­—å…¥ã‚Œã‚¨ãƒªã‚¢ç¢ºä¿ã®å¿…é ˆè¦ä»¶**:
            * ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¿…ãšã€Œwith clear empty space for text overlayã€ã‚’å«ã‚ã‚‹
            * ã€Œclean background areaã€ã€Œtext placement zoneã€ã€Œuncluttered center areaã€ãªã©ã®æ–‡è¨€ã‚’å«ã‚ã‚‹
            * ãƒ†ã‚­ã‚¹ãƒˆãŒèª­ã¿ã‚„ã™ã„å¹³å¦ã§å˜è‰²ã«è¿‘ã„èƒŒæ™¯ã‚¨ãƒªã‚¢ã‚’æŒ‡å®š
            * è¤‡é›‘ã™ãã‚‹è£…é£¾ã‚„ç´°ã‹ã„ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ã‚’é¿ã‘ã‚‹
            * ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãŒç¢ºä¿ã§ãã‚‹èƒŒæ™¯è‰²ã‚’æŒ‡å®š

          **ãƒãƒŠãƒ¼ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®è¦ä»¶**:
          - ç”Ÿæˆã•ã‚Œã‚‹ãƒ™ãƒ¼ã‚¹ç”»åƒã®ç‰¹å¾´ã¨æ–¹å‘æ€§
          - å„ãƒãƒŠãƒ¼å›ºæœ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
          - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã¸ã®è¨´æ±‚ãƒã‚¤ãƒ³ãƒˆ
          - ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã®æ•´åˆæ€§

          **ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥ã®è¦ä»¶**:
          - ãƒ†ã‚­ã‚¹ãƒˆã€Œ$USER_TEXT_CONTENTã€ã®æœ€é©é…ç½®ä½ç½®ï¼ˆå…·ä½“çš„ãªãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸æŒ‡å®šï¼‰
          - ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ãƒ»ã‚µã‚¤ã‚ºã®æ¨å¥¨å€¤ï¼ˆMedium-Boldæ¨å¥¨ï¼‰
          - æ–‡å­—è‰²ãƒ»èƒŒæ™¯è‰²ã®çµ„ã¿åˆã‚ã›ï¼ˆé«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¿…é ˆï¼‰
          - èª­ã¿ã‚„ã™ã•ã‚’æœ€å¤§åŒ–ã™ã‚‹èª¿æ•´æŒ‡ç¤º
          - ãƒ†ã‚­ã‚¹ãƒˆåˆæˆå‡¦ç†ã«é©ã—ãŸå½¢å¼
          - **é…ç½®ã®å…·ä½“ä¾‹**: ã€Œä¸­å¤®ã‚„ã‚„ä¸‹éƒ¨ï¼ˆå‚ç›´ä½ç½®65-75%ï¼‰ã€ã€Œå·¦ä¸Šéš…ï¼ˆ10-20%ï¼‰ã€ç­‰
          - **åŠ¹æœæŒ‡å®š**: ãƒ‰ãƒ­ãƒƒãƒ—ã‚·ãƒ£ãƒ‰ã‚¦ã€ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã€ã‚°ãƒ­ãƒ¼åŠ¹æœã®æœ‰ç„¡

          **é‡è¦**: 
          1. å¿…ãš${TOTAL_BANNERS}å€‹åˆ†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„
          2. txtãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿæ¢°å‡¦ç†ç”¨ï¼ˆ1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
          3. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯å…·ä½“çš„ã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„
          4. ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã€Œ$USER_TEXT_CONTENTã€ã¯å¤‰æ›´ç¦æ­¢
          5. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Šã—ã¦ãã ã•ã„
          
          **æ–‡å­—å…¥ã‚ŒæˆåŠŸã®ãŸã‚ã®é‡è¦æŒ‡ç¤º**:
          - ãƒ™ãƒ¼ã‚¹ç”»åƒã¯å¿…ãšãƒ†ã‚­ã‚¹ãƒˆé…ç½®ã‚¨ãƒªã‚¢ã‚’æƒ³å®šã—ã¦è¨­è¨ˆã™ã‚‹
          - èƒŒæ™¯ãŒè¤‡é›‘ã™ãã¦æ–‡å­—ãŒèª­ã‚ãªããªã‚‹ã“ã¨ã‚’é¿ã‘ã‚‹
          - ã€Œclear empty space for text overlayã€ã‚’å„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹
          - ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥ã§ã¯å…·ä½“çš„ãªä½ç½®ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ˜è¨˜ã™ã‚‹
          - å¾Œç¶šã®ãƒ†ã‚­ã‚¹ãƒˆåˆæˆå‡¦ç†ã‚’å‰æã¨ã—ãŸè¨­è¨ˆã«ã™ã‚‹"
          
          echo "ğŸš€ Starting Banner Planning Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸè¨ˆç”»ã®ç¢ºèª
          echo ""
          echo "ğŸ“‹ Checking generated banner planning files..."
          
          # å„ãƒãƒŠãƒ¼ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‡ºåŠ›ã‚’è¨­å®š
          for i in $(seq 1 $TOTAL_BANNERS); do
            # ãƒ™ãƒ¼ã‚¹ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
            if [ -f "$PLANNING_DIR/base-image-prompt-${i}.txt" ]; then
              BASE_IMAGE_PROMPT=$(cat "$PLANNING_DIR/base-image-prompt-${i}.txt" | tr '\n' ' ')
              echo "::notice::âœ… Base image prompt ${i} generated"
              echo "Base image prompt ${i}: $BASE_IMAGE_PROMPT"
              echo "base-image-prompt-${i}=$BASE_IMAGE_PROMPT" >> $GITHUB_OUTPUT
            else
              echo "::error::âŒ Base image prompt ${i} file not found"
              exit 1
            fi
            
            # ãƒãƒŠãƒ¼ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ç¢ºèª
            if [ -f "$PLANNING_DIR/banner-concept-${i}.txt" ]; then
              BANNER_CONCEPT=$(head -5 "$PLANNING_DIR/banner-concept-${i}.txt" | tr '\n' ' ')
              echo "::notice::âœ… Banner concept ${i} generated"
              echo "Banner concept ${i}: $BANNER_CONCEPT"
              echo "banner-concept-${i}=$BANNER_CONCEPT" >> $GITHUB_OUTPUT
            else
              echo "::error::âŒ Banner concept ${i} file not found"
              exit 1
            fi
            
            # ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥ã®ç¢ºèª
            if [ -f "$PLANNING_DIR/text-layout-strategy-${i}.txt" ]; then
              TEXT_LAYOUT_STRATEGY=$(head -3 "$PLANNING_DIR/text-layout-strategy-${i}.txt" | tr '\n' ' ')
              echo "::notice::âœ… Text layout strategy ${i} generated"
              echo "Text layout strategy ${i}: $TEXT_LAYOUT_STRATEGY"
              echo "text-layout-strategy-${i}=$TEXT_LAYOUT_STRATEGY" >> $GITHUB_OUTPUT
            else
              echo "::error::âŒ Text layout strategy ${i} file not found"
              exit 1
            fi
          done
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push planning
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No planning files to commit"
          else
            git commit -m "Add banner planning: ${{ inputs.concept }}

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi