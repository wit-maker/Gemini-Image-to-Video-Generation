name: module-article-creation-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'è¨˜äº‹ã®ãƒ†ãƒ¼ãƒãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      search-results:
        description: 'æ¤œç´¢çµæœãƒ‡ãƒ¼ã‚¿'
        required: true
        type: string
      found-sources:
        description: 'å®Ÿéš›ã«è¦‹ã¤ã‹ã£ãŸã‚½ãƒ¼ã‚¹URL'
        required: true
        type: string
      target-language:
        description: 'è¨˜äº‹ä½œæˆè¨€èª (japanese/english)'
        required: false
        type: string
        default: 'japanese'
      article-style:
        description: 'è¨˜äº‹ã‚¹ã‚¿ã‚¤ãƒ« (news/blog/summary/analysis)'
        required: false
        type: string
        default: 'news'
      article-length:
        description: 'è¨˜äº‹ã®é•·ã• (short/medium/long)'
        required: false
        type: string
        default: 'medium'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      article_index:
        description: 'è¨˜äº‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.article-creation.outputs.completed }}
      article-content:
        description: 'è¨˜äº‹æœ¬æ–‡'
        value: ${{ jobs.article-creation.outputs.article-content }}
      article-title:
        description: 'è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«'
        value: ${{ jobs.article-creation.outputs.article-title }}
      article-summary:
        description: 'è¨˜äº‹è¦ç´„'
        value: ${{ jobs.article-creation.outputs.article-summary }}
      audio-script:
        description: 'éŸ³å£°ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ'
        value: ${{ jobs.article-creation.outputs.audio-script }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  article-creation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      completed: ${{ steps.article-creation.outputs.completed }}
      article-content: ${{ steps.article-creation.outputs.article-content }}
      article-title: ${{ steps.article-creation.outputs.article-title }}
      article-summary: ${{ steps.article-creation.outputs.article-summary }}
      audio-script: ${{ steps.article-creation.outputs.audio-script }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: AIè¨˜äº‹ä½œæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: article-creation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ“ Article Creation Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_CONCEPT="${{ inputs.concept }}"
          SEARCH_RESULTS="${{ inputs.search-results }}"
          FOUND_SOURCES="${{ inputs.found-sources }}"
          TARGET_LANGUAGE="${{ inputs.target-language }}"
          ARTICLE_STYLE="${{ inputs.article-style }}"
          ARTICLE_LENGTH="${{ inputs.article-length }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          ARTICLE_INDEX="${{ inputs.article_index }}"
          ARTICLES_DIR="$FOLDER_NAME/articles-$ARTICLE_INDEX"
          
          echo "User concept: $USER_CONCEPT"
          echo "Target language: $TARGET_LANGUAGE"
          echo "Article style: $ARTICLE_STYLE"
          echo "Article length: $ARTICLE_LENGTH"
          echo "Articles folder: $ARTICLES_DIR"
          
          # è¨˜äº‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$ARTICLES_DIR" ]; then
            mkdir -p "$ARTICLES_DIR"
            echo "ğŸ“ Created articles folder: $ARTICLES_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯é«˜å“è³ªãªAIè¨˜äº‹ä½œæˆã®å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚æä¾›ã•ã‚ŒãŸæ¤œç´¢çµæœã‹ã‚‰æ­£ç¢ºã§èª­ã¿ã‚„ã™ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          è¨˜äº‹ãƒ†ãƒ¼ãƒ: $USER_CONCEPT
          æ¤œç´¢çµæœ: $SEARCH_RESULTS
          ã‚½ãƒ¼ã‚¹URL: $FOUND_SOURCES
          è¨€èª: $TARGET_LANGUAGE
          è¨˜äº‹ã‚¹ã‚¿ã‚¤ãƒ«: $ARTICLE_STYLE
          è¨˜äº‹é•·ã•: $ARTICLE_LENGTH

          é‡è¦åŸå‰‡:
          - æä¾›ã•ã‚ŒãŸæ¤œç´¢çµæœã®æƒ…å ±ã®ã¿ã‚’ä½¿ç”¨
          - ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã‚„æ¨æ¸¬ã¯ä¸€åˆ‡å«ã‚ãªã„
          - å®Ÿåœ¨ã™ã‚‹ä¼æ¥­ãƒ»è£½å“ãƒ»ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã¿è¨˜è¼‰

          ã‚¿ã‚¹ã‚¯:
          1. æ¤œç´¢çµæœã‚’åˆ†æã—ã€ä¿¡é ¼ã§ãã‚‹æƒ…å ±ã‚’ç‰¹å®š
          2. è¨˜äº‹æ§‹æˆã‚’è¨­è¨ˆï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€è¦ç´„ã€æœ¬æ–‡ã€å‚è€ƒæ–‡çŒ®ï¼‰
          3. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š
             - $ARTICLES_DIR/article.mdï¼ˆè¨˜äº‹æœ¬æ–‡ã€Markdownå½¢å¼ï¼‰
             - $ARTICLES_DIR/article-title.txtï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€1è¡Œï¼‰
             - $ARTICLES_DIR/article-summary.txtï¼ˆè¦ç´„ã€1è¡Œï¼‰
             - $ARTICLES_DIR/audio-script.txtï¼ˆéŸ³å£°ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€2-3åˆ†ç¨‹åº¦ï¼‰

          éŸ³å£°ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¦ä»¶:
          - è‡ªç„¶ãªè©±ã—è¨€è‘‰ã§æ§‹æˆ
          - å°‚é–€ç”¨èªã®èª­ã¿æ–¹ã‚’è€ƒæ…®
          - URLç­‰ã®éŸ³å£°ã«ä¸é©åˆ‡ãªéƒ¨åˆ†ã¯é™¤å¤–

          ç¦æ­¢äº‹é …:
          - ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ä¼æ¥­ã®å‰µä½œï¼ˆGlobal AI, TechStar Inc.ç­‰ï¼‰
          - å­˜åœ¨ã—ãªã„URL/è¨˜äº‹ã®å¼•ç”¨
          - æ¨æ¸¬ã«ã‚ˆã‚‹æƒ…å ±ã®è¿½åŠ 

          ã¾ãšæ¤œç´¢çµæœã‚’ç¢ºèªã—ã€å®Ÿåœ¨ã™ã‚‹æƒ…å ±ã®ã¿ã§è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸš€ Starting Article Creation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Bash" \
            --max-turns 30 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã®ç¢ºèªã¨å‡ºåŠ›è¨­å®š
          echo ""
          echo "ğŸ“ Checking generated article files..."
          
          # è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª
          if [ -f "$ARTICLES_DIR/article-title.txt" ]; then
            ARTICLE_TITLE=$(cat "$ARTICLES_DIR/article-title.txt")
            echo "âœ… Article title: $ARTICLE_TITLE"
            echo "article-title=$ARTICLE_TITLE" >> $GITHUB_OUTPUT
          else
            echo "âŒ Article title file not found"
            echo "article-title=è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_OUTPUT
          fi
          
          # è¨˜äº‹è¦ç´„ç¢ºèª
          if [ -f "$ARTICLES_DIR/article-summary.txt" ]; then
            ARTICLE_SUMMARY=$(cat "$ARTICLES_DIR/article-summary.txt")
            echo "âœ… Article summary: $ARTICLE_SUMMARY"
            echo "article-summary=$ARTICLE_SUMMARY" >> $GITHUB_OUTPUT
          else
            echo "âŒ Article summary file not found"
            echo "article-summary=è¨˜äº‹è¦ç´„ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_OUTPUT
          fi
          
          # éŸ³å£°ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèª
          if [ -f "$ARTICLES_DIR/audio-script.txt" ]; then
            AUDIO_SCRIPT=$(cat "$ARTICLES_DIR/audio-script.txt")
            SCRIPT_LENGTH=${#AUDIO_SCRIPT}
            echo "âœ… Audio script created: $SCRIPT_LENGTH characters"
            
            # GitHub Actionså‡ºåŠ›å¤‰æ•°ç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆã‚µã‚¤ã‚ºåˆ¶é™è€ƒæ…®ï¼‰
            if [ $SCRIPT_LENGTH -gt 3000 ]; then
              TRUNCATED_SCRIPT=$(echo "$AUDIO_SCRIPT" | head -c 3000)
              echo "audio-script=${TRUNCATED_SCRIPT}..." >> $GITHUB_OUTPUT
            else
              AUDIO_SCRIPT_ESCAPED=$(echo "$AUDIO_SCRIPT" | sed ':a;N;$!ba;s/\n/\\n/g')
              echo "audio-script=$AUDIO_SCRIPT_ESCAPED" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Audio script file not found"
            echo "audio-script=éŸ³å£°ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_OUTPUT
          fi
          
          # è¨˜äº‹æœ¬æ–‡ç¢ºèª
          if [ -f "$ARTICLES_DIR/article.md" ]; then
            ARTICLE_CONTENT=$(cat "$ARTICLES_DIR/article.md")
            CONTENT_LENGTH=${#ARTICLE_CONTENT}
            echo "âœ… Article content created: $CONTENT_LENGTH characters"
            
            # GitHub Actionså‡ºåŠ›å¤‰æ•°ç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆã‚µã‚¤ã‚ºåˆ¶é™è€ƒæ…®ï¼‰
            if [ $CONTENT_LENGTH -gt 4000 ]; then
              TRUNCATED_CONTENT=$(echo "$ARTICLE_CONTENT" | head -c 4000)
              echo "article-content=${TRUNCATED_CONTENT}..." >> $GITHUB_OUTPUT
            else
              ARTICLE_CONTENT_ESCAPED=$(echo "$ARTICLE_CONTENT" | sed ':a;N;$!ba;s/\n/\\n/g')
              echo "article-content=$ARTICLE_CONTENT_ESCAPED" >> $GITHUB_OUTPUT
            fi
            
            # å“è³ªãƒã‚§ãƒƒã‚¯
            echo "ğŸ” Article Quality Check:"
            if echo "$ARTICLE_CONTENT" | grep -q "Global AI\|TechStar Inc\|AI Solutions Corp"; then
              echo "âš ï¸ Warning: Potential fictional companies detected"
            else
              echo "âœ… No obvious fictional companies detected"
            fi
          else
            echo "âŒ Article content file not found"
            echo "article-content=è¨˜äº‹æœ¬æ–‡ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_OUTPUT
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          
      - name: Commit article files
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No article files to commit"
          else
            git commit -m "Add AI news article created by Claude Code SDK: ${{ inputs.concept }}

            Language: ${{ inputs.target-language }}
            Style: ${{ inputs.article-style }}
            Length: ${{ inputs.article-length }}
            Based on: Real web search results

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi