name: module-create-pr

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
    secrets:
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          BRANCH_NAME="${{ inputs.branch-name }}"
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æœ€çµ‚æˆæœç‰©ã®ç¢ºèªã¨ã‚³ãƒŸãƒƒãƒˆ
          FOLDER_NAME="${{ inputs.folder-name }}"
          echo "=== Final Generation Summary ==="
          echo "Project folder: $FOLDER_NAME"
          
          IMAGES_COUNT=0
          VIDEOS_COUNT=0
          BANNERS_COUNT=0
          
          if [ -d "$FOLDER_NAME" ]; then
            echo "âœ… Project folder exists: $FOLDER_NAME"
            
            # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªï¼ˆå‹•çš„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¯¾å¿œï¼‰
            IMAGES_COUNT=$(find "$FOLDER_NAME" -name "images-*" -type d -exec find {} -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \; 2>/dev/null | wc -l)
            if [ "$IMAGES_COUNT" -gt 0 ]; then
              echo "âœ… Images directories exist with $IMAGES_COUNT files"
            fi
            
            # ãƒãƒŠãƒ¼ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªï¼ˆå‹•çš„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¯¾å¿œï¼‰
            BANNERS_COUNT=$(find "$FOLDER_NAME" -name "banners-*" -type d -exec find {} -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \; 2>/dev/null | wc -l)
            if [ "$BANNERS_COUNT" -gt 0 ]; then
              echo "âœ… Banner directories exist with $BANNERS_COUNT files"
            fi
            
            # å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªï¼ˆå‹•çš„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¯¾å¿œï¼‰
            VIDEOS_COUNT=$(find "$FOLDER_NAME" -name "videos-*" -type d -exec find {} -name "*.mp4" -o -name "*.mov" -o -name "*.avi" \; 2>/dev/null | wc -l)
            if [ "$VIDEOS_COUNT" -gt 0 ]; then
              echo "âœ… Videos directories exist with $VIDEOS_COUNT files"
            fi
          fi
          
          # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add "$FOLDER_NAME/" 2>/dev/null || true
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
          COMMIT_MESSAGE="Add new AI-generated content: ${{ inputs.concept }}
          
          ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ${{ inputs.concept }}
          ç”Ÿæˆæ—¥æ™‚: $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC
          
          ğŸ“Š Generation Summary:
          - Images: $IMAGES_COUNT files (Imagen4 Ultra)
          - Banners: $BANNERS_COUNT files (Flux Kontext Max)
          - Videos: $VIDEOS_COUNT files (Vidu Q1)
          
          ğŸ¤– Generated with Claude Code SDK & kamuicode MCP
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          # ã‚³ãƒŸãƒƒãƒˆ
          if git diff --cached --quiet; then
            echo "Warning: No changes to commit"
            git commit --allow-empty -m "$COMMIT_MESSAGE"
          else
            git commit -m "$COMMIT_MESSAGE"
          fi
          
          # ãƒªãƒ™ãƒ¼ã‚¹ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ï¼‰
          git pull --rebase origin $BRANCH_NAME || true
          git push origin $BRANCH_NAME
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹å–å¾—
          GENERATED_IMAGE_PATH=""
          GENERATED_VIDEO_PATH=""
          
          if [ "$IMAGES_COUNT" -gt 0 ]; then
            GENERATED_IMAGE_PATH=$(find "$FOLDER_NAME" -name "images-*" -type d -exec find {} -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \; 2>/dev/null | head -1)
          fi
          
          if [ "$VIDEOS_COUNT" -gt 0 ]; then
            GENERATED_VIDEO_PATH=$(find "$FOLDER_NAME" -name "videos-*" -type d -exec find {} -name "*.mp4" -o -name "*.mov" -o -name "*.avi" \; 2>/dev/null | head -1)
          fi
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ãƒœãƒ‡ã‚£ã‚’ä½œæˆ
          PR_BODY="ğŸ¤– Claude Code SDK & kamuicode MCPã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã§ã™.

          ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ${{ inputs.concept }}

          æˆæœç‰©:
          
          ç”»åƒ: $IMAGES_COUNT ãƒ•ã‚¡ã‚¤ãƒ«
          ãƒãƒŠãƒ¼: $BANNERS_COUNT ãƒ•ã‚¡ã‚¤ãƒ«
          å‹•ç”»: $VIDEOS_COUNT ãƒ•ã‚¡ã‚¤ãƒ«"
          
          # å…¨ã¦ã®ç”»åƒã‚’ãƒ—ãƒ«ãƒªã‚¯ã«åŸ‹ã‚è¾¼ã¿
          if [ "$IMAGES_COUNT" -gt 0 ]; then
            PR_BODY="$PR_BODY"$'\n\n'"## ğŸ¨ ç”Ÿæˆã•ã‚ŒãŸç”»åƒ"
            IMAGE_INDEX=1
            find "$FOLDER_NAME" -name "images-*" -type d | sort | while read -r IMAGE_DIR; do
              IMAGE_FILE=$(find "$IMAGE_DIR" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" 2>/dev/null | head -1)
              if [ -n "$IMAGE_FILE" ] && [ -f "$IMAGE_FILE" ]; then
                GITHUB_IMAGE_URL="https://github.com/${{ github.repository }}/raw/$BRANCH_NAME/$IMAGE_FILE"
                if [ "$IMAGES_COUNT" -gt 1 ]; then
                  echo "### ç”»åƒ $IMAGE_INDEX" >> /tmp/pr_images.txt
                fi
                echo "![Generated Image $IMAGE_INDEX]($GITHUB_IMAGE_URL)" >> /tmp/pr_images.txt
                echo "" >> /tmp/pr_images.txt
                IMAGE_INDEX=$((IMAGE_INDEX + 1))
              fi
            done
            if [ -f /tmp/pr_images.txt ]; then
              PR_BODY="$PR_BODY"$'\n'"$(cat /tmp/pr_images.txt)"
            fi
          fi
          
          # å…¨ã¦ã®ãƒãƒŠãƒ¼ç”»åƒã‚’ãƒ—ãƒ«ãƒªã‚¯ã«åŸ‹ã‚è¾¼ã¿
          if [ "$BANNERS_COUNT" -gt 0 ]; then
            PR_BODY="$PR_BODY"$'\n\n'"## ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸãƒãƒŠãƒ¼"
            BANNER_INDEX=1
            find "$FOLDER_NAME" -name "banners-*" -type d | sort | while read -r BANNER_DIR; do
              BANNER_FILE=$(find "$BANNER_DIR" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" 2>/dev/null | head -1)
              if [ -n "$BANNER_FILE" ] && [ -f "$BANNER_FILE" ]; then
                GITHUB_BANNER_URL="https://github.com/${{ github.repository }}/raw/$BRANCH_NAME/$BANNER_FILE"
                if [ "$BANNERS_COUNT" -gt 1 ]; then
                  echo "### ãƒãƒŠãƒ¼ $BANNER_INDEX" >> /tmp/pr_banners.txt
                fi
                echo "![Generated Banner $BANNER_INDEX]($GITHUB_BANNER_URL)" >> /tmp/pr_banners.txt
                echo "" >> /tmp/pr_banners.txt
                echo "ğŸ“ **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: \`$BANNER_FILE\`" >> /tmp/pr_banners.txt
                echo "" >> /tmp/pr_banners.txt
                BANNER_INDEX=$((BANNER_INDEX + 1))
              fi
            done
            if [ -f /tmp/pr_banners.txt ]; then
              PR_BODY="$PR_BODY"$'\n'"$(cat /tmp/pr_banners.txt)"
            fi
          fi
          
          # å…¨ã¦ã®å‹•ç”»ã‚’ãƒ—ãƒ«ãƒªã‚¯ã«åŸ‹ã‚è¾¼ã¿
          if [ "$VIDEOS_COUNT" -gt 0 ]; then
            PR_BODY="$PR_BODY"$'\n\n'"## ğŸ¬ ç”Ÿæˆã•ã‚ŒãŸå‹•ç”»"
            VIDEO_INDEX=1
            find "$FOLDER_NAME" -name "videos-*" -type d | sort | while read -r VIDEO_DIR; do
              VIDEO_FILE=$(find "$VIDEO_DIR" -name "*.mp4" -o -name "*.mov" -o -name "*.avi" 2>/dev/null | head -1)
              if [ -n "$VIDEO_FILE" ] && [ -f "$VIDEO_FILE" ]; then
                GITHUB_VIDEO_URL="https://github.com/${{ github.repository }}/raw/$BRANCH_NAME/$VIDEO_FILE"
                if [ "$VIDEOS_COUNT" -gt 1 ]; then
                  echo "### å‹•ç”» $VIDEO_INDEX" >> /tmp/pr_videos.txt
                fi
                echo "<video width=\"640\" height=\"480\" controls>" >> /tmp/pr_videos.txt
                echo "  <source src=\"$GITHUB_VIDEO_URL\" type=\"video/mp4\">" >> /tmp/pr_videos.txt
                echo "  ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚" >> /tmp/pr_videos.txt
                echo "  <a href=\"$GITHUB_VIDEO_URL\">å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å†ç”Ÿ</a>" >> /tmp/pr_videos.txt
                echo "</video>" >> /tmp/pr_videos.txt
                echo "" >> /tmp/pr_videos.txt
                echo "ğŸ“ **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: \`$VIDEO_FILE\`" >> /tmp/pr_videos.txt
                echo "" >> /tmp/pr_videos.txt
                VIDEO_INDEX=$((VIDEO_INDEX + 1))
              fi
            done
            if [ -f /tmp/pr_videos.txt ]; then
              PR_BODY="$PR_BODY"$'\n'"$(cat /tmp/pr_videos.txt)"
            fi
          fi
          
          PR_BODY="$PR_BODY

          ---
          ğŸ¤– Generated with [Claude Code SDK & kamuicode MCP](https://github.com/AI-Summoner/ai-summoner)"
          
          # PRä½œæˆ
          gh pr create \
            --title "æ–°ã—ã„AIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„: ${{ inputs.concept }}" \
            --body "$PR_BODY" \
            --base main \
            --head $BRANCH_NAME