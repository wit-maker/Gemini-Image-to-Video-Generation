name: module-video-generation-kc-i2v-fal-hailuo-02-pro-gca

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      video-prompt:
        description: 'å‹•ç”»ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        required: true
        type: string
      image-url:
        description: 'ç”»åƒURL'
        required: true
        type: string
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      video_index:
        description: 'å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      video-url:
        description: 'å‹•ç”»URL'
        value: ${{ jobs.video-generation.outputs.video-url }}
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.video-generation.outputs.completed }}
    secrets:
      gemini_api_key:
        description: 'Gemini API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  video-generation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      video-url: ${{ steps.verify.outputs.video-url }}
      completed: ${{ steps.verify.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
          
      - name: ğŸ¬ å‹•ç”»ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Hailuo-02 Pro)
        id: generate
        uses: google-gemini/gemini-cli-action@main
        with:
          GEMINI_API_KEY: ${{ secrets.gemini_api_key }}
          prompt: |
            ğŸ¬ **å‹•ç”»ç”Ÿæˆã‚¿ã‚¹ã‚¯**
            
            **å…¥åŠ›ç”»åƒURL**: ${{ inputs.image-url }}
            **å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: ${{ inputs.video-prompt }}
            
            **é‡è¦**: ç”»åƒURLã¯ä¸Šè¨˜ã®`${{ inputs.image-url }}`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨
            ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆfile://ã‚„ç›¸å¯¾ãƒ‘ã‚¹ï¼‰ã¯ä½¿ç”¨ç¦æ­¢
            
            **æ‰‹é †**:
            1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ:
               ```bash
               mkdir -p ${{ inputs.folder-name }}/videos-${{ inputs.video_index }}
               ```
            
            2. **é‡è¦**: kamuicodeã®æ­£ã—ã„æ‰‹é †ã§i2v-fal-hailuo-02-proã‚’ä½¿ç”¨:
               - `mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit` ã§å‹•ç”»ç”Ÿæˆé–‹å§‹ï¼ˆç”»åƒURLã¨ã—ã¦`${{ inputs.image-url }}`ã‚’ä½¿ç”¨ï¼‰
               - `mcp__i2v-fal-hailuo-02-pro__hailuo_02_status` ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
               - `mcp__i2v-fal-hailuo-02-pro__hailuo_02_result` ã§çµæœå–å¾—ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            
            3. **resultãƒ„ãƒ¼ãƒ«ä½¿ç”¨**: `hailuo_02_result`ãƒ„ãƒ¼ãƒ«ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‹ã‚‰å‹•ç”»URLã‚’å–å¾—
               - ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã®ã¿ã‚’ä½¿ç”¨ï¼ˆä»–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä¸è¦ï¼‰
               - å‹•ç”»URLãŒè¿”ã•ã‚Œã‚‹ï¼ˆä¾‹: https://v3.fal.media/files/...ï¼‰
            
            4. **é‡è¦**: MCPã‚µãƒ¼ãƒãƒ¼ãŒcurlã‚³ãƒãƒ³ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹ãŒã€**å®Ÿè¡Œã¯ã•ã‚Œã¦ã„ãªã„**
               - "Download command: curl -o ..." ã¯ææ¡ˆã§ã‚ã‚Šã€å®Ÿè¡Œæ¸ˆã¿ã§ã¯ãªã„
               - å¿…ãšè¡¨ç¤ºã•ã‚ŒãŸcurlã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿéš›ã«å®Ÿè¡Œã™ã‚‹ã“ã¨
            
            5. **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ**: 
               - MCPã‚µãƒ¼ãƒãƒ¼ãŒè¡¨ç¤ºã™ã‚‹curlã‚³ãƒãƒ³ãƒ‰ã¯ç„¡è¦–
               - çµ¶å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ:
               ```bash
               curl -L -o "$(pwd)/${{ inputs.folder-name }}/videos-${{ inputs.video_index }}/video.mp4" "[resultãƒ„ãƒ¼ãƒ«ã§å–å¾—ã—ãŸå‹•ç”»URL]"
               ls -la "$(pwd)/${{ inputs.folder-name }}/videos-${{ inputs.video_index }}/video.mp4"
               ```
            
            6. **å‹•ç”»URLä¿å­˜ï¼ˆå¿…é ˆï¼‰**:
               - **é‡è¦**: å–å¾—ã—ãŸå‹•ç”»URLã‚’å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹ã“ã¨:
               ```bash
               echo "[resultãƒ„ãƒ¼ãƒ«ã§å–å¾—ã—ãŸå‹•ç”»URL]" > "${{ inputs.folder-name }}/videos-${{ inputs.video_index }}/video-url.txt"
               cat "${{ inputs.folder-name }}/videos-${{ inputs.video_index }}/video-url.txt"
               ```
            
            7. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ã®ç¢ºèªã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºè¡¨ç¤º
            
            **é‡è¦**: 
            - MCPã‚µãƒ¼ãƒãƒ¼ã¯curlã‚³ãƒãƒ³ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹ã ã‘ï¼ˆå®Ÿè¡Œã—ãªã„ï¼‰
            - "âš ï¸ Important: Execute the above curl command" ã®è­¦å‘Šã«å¾“ã†ã“ã¨
            - å¿…ãšå®Ÿéš›ã«curlã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            
      - name: Verify video generation
        id: verify
        run: |
          FOLDER_NAME="${{ inputs.folder-name }}"
          VIDEO_INDEX="${{ inputs.video_index }}"
          VIDEOS_DIR="$FOLDER_NAME/videos-${VIDEO_INDEX}"
          VIDEO_PATH="$VIDEOS_DIR/video.mp4"
          VIDEO_URL_FILE="$VIDEOS_DIR/video-url.txt"
          
          echo "ğŸ” Checking video generation results..."
          echo "Expected video path: $VIDEO_PATH"
          echo "Expected URL file: $VIDEO_URL_FILE"
          echo "Input image URL was: ${{ inputs.image-url }}"
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ç¢ºèª
          echo "Directory structure:"
          ls -la "$FOLDER_NAME/" || echo "Folder not found: $FOLDER_NAME"
          ls -la "$VIDEOS_DIR/" || echo "Videos folder not found: $VIDEOS_DIR"
          
          if [ -f "$VIDEO_PATH" ]; then
            VIDEO_SIZE=$(stat -c%s "$VIDEO_PATH" 2>/dev/null || stat -f%z "$VIDEO_PATH" 2>/dev/null || echo "unknown")
            echo "âœ… Video generated successfully: $VIDEO_PATH ($VIDEO_SIZE bytes)"
            
            # å‹•ç”»URLã®ç¢ºèªã¨å‡ºåŠ›è¨­å®š
            if [ -f "$VIDEO_URL_FILE" ]; then
              VIDEO_URL=$(cat "$VIDEO_URL_FILE")
              echo "âœ… Video URL found: $VIDEO_URL"
              echo "video-url=$VIDEO_URL" >> $GITHUB_OUTPUT
            else
              echo "âŒ Video URL file not found: $VIDEO_URL_FILE"
              exit 1
            fi
          else
            echo "âŒ Video not found at expected path: $VIDEO_PATH"
            echo "Available files in videos directory:"
            find "$FOLDER_NAME" -type f -name "*.mp4" -o -name "*.webm" -o -name "*.mov" || echo "No video files found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          
      - name: Commit generated video
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No video files to commit"
          else
            git commit -m "ğŸ¬ Add generated Hailuo-02 video: ${{ inputs.concept }}
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi