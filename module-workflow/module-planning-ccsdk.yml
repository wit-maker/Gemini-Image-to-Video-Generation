name: module-planning-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      total_videos:
        description: 'ç”Ÿæˆã™ã‚‹å‹•ç”»ã®æ•°'
        required: false
        type: string
        default: '1'
      image-model-type:
        description: 'ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ï¼ˆæŒ‡å®šæ™‚ã¯ãã®ãƒ¢ãƒ‡ãƒ«ã«æœ€é©åŒ–ã€æœªæŒ‡å®šæ™‚ã¯æ±ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰'
        required: false
        type: string
      video-model-type:
        description: 'å‹•ç”»ç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ï¼ˆæŒ‡å®šæ™‚ã¯ãã®ãƒ¢ãƒ‡ãƒ«ã«æœ€é©åŒ–ã€æœªæŒ‡å®šæ™‚ã¯æ±ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰'
        required: false
        type: string
    outputs:
      planning-completed:
        description: 'ä¼ç”»å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.planning.outputs.planning-completed }}
      # å‹•çš„å‡ºåŠ›ï¼ˆæœ€å¤§8å‹•ç”»ã¾ã§å¯¾å¿œï¼‰
      image-prompt-1:
        description: 'å‹•ç”»1ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-1 }}
      image-prompt-2:
        description: 'å‹•ç”»2ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-2 }}
      image-prompt-3:
        description: 'å‹•ç”»3ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-3 }}
      image-prompt-4:
        description: 'å‹•ç”»4ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-4 }}
      image-prompt-5:
        description: 'å‹•ç”»5ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-5 }}
      image-prompt-6:
        description: 'å‹•ç”»6ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-6 }}
      image-prompt-7:
        description: 'å‹•ç”»7ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-7 }}
      image-prompt-8:
        description: 'å‹•ç”»8ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-8 }}
      video-concept-1:
        description: 'å‹•ç”»1ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-1 }}
      video-concept-2:
        description: 'å‹•ç”»2ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-2 }}
      video-concept-3:
        description: 'å‹•ç”»3ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-3 }}
      video-concept-4:
        description: 'å‹•ç”»4ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-4 }}
      video-concept-5:
        description: 'å‹•ç”»5ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-5 }}
      video-concept-6:
        description: 'å‹•ç”»6ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-6 }}
      video-concept-7:
        description: 'å‹•ç”»7ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-7 }}
      video-concept-8:
        description: 'å‹•ç”»8ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-8 }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  planning:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      # å‹•çš„å‡ºåŠ›ï¼ˆæœ€å¤§8å‹•ç”»ã¾ã§å¯¾å¿œï¼‰
      image-prompt-1: ${{ steps.planning.outputs.image-prompt-1 }}
      image-prompt-2: ${{ steps.planning.outputs.image-prompt-2 }}
      image-prompt-3: ${{ steps.planning.outputs.image-prompt-3 }}
      image-prompt-4: ${{ steps.planning.outputs.image-prompt-4 }}
      image-prompt-5: ${{ steps.planning.outputs.image-prompt-5 }}
      image-prompt-6: ${{ steps.planning.outputs.image-prompt-6 }}
      image-prompt-7: ${{ steps.planning.outputs.image-prompt-7 }}
      image-prompt-8: ${{ steps.planning.outputs.image-prompt-8 }}
      video-concept-1: ${{ steps.planning.outputs.video-concept-1 }}
      video-concept-2: ${{ steps.planning.outputs.video-concept-2 }}
      video-concept-3: ${{ steps.planning.outputs.video-concept-3 }}
      video-concept-4: ${{ steps.planning.outputs.video-concept-4 }}
      video-concept-5: ${{ steps.planning.outputs.video-concept-5 }}
      video-concept-6: ${{ steps.planning.outputs.video-concept-6 }}
      video-concept-7: ${{ steps.planning.outputs.video-concept-7 }}
      video-concept-8: ${{ steps.planning.outputs.video-concept-8 }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: å‹•ç”»åˆ¶ä½œè¨ˆç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ“‹ Video Planning Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_CONCEPT="${{ inputs.concept }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          TOTAL_VIDEOS="${{ inputs.total_videos }}"
          IMAGE_MODEL_TYPE="${{ inputs.image-model-type }}"
          VIDEO_MODEL_TYPE="${{ inputs.video-model-type }}"
          
          echo "User concept: $USER_CONCEPT"
          echo "Planning folder: $PLANNING_DIR"
          echo "Total videos: $TOTAL_VIDEOS"
          echo "Image model type: $IMAGE_MODEL_TYPE"
          echo "Video model type: $VIDEO_MODEL_TYPE"
          
          # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$PLANNING_DIR" ]; then
            mkdir -p "$PLANNING_DIR"
            echo "ğŸ“ Created planning folder: $PLANNING_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯å‹•ç”»åˆ¶ä½œã®å°‚é–€ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‹ã‚‰${TOTAL_VIDEOS}ã¤ã®å‹•ç”»ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®è©³ç´°ãªè¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

          **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤º**: $USER_CONCEPT
          **ç”Ÿæˆã™ã‚‹å‹•ç”»æ•°**: $TOTAL_VIDEOS

          **å…¨ä½“æˆ¦ç•¥**:
          - ${TOTAL_VIDEOS}ã¤ã®å‹•ç”»ã§ä¸€ã¤ã®ãƒ†ãƒ¼ãƒã‚’è¡¨ç¾
          - å„å‹•ç”»ã¯ç‹¬ç«‹ã—ãŸé­…åŠ›ã‚’æŒã¤
          - ç•°ãªã‚‹è¦–ç‚¹ãƒ»ã‚¢ãƒ³ã‚°ãƒ«ãƒ»è¡¨ç¾ã§å·®åˆ¥åŒ–
          - çµ±ä¸€æ„Ÿã®ã‚ã‚‹ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

          **å„å‹•ç”»ã®æ–¹å‘æ€§**:
          - å‹•ç”»1: ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ³ã‚°ãƒ«ã€æ­£é¢ã‹ã‚‰ã®åŸºæœ¬å‹•ä½œãƒ»è¡¨ç¾
          - å‹•ç”»2: ã‚µã‚¤ãƒ‰ã‚¢ãƒ³ã‚°ãƒ«ã€æ¨ªã‹ã‚‰ã®å‹•çš„è¡¨ç¾
          - å‹•ç”»3: ä¸Šã‹ã‚‰ã®ä¿¯ç°ã€å…¨ä½“ã®å‹•ãã‚’å¼·èª¿
          - å‹•ç”»4: ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ã€ç´°éƒ¨ã®é­…åŠ›ã‚’è¡¨ç¾
          - å‹•ç”»5ä»¥é™: å‰µé€ çš„ãªè¦–ç‚¹ã§ã®ç‹¬è‡ªè¡¨ç¾

          **ã‚¿ã‚¹ã‚¯**:
          1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã‚’åˆ†æã—ã€${TOTAL_VIDEOS}ã¤ã®å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ä¼ç”»
          2. å„å‹•ç”»ç”¨ã®é«˜å“è³ªãªç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          3. å„å‹•ç”»ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨æ–¹å‘æ€§ã‚’å®šç¾©
          4. è¨ˆç”»æ›¸ã‚’ã€Œ$PLANNING_DIR/video-plan.mdã€ã«ä¿å­˜
          5. å„å‹•ç”»ç”¨ã®ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ï¼š
             - $PLANNING_DIR/image-prompt-1.txt
             - $PLANNING_DIR/image-prompt-2.txt
             - $PLANNING_DIR/image-prompt-3.txt
             - $PLANNING_DIR/image-prompt-4.txt
             - ï¼ˆä»¥ä¸‹ã€å‹•ç”»æ•°åˆ†ï¼‰
          6. å„å‹•ç”»ç”¨ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ä¿å­˜ï¼š
             - $PLANNING_DIR/video-concept-1.txt
             - $PLANNING_DIR/video-concept-2.txt
             - $PLANNING_DIR/video-concept-3.txt
             - $PLANNING_DIR/video-concept-4.txt
             - ï¼ˆä»¥ä¸‹ã€å‹•ç”»æ•°åˆ†ï¼‰

          **ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
          - æ±ç”¨çš„ã§é«˜å“è³ªãªç”»åƒç”Ÿæˆã«é©ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          - å„å‹•ç”»ã®ç‰¹æ€§ã«æœ€é©åŒ–ã•ã‚ŒãŸå†…å®¹
          - è¦–è¦šçš„è¦ç´ ï¼ˆè‰²å½©ã€æ§‹å›³ã€ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã‚’æ˜ç¢ºã«æŒ‡å®š
          - é«˜è§£åƒåº¦ãƒ»é«˜å“è³ªã‚’æ„è­˜ã—ãŸè¨˜è¿°
          - 50-100èªç¨‹åº¦ã®é©åˆ‡ãªé•·ã•
          - **é‡è¦**: ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯è‹±èªã§ä½œæˆã—ã¦ãã ã•ã„

          **å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®è¦ä»¶**:
          - ç”Ÿæˆã•ã‚Œã‚‹ç”»åƒã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸå‹•ç”»ã®æ–¹å‘æ€§
          - å„å‹•ç”»å›ºæœ‰ã®å‹•ãã‚„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡
          - é›°å›²æ°—ã‚„æ„Ÿæƒ…è¡¨ç¾
          - æ±ç”¨çš„ãªå‹•ç”»ç”Ÿæˆã«é©ã—ãŸå†…å®¹

          **ãƒ¢ãƒ‡ãƒ«æœ€é©åŒ–**: 
          - ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«æŒ‡å®š: ${IMAGE_MODEL_TYPE:-ãªã—}
          - å‹•ç”»ç”Ÿæˆãƒ¢ãƒ‡ãƒ«æŒ‡å®š: ${VIDEO_MODEL_TYPE:-ãªã—}
          - æŒ‡å®šã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã€ãã®ãƒ¢ãƒ‡ãƒ«ã®ç‰¹æ€§ã«åˆã‚ã›ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æœ€é©åŒ–ã—ã¦ãã ã•ã„
          - ãƒ¢ãƒ‡ãƒ«æœªæŒ‡å®šã®å ´åˆã¯ã€æ±ç”¨çš„ã§é«˜å“è³ªãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„
          - kamuicode-usage.mdã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ç‰¹æ€§ã‚’å‚ç…§ã—ã¦æœ€é©åŒ–ã‚’è¡Œã£ã¦ãã ã•ã„

          **é‡è¦**: 
          1. å¿…ãš${TOTAL_VIDEOS}å€‹åˆ†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„
          2. txtãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿæ¢°å‡¦ç†ç”¨ï¼ˆ1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
          3. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯å…·ä½“çš„ã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„
          4. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Šã—ã¦ãã ã•ã„
          5. ãƒ¢ãƒ‡ãƒ«æŒ‡å®šãŒã‚ã‚‹å ´åˆã¯ã€ã¾ãš .github/workflows/kamuicode/kamuicode-usage.mdã‚’èª­ã¿è¾¼ã‚“ã§ç‰¹æ€§ã‚’ç†è§£ã—ã¦ãã ã•ã„"
          
          echo "ğŸš€ Starting Planning Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸè¨ˆç”»ã®ç¢ºèª
          echo ""
          echo "ğŸ“‹ Checking generated planning files..."
          
          # å„å‹•ç”»ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‡ºåŠ›ã‚’è¨­å®š
          for i in $(seq 1 $TOTAL_VIDEOS); do
            # ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
            if [ -f "$PLANNING_DIR/image-prompt-${i}.txt" ]; then
              IMAGE_PROMPT=$(cat "$PLANNING_DIR/image-prompt-${i}.txt" | tr '\n' ' ')
              echo "::notice::âœ… Image prompt ${i} generated"
              echo "Image prompt ${i}: $IMAGE_PROMPT"
              echo "image-prompt-${i}=$IMAGE_PROMPT" >> $GITHUB_OUTPUT
            else
              echo "::error::âŒ Image prompt ${i} file not found"
              exit 1
            fi
            
            # å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ç¢ºèª
            if [ -f "$PLANNING_DIR/video-concept-${i}.txt" ]; then
              VIDEO_CONCEPT=$(head -5 "$PLANNING_DIR/video-concept-${i}.txt" | tr '\n' ' ')
              echo "::notice::âœ… Video concept ${i} generated"
              echo "Video concept ${i}: $VIDEO_CONCEPT"
              echo "video-concept-${i}=$VIDEO_CONCEPT" >> $GITHUB_OUTPUT
            else
              echo "::error::âŒ Video concept ${i} file not found"
              exit 1
            fi
          done
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push planning
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No planning files to commit"
          else
            git commit -m "Add video planning: ${{ inputs.concept }}"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi