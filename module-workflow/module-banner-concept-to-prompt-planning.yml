name: module-banner-concept-to-prompt-planning

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒãƒŠãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼ˆå¾“æ¥æ–¹å¼ï¼‰'
        required: false
        type: string
      concept_file:
        description: 'ã‚³ãƒ³ã‚»ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ–°æ–¹å¼ã€æ‹¡å¼µå­ãªã—ï¼‰'
        required: false
        type: string
      text_content:
        description: 'ç”»åƒã«è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ'
        required: true
        type: string
      banner_size:
        description: 'ãƒãƒŠãƒ¼ã‚µã‚¤ã‚º'
        required: false
        type: string
        default: 'square_1_1'
      input_mode:
        description: 'å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ (prompt_only/with_image)'
        required: false
        type: string
        default: 'prompt_only'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
    outputs:
      planning-completed:
        description: 'ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.planning.outputs.planning-completed }}
      image-prompt:
        description: 'ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«å¿ å®Ÿãªç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt }}
      concept:
        description: 'å…ƒã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼ˆè©•ä¾¡ç”¨ï¼‰'
        value: ${{ jobs.planning.outputs.concept }}
      text-overlay-prompt:
        description: 'ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.text-overlay-prompt }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  planning:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      image-prompt: ${{ steps.planning.outputs.image-prompt }}
      concept: ${{ steps.planning.outputs.concept }}
      text-overlay-prompt: ${{ steps.planning.outputs.text-overlay-prompt }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ğŸ¯ ã‚³ãƒ³ã‚»ãƒ—ãƒˆâ†’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ¯ Concept to Prompt Planning Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          CONCEPT_PARAM="${{ inputs.concept }}"
          CONCEPT_FILE_PARAM="${{ inputs.concept_file }}"
          USER_TEXT_CONTENT="${{ inputs.text_content }}"
          BANNER_SIZE="${{ inputs.banner_size }}"
          INPUT_MODE="${{ inputs.input_mode }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          
          # å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã®åˆ¤å®šï¼ˆconcept_fileãŒã‚ã‚Œã°æ–°æ–¹å¼ã€ãªã‘ã‚Œã°å¾“æ¥æ–¹å¼ï¼‰
          if [ -n "$CONCEPT_FILE_PARAM" ]; then
            CONCEPT_MODE="file"
            CONCEPT_SOURCE=".github/workflows/docs/$CONCEPT_FILE_PARAM.md"
            echo "ğŸ†• New mode: Using concept file: $CONCEPT_SOURCE" 
          else
            CONCEPT_MODE="direct"
            USER_CONCEPT="$CONCEPT_PARAM"
            echo "ğŸ“ Traditional mode: Using direct concept: $USER_CONCEPT"
          fi
          
          echo "Concept mode: $CONCEPT_MODE"
          echo "User text content: $USER_TEXT_CONTENT"
          echo "Banner size: $BANNER_SIZE"
          echo "Input mode: $INPUT_MODE"
          echo "Planning folder: $PLANNING_DIR"
          
          # è¨ˆç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          mkdir -p "$PLANNING_DIR"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯ãƒãƒŠãƒ¼åºƒå‘Šåˆ¶ä½œã®å°‚é–€ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’è©•ä¾¡åŸºæº–ã‚’è€ƒæ…®ã—ãŸæŠ€è¡“çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚

          **åŸºæœ¬æƒ…å ±**:
          - å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰: $CONCEPT_MODE
          - è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ: '$USER_TEXT_CONTENT' ï¼ˆä¸€å­—ä¸€å¥å¤‰æ›´ç¦æ­¢ï¼‰
          - ãƒãƒŠãƒ¼ã‚µã‚¤ã‚º: $BANNER_SIZE
          - å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰: $INPUT_MODE
          - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€: $FOLDER_NAME

          **ã‚³ãƒ³ã‚»ãƒ—ãƒˆæƒ…å ±**:
          - ã‚³ãƒ³ã‚»ãƒ—ãƒˆãƒ¢ãƒ¼ãƒ‰: $CONCEPT_MODE
          - å¾“æ¥æ–¹å¼ã®å ´åˆ: $USER_CONCEPT
          - æ–°æ–¹å¼ã®å ´åˆ: $CONCEPT_SOURCE

          **é‡è¦åˆ¶ç´„**:
          - ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã€Œ$USER_TEXT_CONTENTã€ã¯ä¸€å­—ä¸€å¥å¤‰æ›´ç¦æ­¢
          - ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã¯Flux Kontext Maxã§å¾Œã‹ã‚‰åˆæˆã™ã‚‹ãŸã‚ã€ãƒ™ãƒ¼ã‚¹ç”»åƒã«ã¯å«ã‚ãªã„
          - ãƒ™ãƒ¼ã‚¹ç”»åƒã«ã¯ãƒ†ã‚­ã‚¹ãƒˆé…ç½®ã‚¨ãƒªã‚¢ã‚’ç¢ºä¿ã™ã‚‹

          **ã‚¿ã‚¹ã‚¯**:
          1. ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’è©³ç´°åˆ†æï¼ˆæ–°æ–¹å¼ã®å ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼‰
          2. è©•ä¾¡åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§: .github/workflows/docs/banner-evaluation-criteria.mdï¼ˆæœ€ä½åŸºæº–ã¨ã—ã¦ï¼‰
          3. ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«å¿ å®Ÿãªè¡¨ç¾ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
          4. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ:
             - $PLANNING_DIR/image-prompt.txt ï¼ˆè‹±èªã§ã®æŠ€è¡“çš„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
             - $PLANNING_DIR/concept.txt ï¼ˆå…ƒã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆä¿å­˜ï¼‰
             - $PLANNING_DIR/text-overlay-prompt.txt ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
             - $PLANNING_DIR/planning-summary.md ï¼ˆãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°çµæœã‚µãƒãƒªãƒ¼ï¼‰

          **ã‚³ãƒ³ã‚»ãƒ—ãƒˆå¿ å®Ÿãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
          - **æœ€å„ªå…ˆ**: ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®æœ¬è³ªãƒ»é›°å›²æ°—ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®Œå…¨ã«è¡¨ç¾
          - è©•ä¾¡åŸºæº–ã¯æœ€ä½å“è³ªåŸºæº–ã¨ã—ã¦å‚ç…§ï¼ˆé«˜å¾—ç‚¹ç‹™ã„ã§ã¯ãªã„ï¼‰
          - ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®æ„Ÿæƒ…ãƒ»ä¾¡å€¤è¦³ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é‡è¦–
          - **å¿…é ˆ**: ãƒ†ã‚­ã‚¹ãƒˆé…ç½®ç”¨ã®æ˜ç¢ºãªç©ºç™½ã‚¨ãƒªã‚¢ã‚’ç¢ºä¿
          - ã€Œwith clear empty space for text overlayã€ã‚’å¿…ãšå«ã‚ã‚‹
          - ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã¯ä¸€åˆ‡å«ã‚ãªã„ï¼ˆé‡è¦ï¼‰
          - ãƒãƒŠãƒ¼ã‚µã‚¤ã‚ºã«æœ€é©åŒ–ã•ã‚ŒãŸèƒŒæ™¯ãƒ»è‰²èª¿
          - 50-100èªç¨‹åº¦ã®é©åˆ‡ãªé•·ã•
          - **è‹±èªã§ä½œæˆ**

          **ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
          - ãƒ†ã‚­ã‚¹ãƒˆã€Œ$USER_TEXT_CONTENTã€ã®æœ€é©é…ç½®ä½ç½®
          - ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ãƒ»ã‚µã‚¤ã‚ºã®æ¨å¥¨å€¤
          - æ–‡å­—è‰²ãƒ»èƒŒæ™¯è‰²ã®çµ„ã¿åˆã‚ã›
          - èª­ã¿ã‚„ã™ã•ã‚’æœ€å¤§åŒ–ã™ã‚‹èª¿æ•´æŒ‡ç¤º
          - å…·ä½“çš„ãªä½ç½®æŒ‡å®šï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰

          é‡è¦: ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®æœ¬è³ªãƒ»æ„Ÿæƒ…ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æœ€å„ªå…ˆã«ã€ãã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆãŒæŒã¤ç‹¬è‡ªæ€§ã¨é­…åŠ›ã‚’æœ€å¤§é™ã«è¡¨ç¾ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚è©•ä¾¡åŸºæº–ã¯å“è³ªã®æœ€ä½ãƒ©ã‚¤ãƒ³ã¨ã—ã¦å‚è€ƒç¨‹åº¦ã«ç•™ã‚ã€ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®å¿ å®Ÿãªå†ç¾ã‚’ç¬¬ä¸€ç›®æ¨™ã¨ã—ã¦ãã ã•ã„ã€‚"
          
          echo "ğŸš€ Starting Concept to Prompt Planning Agent..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸè¨ˆç”»ã®ç¢ºèªã¨GitHub Outputsã®è¨­å®š
          echo ""
          echo "ğŸ“‹ Checking generated planning files..."
          
          # æœ€é©åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/image-prompt.txt" ]; then
            IMAGE_PROMPT=$(cat "$PLANNING_DIR/image-prompt.txt" | tr '\n' ' ')
            echo "::notice::âœ… Image prompt generated"
            echo "image-prompt=$IMAGE_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Image prompt file not found"
            exit 1
          fi
          
          # å…ƒã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/concept.txt" ]; then
            CONCEPT=$(head -5 "$PLANNING_DIR/concept.txt" | tr '\n' ' ')
            echo "::notice::âœ… Concept saved"
            echo "concept=$CONCEPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Concept file not found"
            exit 1
          fi
          
          # ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          if [ -f "$PLANNING_DIR/text-overlay-prompt.txt" ]; then
            TEXT_OVERLAY_PROMPT=$(head -3 "$PLANNING_DIR/text-overlay-prompt.txt" | tr '\n' ' ')
            echo "::notice::âœ… Text overlay prompt generated"
            echo "text-overlay-prompt=$TEXT_OVERLAY_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Text overlay prompt file not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push planning
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No planning files to commit"
          else
            git commit -m "Add concept to prompt planning: ${{ inputs.concept_file || inputs.concept }}

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi