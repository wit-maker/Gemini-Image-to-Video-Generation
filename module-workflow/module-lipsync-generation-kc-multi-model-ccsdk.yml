name: module-lipsync-generation-kc-multi-model-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      model-type:
        description: 'ä½¿ç”¨ã™ã‚‹ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ãƒ¢ãƒ‡ãƒ« (ä¾‹: v2v-fal-creatify-lipsync)'
        required: true
        type: string
      video-url:
        description: 'å…¥åŠ›å‹•ç”»URL'
        required: true
        type: string
      audio-url:
        description: 'å…¥åŠ›éŸ³å£°URL'
        required: true
        type: string
      lipsync-settings:
        description: 'ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯è¨­å®šï¼ˆJSONå½¢å¼ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰'
        required: false
        type: string
        default: '{}'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      lipsync_index:
        description: 'ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.lipsync-generation.outputs.completed }}
      video-url:
        description: 'ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»URL'
        value: ${{ jobs.lipsync-generation.outputs.video-url }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  lipsync-generation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      completed: ${{ steps.lipsync.outputs.completed }}
      video-url: ${{ steps.lipsync.outputs.video-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (ãƒãƒ«ãƒãƒ¢ãƒ‡ãƒ«å¯¾å¿œ)
        id: lipsync
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ‘„ Lipsync Generation Agent Execution (Multi-Model)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_CONCEPT="${{ inputs.concept }}"
          MODEL_TYPE="${{ inputs.model-type }}"
          VIDEO_URL="${{ inputs.video-url }}"
          AUDIO_URL="${{ inputs.audio-url }}"
          LIPSYNC_SETTINGS="${{ inputs.lipsync-settings }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          LIPSYNC_INDEX="${{ inputs.lipsync_index }}"
          LIPSYNC_DIR="$FOLDER_NAME/lipsync-${LIPSYNC_INDEX}"
          
          echo "User concept: $USER_CONCEPT"
          echo "Model type: $MODEL_TYPE"
          echo "Video URL: $VIDEO_URL"
          echo "Audio URL: $AUDIO_URL"
          echo "Lipsync settings: $LIPSYNC_SETTINGS"
          echo "Lipsync index: $LIPSYNC_INDEX"
          echo "Target folder: $LIPSYNC_DIR"
          
          # ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$LIPSYNC_DIR" ]; then
            mkdir -p "$LIPSYNC_DIR"
            echo "ğŸ“ Created lipsync folder: $LIPSYNC_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "âœ… MCP config file exists at: $MCP_CONFIG_ABS_PATH"
          else
            echo "âŒ MCP config file not found at: $MCP_CONFIG_ABS_PATH"
            exit 1
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="æŒ‡å®šã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ã‚’ä½¿ç”¨ã—ã¦ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤º**: $USER_CONCEPT
          **ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—**: $MODEL_TYPE
          **å…¥åŠ›å‹•ç”»URL**: $VIDEO_URL
          **å…¥åŠ›éŸ³å£°URL**: $AUDIO_URL
          **ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯è¨­å®š**: $LIPSYNC_SETTINGS

          **å®Ÿè¡Œæ‰‹é †**:
          1. ã¾ãšã€\`.github/workflows/kamuicode/kamuicode-usage.md\`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ã€Œ$MODEL_TYPEã€ã«å¯¾å¿œã™ã‚‹MCPãƒ„ãƒ¼ãƒ«åã‚’ç¢ºèªã—ã¦ãã ã•ã„
          2. ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡º:
             - submitãƒ„ãƒ¼ãƒ«åï¼ˆä¾‹: mcp__v2v-fal-creatify-lipsync__submitï¼‰
             - statusãƒ„ãƒ¼ãƒ«åï¼ˆä¾‹: mcp__v2v-fal-creatify-lipsync__statusï¼‰
             - resultãƒ„ãƒ¼ãƒ«åï¼ˆä¾‹: mcp__v2v-fal-creatify-lipsync__resultï¼‰
          3. ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é©åˆ‡ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨:
             - **v2v-ã§å§‹ã¾ã‚‹å ´åˆ**: å‹•ç”»URLï¼ˆ$VIDEO_URLï¼‰ã¨éŸ³å£°URLï¼ˆ$AUDIO_URLï¼‰ã‚’ä½¿ç”¨ã—ã¦ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ç”Ÿæˆ
          4. submitãƒ„ãƒ¼ãƒ«ã§ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ç”Ÿæˆã‚’é–‹å§‹
          5. statusãƒ„ãƒ¼ãƒ«ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼ˆãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ç”Ÿæˆã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ã€é©åº¦ãªé–“éš”ã§ç¢ºèªï¼‰
          6. å¿…è¦ã«å¿œã˜ã¦Bashãƒ„ãƒ¼ãƒ«ã§ \`sleep 60\` ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰å†åº¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          7. resultãƒ„ãƒ¼ãƒ«ã§çµæœå–å¾—ã—ã¦ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»URLã‚’å–å¾—
          8. **å¿…é ˆ**: å–å¾—ã—ãŸãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»URLã‚’ã€Œ$LIPSYNC_DIR/lipsync-video-url.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          9. **å¿…é ˆ**: å–å¾—ã—ãŸãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$LIPSYNC_DIR/lipsync-video.mp4ã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - kamuicode-usage.mdã‹ã‚‰æ­£ã—ã„ãƒ„ãƒ¼ãƒ«åã‚’èª­ã¿å–ã‚‹ã“ã¨
          - ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ç”Ÿæˆã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã®é–“ã«é©åº¦ãªå¾…æ©Ÿæ™‚é–“ã‚’å…¥ã‚Œã‚‹ã“ã¨
          - Google URLã®æœ‰åŠ¹æœŸé™ã¯ç´„1æ™‚é–“ã®ãŸã‚ã€ç”Ÿæˆå¾Œã™ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - å¿…ãšGoogleæä¾›ã®èªè¨¼æ¸ˆURLã‚’ä½¿ç”¨ï¼ˆå…¥åŠ›URLã‚‚å‡ºåŠ›URLã‚‚ï¼‰
          - å‹•ç”»ã¯å¿…ãšã€Œ$LIPSYNC_DIRã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œlipsync-video.mp4ã€ã¨ã™ã‚‹
          - **æœ€é‡è¦**: ç”Ÿæˆæ™‚ã®ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»URLã‚’ã€Œ$LIPSYNC_DIR/lipsync-video-url.txtã€ã«ä¿å­˜ã—ã€æ¬¡ã®ã‚¸ãƒ§ãƒ–ã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          - **ä¸¡æ–¹ã‚’å®Ÿè¡Œ**: â‘ ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»URLã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ â‘¡ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»URLã‹ã‚‰å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
          - **å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦**: å‹•ç”»URLã¨éŸ³å£°URLã¯æ—¢ã«èªè¨¼æ¸ˆã¿ã®Googleãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨"
          
          echo "ğŸš€ Starting Lipsync Generation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œï¼ˆãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ç”Ÿæˆç³»ãƒ„ãƒ¼ãƒ«ã¯ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã§è¨±å¯ï¼‰
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__v2v-*,Read,Bash" \
            --max-turns 40 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ã®ç¢ºèª
          echo ""
          echo "ğŸ‘„ Checking generated lipsync videos..."
          if [ -d "$LIPSYNC_DIR" ]; then
            LIPSYNC_COUNT=$(find "$LIPSYNC_DIR" -name "*.mp4" -o -name "*.mov" -o -name "*.avi" | wc -l)
            echo "::notice::ğŸ‘„ Generated $LIPSYNC_COUNT lipsync videos using $MODEL_TYPE"
            if [ "$LIPSYNC_COUNT" -gt 0 ]; then
              # ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
              for lipsync_file in $(find "$LIPSYNC_DIR" -name "*.mp4" -o -name "*.mov" -o -name "*.avi" | head -3); do
                if [ -f "$lipsync_file" ]; then
                  LIPSYNC_SIZE=$(stat -c%s "$lipsync_file" 2>/dev/null || stat -f%z "$lipsync_file" 2>/dev/null || echo "0")
                  echo "::notice::ğŸ¬ Lipsync video file: $lipsync_file (${LIPSYNC_SIZE} bytes)"
                  if [ "$LIPSYNC_SIZE" -eq 0 ]; then
                    echo "::error::âŒ Lipsync video file is empty: $lipsync_file"
                    exit 1
                  fi
                fi
              done
              
              # ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»URLãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã¨å‡ºåŠ›è¨­å®š
              LIPSYNC_URL_FILE="$LIPSYNC_DIR/lipsync-video-url.txt"
              if [ -f "$LIPSYNC_URL_FILE" ]; then
                LIPSYNC_VIDEO_URL=$(cat "$LIPSYNC_URL_FILE")
                echo "âœ… Lipsync video URL found: $LIPSYNC_VIDEO_URL"
                echo "video-url=$LIPSYNC_VIDEO_URL" >> $GITHUB_OUTPUT
              else
                echo "âŒ Lipsync video URL file not found: $LIPSYNC_URL_FILE"
                echo "Creating empty URL file to continue workflow..."
                echo "" > "$LIPSYNC_URL_FILE"
                echo "video-url=" >> $GITHUB_OUTPUT
              fi
            else
              echo "::error::âŒ No lipsync videos were generated"
              exit 1
            fi
          else
            echo "::error::âŒ Lipsync directory not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push lipsync videos
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No lipsync videos to commit"
          else
            git commit -m "Add generated lipsync video using ${{ inputs.model-type }}: ${{ inputs.concept }}
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi