name: module-video-prompt-optimization-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      video-concept:
        description: 'å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      image-url:
        description: 'ç”»åƒURL'
        required: true
        type: string
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      video_index:
        description: 'å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.optimization.outputs.completed }}
      video-prompt:
        description: 'æœ€é©åŒ–ã•ã‚ŒãŸå‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.optimization.outputs.video-prompt }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  optimization:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      completed: ${{ steps.optimization.outputs.completed }}
      video-prompt: ${{ steps.optimization.outputs.video-prompt }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: optimization
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ¬ Video Prompt Optimization Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_CONCEPT="${{ inputs.concept }}"
          VIDEO_CONCEPT="${{ inputs.video-concept }}"
          GOOGLE_IMAGE_URL="${{ inputs.image-url }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          VIDEO_INDEX="${{ inputs.video_index }}"
          IMAGES_DIR="$FOLDER_NAME/images-${VIDEO_INDEX}"
          OPTIMIZATION_DIR="$FOLDER_NAME/optimization-${VIDEO_INDEX}"
          
          echo "Video index: $VIDEO_INDEX"
          echo "Images folder: $IMAGES_DIR"
          echo "Optimization folder: $OPTIMIZATION_DIR"
          
          # æœ€é©åŒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$OPTIMIZATION_DIR" ]; then
            mkdir -p "$OPTIMIZATION_DIR"
            echo "ğŸ“ Created optimization folder: $OPTIMIZATION_DIR"
          fi
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®ç¢ºèª
          GENERATED_IMAGE=$(find "$IMAGES_DIR" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | head -1)
          if [ -z "$GENERATED_IMAGE" ]; then
            echo "::error::âŒ No generated images found"
            exit 1
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯å‹•ç”»ç”Ÿæˆã®å°‚é–€å®¶ã§ã™ã€‚ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’åˆ†æã—ã€Vidu Q1ã§ã®å‹•ç”»ç”Ÿæˆã«æœ€é©ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤º**: $USER_CONCEPT
          **åˆæœŸå‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $VIDEO_CONCEPT
          **ç”Ÿæˆæ¸ˆã¿ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«**: $GENERATED_IMAGE
          **ç”»åƒURL**: $GOOGLE_IMAGE_URL

          **ã‚¿ã‚¹ã‚¯**:
          1. ç”Ÿæˆã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’åˆ†æ
          2. ç”»åƒã®è¦–è¦šçš„è¦ç´ ï¼ˆè‰²å½©ã€æ§‹å›³ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã‚’è©³ç´°ã«æŠŠæ¡
          3. åˆæœŸå‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨ç”»åƒå†…å®¹ã‚’ç…§åˆ
          4. Vidu Q1ã§ã®å‹•ç”»ç”Ÿæˆã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          5. æœ€é©åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$OPTIMIZATION_DIR/video-prompt.txtã€ã«ä¿å­˜
          6. æœ€é©åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ$OPTIMIZATION_DIR/video-prompt.mdã€ã«ä¿å­˜ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨ï¼‰
          7. åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ã€Œ$OPTIMIZATION_DIR/analysis.mdã€ã«ä¿å­˜

          **å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ**:
          - ç”»åƒã®å…·ä½“çš„ãªå†…å®¹ã«åŸºã¥ã„ãŸå‹•ç”»ã®å‹•ãã‚’æŒ‡å®š
          - ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®é›°å›²æ°—ã‚„è‰²èª¿ã‚’æ´»ã‹ã—ãŸå‹•ç”»è¡¨ç¾
          - Vidu Q1ã®ç‰¹æ€§ã‚’è€ƒæ…®ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–
          - è‡ªç„¶ã§é­…åŠ›çš„ãªå‹•ç”»ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ãƒªãƒ³ã‚°
          - æŠ€è¡“çš„åˆ¶ç´„ã‚’è€ƒæ…®ã—ãŸç¾å®Ÿçš„ãªå‹•ç”»ç”ŸæˆæŒ‡ç¤º

          **æœ€é©åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¦ä»¶**:
          - ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’èµ·ç‚¹ã¨ã—ãŸå…·ä½“çš„ãªå‹•ç”»ã®å‹•ã
          - 30-80èªç¨‹åº¦ã®é©åˆ‡ãªé•·ã•
          - Vidu Q1ã«é©ã—ãŸè¡¨ç¾ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
          - ç”»åƒã®ç‰¹å¾´ã‚’æ´»ã‹ã—ãŸå‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
          - æ™‚é–“è»¸ã‚’è€ƒæ…®ã—ãŸå‹•ãã®æŒ‡ç¤º

          **é‡è¦**: 
          1. å¿…ãšç”Ÿæˆã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’åˆ†æã—ã¦ãã ã•ã„
          2. ç”»åƒã®å†…å®¹ã«åŸºã¥ã„ã¦å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æœ€é©åŒ–ã—ã¦ãã ã•ã„
          3. txtãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿæ¢°å‡¦ç†ç”¨ï¼ˆ1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€mdãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªç”¨
          4. æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«çµæœã‚’ä¿å­˜ã—ã¦ãã ã•ã„"
          
          echo "ğŸš€ Starting Video Prompt Optimization Agent Claude Code CLI..."
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Edit" \
            --max-turns 10 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # æœ€é©åŒ–çµæœã®ç¢ºèª
          if [ -f "$OPTIMIZATION_DIR/video-prompt.txt" ]; then
            OPTIMIZED_PROMPT=$(cat "$OPTIMIZATION_DIR/video-prompt.txt" | tr '\n' ' ')
            echo "::notice::âœ… Optimized video prompt generated"
            echo "Optimized prompt: $OPTIMIZED_PROMPT"
            echo "video-prompt=$OPTIMIZED_PROMPT" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ Optimized video prompt file not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push optimization
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No optimization files to commit"
          else
            git commit -m "Add video prompt optimization: ${{ inputs.concept }}"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi