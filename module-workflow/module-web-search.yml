name: module-web-search

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'
        required: true
        type: string
      search-date:
        description: 'æ¤œç´¢å¯¾è±¡æ—¥ï¼ˆyesterday, today, 2024-01-01ãªã©ï¼‰'
        required: false
        type: string
        default: 'yesterday'
      target-language:
        description: 'æ¤œç´¢è¨€èª (japanese/english)'
        required: false
        type: string
        default: 'japanese'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      search_index:
        description: 'æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.web-search.outputs.completed }}
      search-results:
        description: 'æ¤œç´¢çµæœï¼ˆJSONå½¢å¼ï¼‰'
        value: ${{ jobs.web-search.outputs.search-results }}
      found-sources:
        description: 'å®Ÿéš›ã«è¦‹ã¤ã‹ã£ãŸã‚½ãƒ¼ã‚¹URL'
        value: ${{ jobs.web-search.outputs.found-sources }}
      search-summary:
        description: 'æ¤œç´¢çµæœè¦ç´„'
        value: ${{ jobs.web-search.outputs.search-summary }}
    secrets:
      gemini_api_key:
        description: 'Gemini API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  web-search:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      completed: ${{ steps.search-results.outputs.completed }}
      search-results: ${{ steps.search-results.outputs.search-results }}
      found-sources: ${{ steps.search-results.outputs.found-sources }}
      search-summary: ${{ steps.search-results.outputs.search-summary }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Gemini API Web Search with Google Search Grounding
        id: gemini-search
        run: |
          echo "ğŸ” Executing Gemini API with Google Search Grounding..."
          
          # æ¤œç´¢ã‚¯ã‚¨ãƒªã®æ§‹ç¯‰
          SEARCH_QUERY="${{ inputs.concept }} ${{ inputs.search-date == 'yesterday' && 'yesterday' || inputs.search-date == 'today' && 'today' || inputs.search-date }} AI news"
          
          # Gemini APIå‘¼ã³å‡ºã—ï¼ˆGoogle Search Groundingæœ‰åŠ¹ï¼‰
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent" \
            -H "x-goog-api-key: ${{ secrets.gemini_api_key }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [
                {
                  \"parts\": [
                    {\"text\": \"Please search for recent news about: ${SEARCH_QUERY}. Focus on finding actual, real news articles from reliable sources like Reuters, Bloomberg, TechCrunch, VentureBeat, Nikkei, etc. Provide the search results with URLs and brief summaries.\"}
                  ]
                }
              ],
              \"tools\": [
                {\"google_search\": {}}
              ]
            }")
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$RESPONSE" > gemini_response.json
          
          # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã‚’ç¢ºèª
          echo "ğŸ“‹ Gemini API Response:"
          cat gemini_response.json | jq '.' || echo "JSON parsing failed, showing raw response:" && cat gemini_response.json
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’GitHubç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "GEMINI_RESPONSE<<EOF" >> $GITHUB_ENV
          cat gemini_response.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Process search results
        id: search-results
        run: |
          echo "ğŸ“Š Processing Gemini API search results..."
          
          # æ¤œç´¢çµæœã®è§£æ
          SEARCH_RESULTS_DIR="${{ inputs.folder-name }}/search-${{ inputs.search_index }}"
          mkdir -p "$SEARCH_RESULTS_DIR"
          
          # Geminiãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
          CONTENT=$(echo "$GEMINI_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "No content found"')
          
          # GroundingMetadataã®ç¢ºèª
          GROUNDING_METADATA=$(echo "$GEMINI_RESPONSE" | jq '.candidates[0].groundingMetadata // null')
          
          if [ "$GROUNDING_METADATA" != "null" ] && [ "$GROUNDING_METADATA" != "" ]; then
            echo "âœ… Grounding metadata found - real web search executed!"
            
            # ã‚½ãƒ¼ã‚¹URLã‚’æŠ½å‡ºï¼ˆwebSearchQueriesã‹ã‚‰ï¼‰
            SEARCH_QUERIES=$(echo "$GEMINI_RESPONSE" | jq -r '.candidates[0].groundingMetadata.webSearchQueries[]? // empty' | tr '\n' ', ')
            
            # GroundingChunksã‹ã‚‰ã‚½ãƒ¼ã‚¹URLã‚’æŠ½å‡ºï¼ˆã‚ˆã‚Šæ­£ç¢ºï¼‰
            CHUNK_URLS=$(echo "$GEMINI_RESPONSE" | jq -r '.candidates[0].groundingMetadata.groundingChunks[]?.web.uri // empty' | head -5 | tr '\n' ', ')
            
            # ã©ã¡ã‚‰ã‹åˆ©ç”¨å¯èƒ½ãªæ–¹ã‚’ä½¿ç”¨
            if [ -n "$CHUNK_URLS" ] && [ "$CHUNK_URLS" != ", " ]; then
              SOURCES="$CHUNK_URLS"
              echo "ğŸ”— Found chunk URLs: $SOURCES"
            else
              SOURCES="$SEARCH_QUERIES"
              echo "ğŸ”— Found search queries: $SOURCES"
            fi
            
            # æ¤œç´¢çµæœã‚’ä¿å­˜
            echo "$CONTENT" > "$SEARCH_RESULTS_DIR/search-content.txt"
            echo "$GROUNDING_METADATA" | jq '.' > "$SEARCH_RESULTS_DIR/grounding-metadata.json"
            echo "$SOURCES" > "$SEARCH_RESULTS_DIR/sources.txt"
            
            # GitHubå‡ºåŠ›è¨­å®šï¼ˆç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
            CONTENT_CLEAN=$(echo "$CONTENT" | tr -d '\n\r' | sed 's/[*]/\\*/g' | head -c 8000)
            SOURCES_CLEAN=$(echo "$SOURCES" | tr -d '\n\r' | head -c 2000)
            
            echo "search-results=$CONTENT_CLEAN" >> $GITHUB_OUTPUT
            echo "found-sources=$SOURCES_CLEAN" >> $GITHUB_OUTPUT
            echo "search-summary=Real web search executed successfully. Found sources available." >> $GITHUB_OUTPUT
            
          else
            echo "âŒ No grounding metadata found - search may not have been executed"
            
            # æ¤œç´¢å¤±æ•—ã®å ´åˆ
            echo "No real web search results found for: ${{ inputs.concept }}" > "$SEARCH_RESULTS_DIR/search-content.txt"
            echo "[]" > "$SEARCH_RESULTS_DIR/grounding-metadata.json"
            echo "No sources found" > "$SEARCH_RESULTS_DIR/sources.txt"
            
            # GitHubå‡ºåŠ›è¨­å®š
            echo "search-results=$CONTENT" >> $GITHUB_OUTPUT
            echo "found-sources=No sources found" >> $GITHUB_OUTPUT
            echo "search-summary=Web search executed but no real sources found. Content may be from internal knowledge." >> $GITHUB_OUTPUT
          fi
          
          # å®Œäº†ãƒ•ãƒ©ã‚°è¨­å®š
          echo "completed=true" >> $GITHUB_OUTPUT
          
          # çµæœè¡¨ç¤º
          echo "ğŸ“„ Search Content Preview:"
          head -10 "$SEARCH_RESULTS_DIR/search-content.txt"
          
      - name: Commit search results
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No search result files to commit"
          else
            git commit -m "Add web search results: ${{ inputs.concept }}

            Search date: ${{ inputs.search-date }}
            Language: ${{ inputs.target-language }}
            Method: Gemini API + Google Search Grounding

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi