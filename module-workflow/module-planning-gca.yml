name: module-planning-gca

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      total_videos:
        description: 'ç”Ÿæˆã™ã‚‹å‹•ç”»ã®æ•°'
        required: false
        type: string
        default: '1'
      image-model-type:
        description: 'ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ï¼ˆæŒ‡å®šæ™‚ã¯ãã®ãƒ¢ãƒ‡ãƒ«ã«æœ€é©åŒ–ã€æœªæŒ‡å®šæ™‚ã¯æ±ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰'
        required: false
        type: string
      video-model-type:
        description: 'å‹•ç”»ç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ï¼ˆæŒ‡å®šæ™‚ã¯ãã®ãƒ¢ãƒ‡ãƒ«ã«æœ€é©åŒ–ã€æœªæŒ‡å®šæ™‚ã¯æ±ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰'
        required: false
        type: string
    outputs:
      planning-completed:
        description: 'ä¼ç”»å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.planning.outputs.planning-completed }}
      # å‹•çš„å‡ºåŠ›ï¼ˆæœ€å¤§8å‹•ç”»ã¾ã§å¯¾å¿œï¼‰
      image-prompt-1:
        description: 'å‹•ç”»1ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-1 }}
      image-prompt-2:
        description: 'å‹•ç”»2ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-2 }}
      image-prompt-3:
        description: 'å‹•ç”»3ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-3 }}
      image-prompt-4:
        description: 'å‹•ç”»4ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-4 }}
      image-prompt-5:
        description: 'å‹•ç”»5ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-5 }}
      image-prompt-6:
        description: 'å‹•ç”»6ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-6 }}
      image-prompt-7:
        description: 'å‹•ç”»7ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-7 }}
      image-prompt-8:
        description: 'å‹•ç”»8ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.image-prompt-8 }}
      video-concept-1:
        description: 'å‹•ç”»1ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-1 }}
      video-concept-2:
        description: 'å‹•ç”»2ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-2 }}
      video-concept-3:
        description: 'å‹•ç”»3ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-3 }}
      video-concept-4:
        description: 'å‹•ç”»4ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-4 }}
      video-concept-5:
        description: 'å‹•ç”»5ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-5 }}
      video-concept-6:
        description: 'å‹•ç”»6ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-6 }}
      video-concept-7:
        description: 'å‹•ç”»7ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-7 }}
      video-concept-8:
        description: 'å‹•ç”»8ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.planning.outputs.video-concept-8 }}
    secrets:
      gemini_api_key:
        description: 'Gemini API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  planning:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.verify.outputs.completed }}
      # å‹•çš„å‡ºåŠ›ï¼ˆæœ€å¤§8å‹•ç”»ã¾ã§å¯¾å¿œï¼‰
      image-prompt-1: ${{ steps.verify.outputs.image-prompt-1 }}
      image-prompt-2: ${{ steps.verify.outputs.image-prompt-2 }}
      image-prompt-3: ${{ steps.verify.outputs.image-prompt-3 }}
      image-prompt-4: ${{ steps.verify.outputs.image-prompt-4 }}
      image-prompt-5: ${{ steps.verify.outputs.image-prompt-5 }}
      image-prompt-6: ${{ steps.verify.outputs.image-prompt-6 }}
      image-prompt-7: ${{ steps.verify.outputs.image-prompt-7 }}
      image-prompt-8: ${{ steps.verify.outputs.image-prompt-8 }}
      video-concept-1: ${{ steps.verify.outputs.video-concept-1 }}
      video-concept-2: ${{ steps.verify.outputs.video-concept-2 }}
      video-concept-3: ${{ steps.verify.outputs.video-concept-3 }}
      video-concept-4: ${{ steps.verify.outputs.video-concept-4 }}
      video-concept-5: ${{ steps.verify.outputs.video-concept-5 }}
      video-concept-6: ${{ steps.verify.outputs.video-concept-6 }}
      video-concept-7: ${{ steps.verify.outputs.video-concept-7 }}
      video-concept-8: ${{ steps.verify.outputs.video-concept-8 }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
          
      - name: ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨ˆç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Gemini)
        id: planning
        uses: google-gemini/gemini-cli-action@main
        with:
          GEMINI_API_KEY: ${{ secrets.gemini_api_key }}
          prompt: |
            ğŸ“‹ **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨ˆç”»ã‚¿ã‚¹ã‚¯ - Gemini Planning ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**
            
            **åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: ${{ inputs.concept }}
            **ç”Ÿæˆã™ã‚‹å‹•ç”»æ•°**: ${{ inputs.total_videos }}
            **ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«**: ${{ inputs.image-model-type || 'æœªæŒ‡å®š' }}
            **å‹•ç”»ç”Ÿæˆãƒ¢ãƒ‡ãƒ«**: ${{ inputs.video-model-type || 'æœªæŒ‡å®š' }}
            
            **ã‚¿ã‚¹ã‚¯**: åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‹ã‚‰${{ inputs.total_videos }}ã¤ã®å‹•ç”»ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®è©³ç´°ãªè¨ˆç”»ã‚’ç«‹æ¡ˆ
            
            **å…¨ä½“æˆ¦ç•¥**:
            - ${{ inputs.total_videos }}ã¤ã®å‹•ç”»ã§ä¸€ã¤ã®ãƒ†ãƒ¼ãƒã‚’è¡¨ç¾
            - å„å‹•ç”»ã¯ç‹¬ç«‹ã—ãŸé­…åŠ›ã‚’æŒã¤
            - ç•°ãªã‚‹è¦–ç‚¹ãƒ»ã‚¢ãƒ³ã‚°ãƒ«ãƒ»è¡¨ç¾ã§å·®åˆ¥åŒ–
            - çµ±ä¸€æ„Ÿã®ã‚ã‚‹ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
            
            **å„å‹•ç”»ã®æ–¹å‘æ€§**:
            - å‹•ç”»1: ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ³ã‚°ãƒ«ã€æ­£é¢ã‹ã‚‰ã®åŸºæœ¬å‹•ä½œãƒ»è¡¨ç¾
            - å‹•ç”»2: ã‚µã‚¤ãƒ‰ã‚¢ãƒ³ã‚°ãƒ«ã€æ¨ªã‹ã‚‰ã®å‹•çš„è¡¨ç¾
            - å‹•ç”»3: ä¸Šã‹ã‚‰ã®ä¿¯ç°ã€å…¨ä½“ã®å‹•ãã‚’å¼·èª¿
            - å‹•ç”»4: ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ã€ç´°éƒ¨ã®é­…åŠ›ã‚’è¡¨ç¾
            - å‹•ç”»5ä»¥é™: å‰µé€ çš„ãªè¦–ç‚¹ã§ã®ç‹¬è‡ªè¡¨ç¾
            
            **å®Ÿè¡Œæ‰‹é †**:
            1. **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ**:
               ```bash
               mkdir -p ${{ inputs.folder-name }}/planning
               ```
               
            2. **åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®åˆ†æ**:
               - ä¸»è¦ãªè¦ç´ ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€è¨­å®šã€ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã‚’æŠ½å‡º
               - è¦–è¦šçš„ç‰¹å¾´ã‚’æ˜ç¢ºåŒ–
               - å‹•ãã®è¦ç´ ã‚’ç‰¹å®š
               
            3. **å„å‹•ç”»ç”¨ã®ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ**:
               - æ±ç”¨çš„ã§é«˜å“è³ªãªç”»åƒç”Ÿæˆã«é©ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
               - å„å‹•ç”»ã®ç‰¹æ€§ã«æœ€é©åŒ–ã•ã‚ŒãŸå†…å®¹
               - è¦–è¦šçš„è¦ç´ ï¼ˆè‰²å½©ã€æ§‹å›³ã€ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã‚’æ˜ç¢ºã«æŒ‡å®š
               - é«˜è§£åƒåº¦ãƒ»é«˜å“è³ªã‚’æ„è­˜ã—ãŸè¨˜è¿°
               - 50-100èªç¨‹åº¦ã®é©åˆ‡ãªé•·ã•
               - **é‡è¦**: ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯è‹±èªã§ä½œæˆã—ã¦ãã ã•ã„
               - **ãƒ¢ãƒ‡ãƒ«æœ€é©åŒ–**: ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®ç‰¹æ€§ã«åˆã‚ã›ã¦æœ€é©åŒ–
               
            4. **å„å‹•ç”»ç”¨ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆä½œæˆ**:
               - ç”Ÿæˆã•ã‚Œã‚‹ç”»åƒã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸå‹•ç”»ã®æ–¹å‘æ€§
               - å„å‹•ç”»å›ºæœ‰ã®å‹•ãã‚„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡
               - é›°å›²æ°—ã‚„æ„Ÿæƒ…è¡¨ç¾
               - æ±ç”¨çš„ãªå‹•ç”»ç”Ÿæˆã«é©ã—ãŸå†…å®¹
               - **ãƒ¢ãƒ‡ãƒ«æœ€é©åŒ–**: å‹•ç”»ç”Ÿæˆãƒ¢ãƒ‡ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®ç‰¹æ€§ã«åˆã‚ã›ã¦æœ€é©åŒ–
               
            5. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜**:
               ```
               write_file(${{ inputs.folder-name }}/planning/video-plan.md, è¨ˆç”»æ›¸)
               write_file(${{ inputs.folder-name }}/planning/image-prompt-1.md, å‹•ç”»1ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)
               write_file(${{ inputs.folder-name }}/planning/image-prompt-2.md, å‹•ç”»2ç”¨ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)
               write_file(${{ inputs.folder-name }}/planning/video-concept-1.md, å‹•ç”»1ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ)
               write_file(${{ inputs.folder-name }}/planning/video-concept-2.md, å‹•ç”»2ç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ)
               # ä»¥ä¸‹ã€å‹•ç”»æ•°åˆ†
               ```
               
            **é‡è¦**: 
            1. å¿…ãš${{ inputs.total_videos }}å€‹åˆ†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„
            2. mdãƒ•ã‚¡ã‚¤ãƒ«ã¯1è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§ä½œæˆã—ã¦ãã ã•ã„
            3. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯å…·ä½“çš„ã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„
            4. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªãƒ»å ±å‘Šã—ã¦ãã ã•ã„
            
      - name: Verify planning results
        id: verify
        run: |
          FOLDER_NAME="${{ inputs.folder-name }}"
          TOTAL_VIDEOS="${{ inputs.total_videos }}"
          
          echo "ğŸ“‹ Checking generated planning files..."
          
          # å„å‹•ç”»ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‡ºåŠ›ã‚’è¨­å®š
          for i in $(seq 1 $TOTAL_VIDEOS); do
            # ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
            if [ -f "$FOLDER_NAME/planning/image-prompt-${i}.md" ]; then
              IMAGE_PROMPT=$(cat "$FOLDER_NAME/planning/image-prompt-${i}.md" | tr '\n' ' ')
              echo "âœ… Image prompt ${i} generated: $IMAGE_PROMPT"
              echo "image-prompt-${i}=$IMAGE_PROMPT" >> $GITHUB_OUTPUT
            else
              echo "âŒ Image prompt ${i} file not found"
              exit 1
            fi
            
            # å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ç¢ºèª
            if [ -f "$FOLDER_NAME/planning/video-concept-${i}.md" ]; then
              VIDEO_CONCEPT=$(head -5 "$FOLDER_NAME/planning/video-concept-${i}.md" | tr '\n' ' ')
              echo "âœ… Video concept ${i} generated: $VIDEO_CONCEPT"
              echo "video-concept-${i}=$VIDEO_CONCEPT" >> $GITHUB_OUTPUT
            else
              echo "âŒ Video concept ${i} file not found"
              exit 1
            fi
          done
          
          echo "completed=true" >> $GITHUB_OUTPUT
          
      - name: Commit planning results
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No planning files to commit"
          else
            git commit -m "ğŸ“‹ Add planning results: ${{ inputs.concept }}
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi