name: module-lipsync-video-analysis-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      audio-url:
        description: 'éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«URL'
        required: true
        type: string
      text-content:
        description: 'éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹'
        required: true
        type: string
      target-language:
        description: 'å­—å¹•è¨€èª (japanese ã¾ãŸã¯ english)'
        required: false
        type: string
        default: 'japanese'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      video_index:
        description: 'å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      completed:
        description: 'è§£æå®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.lipsync-video-analysis.outputs.completed }}
      subtitle-srt-content:
        description: 'å­—å¹•SRTãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹'
        value: ${{ jobs.lipsync-video-analysis.outputs.subtitle-srt-content }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  lipsync-video-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      completed: ${{ steps.analysis-complete.outputs.completed }}
      subtitle-srt-content: ${{ steps.analysis-complete.outputs.subtitle-srt-content }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
          
      - name: Install ffmpeg for video analysis
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg wget curl jq
          ffmpeg -version | head -5
          
      - name: Get audio metadata
        id: audio-metadata
        run: |
          AUDIO_URL="${{ inputs.audio-url }}"
          ANALYSIS_DIR="${{ inputs.folder-name }}/subtitle-analysis-${{ inputs.video_index }}"
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p "$ANALYSIS_DIR"
          
          echo "Audio URL: $AUDIO_URL"
          
          # éŸ³å£°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          if [[ "$AUDIO_URL" == http* ]]; then
            echo "Downloading audio from URL..."
            wget "$AUDIO_URL" -O "$ANALYSIS_DIR/temp_audio.mp3"
            AUDIO_FILE="$ANALYSIS_DIR/temp_audio.mp3"
          else
            echo "Using local audio file..."
            AUDIO_FILE="$AUDIO_URL"
          fi
          
          # ffprobeã§éŸ³å£°æƒ…å ±ã‚’å–å¾—
          if [ -f "$AUDIO_FILE" ]; then
            DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 "$AUDIO_FILE")
            
            echo "Audio Duration: $DURATION seconds"
            
            # GitHub Outputã«è¨­å®š
            echo "duration=$DURATION" >> $GITHUB_OUTPUT
            
            # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            echo "{
              \"duration\": $DURATION,
              \"url\": \"$AUDIO_URL\"
            }" > "$ANALYSIS_DIR/audio-metadata.json"
            
            echo "âœ… Audio metadata extracted successfully"
          else
            echo "::error::âŒ Audio file not found: $AUDIO_FILE"
            exit 1
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ğŸ“Š ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»å­—å¹•è§£æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Claude Code)
        id: analyze-lipsync-video
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
          GEMINI_API_KEY: ${{ secrets.gemini_api_key }}
        run: |
          echo "::group::ğŸ“Š Lipsync Video Analysis Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          AUDIO_URL="${{ inputs.audio-url }}"
          TEXT_CONTENT="${{ inputs.text-content }}"
          TARGET_LANGUAGE="${{ inputs.target-language }}"
          CONCEPT="${{ inputs.concept }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          ANALYSIS_DIR="$FOLDER_NAME/subtitle-analysis-${{ inputs.video_index }}"
          VIDEO_INDEX="${{ inputs.video_index }}"
          AUDIO_DURATION="${{ steps.audio-metadata.outputs.duration }}"
          
          echo "Audio URL: $AUDIO_URL"
          echo "Audio Duration: $AUDIO_DURATION seconds"
          echo "Target language: $TARGET_LANGUAGE"
          echo "Analysis directory: $ANALYSIS_DIR"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ğŸ“Š éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å­—å¹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°è§£æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

            **ã‚¿ã‚¹ã‚¯**: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿéš›ã®éŸ³å£°ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ†æã—ã¦ã€æ­£ç¢ºã«åŒæœŸã—ãŸå­—å¹•è¨­å®šã‚’ä½œæˆ

            **å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**:
            - éŸ³å£°URL: $AUDIO_URL
            - éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆ: \"$TEXT_CONTENT\"
            - éŸ³å£°é•·: $AUDIO_DURATIONç§’
            - è¨€èª: $TARGET_LANGUAGE
            - ä½œæ¥­ãƒ•ã‚©ãƒ«ãƒ€: $ANALYSIS_DIR

            **å®Ÿè¡Œã—ãŸã„ã“ã¨**:
            1. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿéš›ã®éŸ³å£°æ³¢å½¢ã‚’åˆ†æã—ã¦ç™ºè©±ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ¤œå‡º
            2. éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆã‚’æ—¥æœ¬èªæ–‡æ³•ã«åŸºã¥ã„ã¦é©åˆ‡ã«ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å‰²
            3. SRTå½¢å¼ã®å­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆæ™‚é–“ã¨æ–‡å­—ã‚’åŒæ™‚ã«è§£æã—ã¦ç²¾å¯†ã«åŒæœŸï¼‰
            4. **å“è³ªãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•ä¿®æ­£**: ç”Ÿæˆã•ã‚ŒãŸå­—å¹•ã®å“è³ªã‚’è©•ä¾¡ã—ã€å•é¡ŒãŒã‚ã‚Œã°è‡ªå‹•çš„ã«å†è§£æãƒ»ä¿®æ­£
            5. è©³ç´°ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ

            **ä½¿ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«**:
            - Bash: ffmpeg, ffprobe, wget, curl, jq, python3
            - Read/Write/Edit: ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
            - éŸ³å£°åˆ†æ: silencedetect ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ç„¡éŸ³åŒºé–“æ¤œå‡º

            **é‡è¦ãªè¦æ±‚**:
            - éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆå†…ã®æ™‚é–“åˆ¶ç´„ï¼ˆã€Œ30ç§’ä»¥å†…ã€ç­‰ï¼‰ã¯å®Œå…¨ã«ç„¡è¦–
            - å®Ÿéš›ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ$AUDIO_DURATIONç§’ï¼‰ã®ã¿ã‚’åŸºæº–ã¨ã™ã‚‹
            - ffmpegã§éŸ³å£°æ³¢å½¢ã‚’åˆ†æã—ã€å®Ÿéš›ã®ç™ºè©±åŒºé–“ã‚’æ¤œå‡º
            - **æ™‚é–“ã¨æ–‡å­—ã®åŒæ™‚è§£æ**: ç™ºè©±åŒºé–“ã®æ¤œå‡ºã¨åŒæ™‚ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†å‰²ã—ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨æ–‡å­—æ•°ã®ãƒãƒ©ãƒ³ã‚¹ã‚’æœ€é©åŒ–
            - æ„å‘³ã‚’ä¿æŒã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å‰²
            - **SRTå½¢å¼ã§ã®å‡ºåŠ›**: æ¨™æº–çš„ãªSRTå­—å¹•å½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã“ã¨

            **ãƒ†ã‚­ã‚¹ãƒˆåˆ†å‰²ã®å„ªå…ˆé †ä½ï¼ˆé‡è¦ï¼‰**:
            1. **æ–‡ç« å˜ä½åˆ†å‰²**: å¥ç‚¹ï¼ˆã€‚ï¼‰ã§åŸºæœ¬çš„ã«åˆ†å‰²ã™ã‚‹
            2. **èª­ç‚¹ã®å‡¦ç†**: èª­ç‚¹ï¼ˆã€ï¼‰ã§ã¯åˆ†å‰²ã›ãšã€é•·ã„æ–‡ç« ï¼ˆ30æ–‡å­—ä»¥ä¸Šï¼‰ã®å ´åˆã®ã¿èª­ç‚¹ã§åˆ†å‰²
            3. **æ„å‘³ä¿æŒ**: åŠ©è©ã‚„æ¥ç¶šè©ã§ä¸è‡ªç„¶ã«åˆ†å‰²ã—ãªã„
            4. **æ–‡å­—æ•°åˆ¶é™**: 1ã¤ã®å­—å¹•ã¯15-30æ–‡å­—ç¨‹åº¦ã‚’ç›®å®‰ã¨ã™ã‚‹
            5. **å¥èª­ç‚¹ç„¡éŸ³ã®ç„¡è¦–**: èª­ç‚¹ï¼ˆã€ï¼‰ã‚„å¥ç‚¹ï¼ˆã€‚ï¼‰ã§ã®çŸ­ã„ç„¡éŸ³ï¼ˆ0.3ç§’ä»¥ä¸‹ï¼‰ã¯å­—å¹•åˆ†å‰²ã®åŸºæº–ã«ã—ãªã„

            **éŸ³å£°åˆ†æã®æ”¹å–„**:
            - silencedetectã®é–¾å€¤ã‚’èª¿æ•´: -30dBä»¥ä¸‹ã€0.5ç§’ä»¥ä¸Šã®ç„¡éŸ³ã®ã¿ã‚’åˆ†å‰²ç‚¹ã¨ã—ã¦æ¤œå‡º
            - å¥èª­ç‚¹ã§ã®çŸ­ã„ç„¡éŸ³ï¼ˆ0.1-0.3ç§’ï¼‰ã¯ç„¡è¦–ã™ã‚‹
            - æ–‡æœ«ï¼ˆã€‚ï¼‰ã§ã®é•·ã„ç„¡éŸ³ï¼ˆ0.5ç§’ä»¥ä¸Šï¼‰ã‚’å„ªå…ˆçš„ã«æ¤œå‡º
            - éŸ³å£°ã®è‡ªç„¶ãªåŒºåˆ‡ã‚Šã¨ãƒ†ã‚­ã‚¹ãƒˆã®æ–‡æ³•çš„åŒºåˆ‡ã‚Šã‚’ä¸¡æ–¹è€ƒæ…®ã™ã‚‹

            **å“è³ªåŸºæº–ï¼ˆ80ç‚¹ãƒ¬ãƒ™ãƒ« - å®Ÿç”¨çš„ãªæ”¹å–„ç›®æ¨™ï¼‰**:
            - **æ¥µç«¯ãªã‚¢ãƒ³ãƒãƒ©ãƒ³ã‚¹ã®å›é¿**: 1ç§’ã‚ãŸã‚Š5æ–‡å­—æœªæº€ã¾ãŸã¯25æ–‡å­—è¶…éã‚’é¿ã‘ã‚‹
            - **æœ€çŸ­è¡¨ç¤ºæ™‚é–“**: 0.8ç§’ä»¥ä¸Šï¼ˆã‚ã¾ã‚Šã«çŸ­ã™ãã‚‹å­—å¹•ã‚’å›é¿ï¼‰
            - **æœ€é•·è¡¨ç¤ºæ™‚é–“**: 8ç§’ä»¥å†…ï¼ˆç•°å¸¸ã«é•·ã„å­—å¹•ã‚’å›é¿ï¼‰
            - **é‡å¤§ãªå•é¡Œã®ä¿®æ­£**: æ˜ã‚‰ã‹ã«èª­ã‚ãªã„ãƒ»ä¸è‡ªç„¶ãªã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã¿ä¿®æ­£
            - **è¨±å®¹ç¯„å›²**: å®Œç’§ã§ãªãã¦ã‚‚èª­ã‚ã‚‹ç¯„å›²ã§ã‚ã‚Œã°è¨±å®¹

            **ä¿®æ­£å¯¾è±¡ï¼ˆé‡å¤§ãªå•é¡Œã®ã¿ï¼‰**:
            - **æ¥µç«¯ãªçŸ­æ™‚é–“ãƒ»é•·æ–‡**: 0.5ç§’ã§20æ–‡å­—ä»¥ä¸Šãªã©æ˜ã‚‰ã‹ã«èª­ã‚ãªã„å ´åˆ
            - **æ¥µç«¯ãªé•·æ™‚é–“ãƒ»çŸ­æ–‡**: 6ç§’ä»¥ä¸Šã§1-2æ–‡å­—ãªã©æ˜ã‚‰ã‹ã«ç„¡é§„ãªå ´åˆ
            - **å“è³ªåˆ¤å®š**: ã€Œè¦èª¿æ•´ã€ãƒ¬ãƒ™ãƒ«ã§ã¯ãªãã€Œä¿®æ­£å¿…é ˆã€ãƒ¬ãƒ™ãƒ«ã®ã¿å¯¾è±¡
            - **æŸ”è»Ÿãªå¯¾å¿œ**: æ–‡è„ˆã‚„èª­ã¿ã‚„ã™ã•ã‚’å„ªå…ˆã—ã€æ•°å€¤ã«ã“ã ã‚ã‚Šã™ããªã„

            **å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆå®Ÿç”¨é‡è¦–ï¼‰**:
            1. **éŸ³å£°åˆ†æ**: ffmpegã§éŸ³å£°æ³¢å½¢ã‚’åˆ†æã€0.5ç§’ä»¥ä¸Šã®ç„¡éŸ³åŒºé–“ã®ã¿æ¤œå‡º
            2. **ãƒ†ã‚­ã‚¹ãƒˆåˆ†å‰²**: æ—¥æœ¬èªæ–‡æ³•ã«åŸºã¥ãåˆ†å‰²ï¼ˆå¥ç‚¹å„ªå…ˆã€èª­ç‚¹ã¯è£œåŠ©ï¼‰
            3. **ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒãƒƒãƒ”ãƒ³ã‚°**: åˆ†å‰²ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’éŸ³å£°ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«é©åˆ‡ã«ãƒãƒƒãƒ”ãƒ³ã‚°
            4. **SRTç”Ÿæˆ**: æ¨™æº–SRTå½¢å¼ã§å­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            5. **å“è³ªãƒã‚§ãƒƒã‚¯**: æ¥µç«¯ãªå•é¡Œï¼ˆèª­ã‚ãªã„å­—å¹•ï¼‰ãŒã‚ã‚‹ã‹ã®ã¿ãƒã‚§ãƒƒã‚¯
            6. **é‡å¤§ãªå•é¡Œã®ã¿ä¿®æ­£**: æ˜ã‚‰ã‹ã«å•é¡Œã®ã‚ã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã¿å¯¾è±¡
            7. **å®Ÿç”¨åˆ¤å®š**: 80ç‚¹ãƒ¬ãƒ™ãƒ«ã®å“è³ªã§ååˆ†ã¨åˆ¤æ–­ã™ã‚Œã°å®Œäº†
            8. **æœ€çµ‚å‡ºåŠ›**: å®Ÿç”¨çš„ãªå“è³ªã®SRTãƒ•ã‚¡ã‚¤ãƒ«

            **ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹ï¼ˆé‡å¤§ãªå•é¡Œã®ã¿ï¼‰**:
            - 0.3ç§’/30æ–‡å­—ä»¥ä¸Š â†’ æ˜ã‚‰ã‹ã«èª­ã‚ãªã„å ´åˆã®ã¿åˆ†å‰²
            - 8ç§’ä»¥ä¸Š/1-2æ–‡å­— â†’ æ˜ã‚‰ã‹ã«ç„¡é§„ãªå ´åˆã®ã¿çµ±åˆ
            - 0.5ç§’/40æ–‡å­—ä»¥ä¸Š â†’ ç‰©ç†çš„ã«èª­ã‚ãªã„å ´åˆã®ã¿èª¿æ•´

            **å®Ÿç”¨çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: å®Œç’§ã‚’æ±‚ã‚ãšã€è¦–è´è€…ãŒååˆ†èª­ã‚ã‚‹å“è³ªï¼ˆ80ç‚¹ãƒ¬ãƒ™ãƒ«ï¼‰ã‚’ç›®æ¨™ã¨ã™ã‚‹ã€‚ç´°ã‹ã„èª¿æ•´ã‚ˆã‚Šå…¨ä½“ã®èª­ã¿ã‚„ã™ã•ã‚’é‡è¦–ã€‚å¥èª­ç‚¹ã§ã®ä¸é©åˆ‡ãªåˆ†å‰²ã‚’é¿ã‘ã€æ—¥æœ¬èªã¨ã—ã¦è‡ªç„¶ãªå­—å¹•ã‚’ä½œæˆã™ã‚‹ã€‚

            **æˆæœç‰©ï¼ˆã“ã®2ã¤ã®ã¿ä½œæˆã™ã‚‹ã“ã¨ï¼‰**:
            1. $ANALYSIS_DIR/subtitle.srt - SRTå½¢å¼å­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ80ç‚¹ãƒ¬ãƒ™ãƒ«ã®å®Ÿç”¨å“è³ªï¼‰
            2. $ANALYSIS_DIR/analysis-report.md - è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆä¿®æ­£å±¥æ­´å«ã‚€ï¼‰

            å®Ÿéš›ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ãã£ã¡ã‚Šåˆã‚ã›ã‚‹ã“ã¨ãŒæœ€é‡è¦ã§ã™ã€‚"
          
          echo "ğŸš€ Starting Audio Analysis Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --max-turns 60 \
            --verbose \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          echo "::endgroup::"

      - name: Mark analysis complete
        id: analysis-complete
        run: |
          ANALYSIS_DIR="${{ inputs.folder-name }}/subtitle-analysis-${{ inputs.video_index }}"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "$ANALYSIS_DIR/subtitle.srt" ]; then
            echo "âœ… SRTå­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†"
            
            # SRTãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            echo "ğŸ“‹ SRT file contents:"
            cat "$ANALYSIS_DIR/subtitle.srt"
            
            # SRTã®å†…å®¹ã‚’GitHub Outputã«è¨­å®š
            SUBTITLE_SRT_CONTENT=$(cat "$ANALYSIS_DIR/subtitle.srt" | base64 -w 0)
            echo "subtitle-srt-content=$SUBTITLE_SRT_CONTENT" >> $GITHUB_OUTPUT
            echo "completed=true" >> $GITHUB_OUTPUT
            
            # ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°ã®è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã‚‚ç„¡è¦–ï¼‰
            SEGMENT_COUNT=$(grep -c "^[0-9]" "$ANALYSIS_DIR/subtitle.srt" 2>/dev/null || echo "unknown")
            echo "::notice::å­—å¹•ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°: $SEGMENT_COUNT"
            
          else
            echo "::error::âŒ SRTå­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "completed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Commit analysis results
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No analysis files to commit"
          else
            git commit -m "ğŸ“Š Add lipsync video subtitle analysis: ${{ inputs.concept }} (video-${{ inputs.video_index }})
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi