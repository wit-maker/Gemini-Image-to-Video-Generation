name: module-image-generation-kc-t2i-fal-imagen4-fast-gca

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      image-prompt:
        description: 'ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        required: true
        type: string
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      video_index:
        description: 'å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      image-url:
        description: 'ç”»åƒURL'
        value: ${{ jobs.image-generation.outputs.image-url }}
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.image-generation.outputs.completed }}
    secrets:
      gemini_api_key:
        description: 'Gemini API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  image-generation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      image-url: ${{ steps.verify.outputs.image-url }}
      completed: ${{ steps.verify.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
          
      - name: ğŸ–¼ï¸ ç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Imagen4 Fast)
        id: generate
        uses: google-gemini/gemini-cli-action@main
        with:
          GEMINI_API_KEY: ${{ secrets.gemini_api_key }}
          prompt: |
            ğŸ–¼ï¸ **ç”»åƒç”Ÿæˆã‚¿ã‚¹ã‚¯**
            
            **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: ${{ inputs.image-prompt }}
            
            **æ‰‹é †**:
            1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ: 
               ```bash
               mkdir -p ${{ inputs.folder-name }}/images-${{ inputs.video_index }}
               ```
            
            2. **é‡è¦**: kamuicodeã®æ­£ã—ã„æ‰‹é †ã§t2i-fal-imagen4-fastã‚’ä½¿ç”¨:
               - `mcp__t2i-fal-imagen4-fast__imagen4_fast_submit` ã§ç”»åƒç”Ÿæˆé–‹å§‹
               - `mcp__t2i-fal-imagen4-fast__imagen4_fast_status` ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª  
               - `mcp__t2i-fal-imagen4-fast__imagen4_fast_result` ã§çµæœå–å¾—ï¼ˆURLã®ã¿ï¼‰
            
            3. **é‡è¦**: MCPã‚µãƒ¼ãƒãƒ¼ãŒcurlã‚³ãƒãƒ³ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹ãŒã€**å®Ÿè¡Œã¯ã•ã‚Œã¦ã„ãªã„**
               - "Download command: curl -o ..." ã¯ææ¡ˆã§ã‚ã‚Šã€å®Ÿè¡Œæ¸ˆã¿ã§ã¯ãªã„
               - å¿…ãšè¡¨ç¤ºã•ã‚ŒãŸcurlã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿéš›ã«å®Ÿè¡Œã™ã‚‹ã“ã¨
            
            4. **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ**: 
               - MCPã‚µãƒ¼ãƒãƒ¼ãŒè¡¨ç¤ºã™ã‚‹curlã‚³ãƒãƒ³ãƒ‰ã¯ç„¡è¦–
               - çµ¶å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ:
               ```bash
               curl -L -o "$(pwd)/${{ inputs.folder-name }}/images-${{ inputs.video_index }}/image.png" "[resultãƒ„ãƒ¼ãƒ«ã§å–å¾—ã—ãŸç”»åƒURL]"
               ls -la "$(pwd)/${{ inputs.folder-name }}/images-${{ inputs.video_index }}/image.png"
               ```
            
            5. **ç”»åƒURLä¿å­˜ï¼ˆå¿…é ˆï¼‰**:
               - **é‡è¦**: å–å¾—ã—ãŸç”»åƒURLã‚’å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹ã“ã¨:
               ```bash
               echo "[resultãƒ„ãƒ¼ãƒ«ã§å–å¾—ã—ãŸç”»åƒURL]" > "${{ inputs.folder-name }}/images-${{ inputs.video_index }}/image-url.txt"
               cat "${{ inputs.folder-name }}/images-${{ inputs.video_index }}/image-url.txt"
               ```
            
            **é‡è¦**: 
            - MCPã‚µãƒ¼ãƒãƒ¼ã¯curlã‚³ãƒãƒ³ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹ã ã‘ï¼ˆå®Ÿè¡Œã—ãªã„ï¼‰
            - å¿…ãšå®Ÿéš›ã«curlã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            - ãƒ•ã‚¡ã‚¤ãƒ«åã¯image.pngã«çµ±ä¸€ï¼ˆæ‹¡å¼µå­æ³¨æ„ï¼‰
            
      - name: Verify image generation
        id: verify
        run: |
          FOLDER_NAME="${{ inputs.folder-name }}"
          VIDEO_INDEX="${{ inputs.video_index }}"
          IMAGES_DIR="$FOLDER_NAME/images-${VIDEO_INDEX}"
          IMAGE_PATH="$IMAGES_DIR/image.png"
          IMAGE_URL_FILE="$IMAGES_DIR/image-url.txt"
          
          echo "ğŸ” Checking image generation results..."
          echo "Expected image path: $IMAGE_PATH"
          echo "Expected URL file: $IMAGE_URL_FILE"
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ç¢ºèª
          echo "Directory structure:"
          ls -la "$FOLDER_NAME/" || echo "Folder not found: $FOLDER_NAME"
          ls -la "$IMAGES_DIR/" || echo "Images folder not found: $IMAGES_DIR"
          
          if [ -f "$IMAGE_PATH" ]; then
            IMAGE_SIZE=$(stat -c%s "$IMAGE_PATH" 2>/dev/null || stat -f%z "$IMAGE_PATH" 2>/dev/null || echo "unknown")
            echo "âœ… Image generated successfully: $IMAGE_PATH ($IMAGE_SIZE bytes)"
            
            # ç”»åƒURLã®ç¢ºèªã¨å‡ºåŠ›è¨­å®š
            if [ -f "$IMAGE_URL_FILE" ]; then
              IMAGE_URL=$(cat "$IMAGE_URL_FILE")
              echo "âœ… Image URL found: $IMAGE_URL"
              echo "image-url=$IMAGE_URL" >> $GITHUB_OUTPUT
            else
              echo "âŒ Image URL file not found: $IMAGE_URL_FILE"
              exit 1
            fi
          else
            echo "âŒ Image not found at expected path: $IMAGE_PATH"
            echo "Available files in images directory:"
            find "$FOLDER_NAME" -type f -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" || echo "No image files found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          
      - name: Commit generated image
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No image files to commit"
          else
            git commit -m "ğŸ–¼ï¸ Add generated Imagen4 image: ${{ inputs.concept }}
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi