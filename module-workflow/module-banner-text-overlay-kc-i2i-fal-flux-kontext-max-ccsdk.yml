name: module-banner-text-overlay-kc-i2i-fal-flux-kontext-max-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒãƒŠãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      text_content:
        description: 'ç”»åƒã«è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå¤‰æ›´ç¦æ­¢ï¼‰'
        required: true
        type: string
      image-url:
        description: 'ãƒ™ãƒ¼ã‚¹ç”»åƒã®Google URL'
        required: true
        type: string
      text-layout-strategy:
        description: 'ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥'
        required: true
        type: string
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      banner_index:
        description: 'ãƒãƒŠãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.text-overlay.outputs.completed }}
      image-url:
        description: 'å®Œæˆã—ãŸãƒãƒŠãƒ¼ç”»åƒã®URL'
        value: ${{ jobs.text-overlay.outputs.image-url }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  text-overlay:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      completed: ${{ steps.overlay.outputs.completed }}
      image-url: ${{ steps.overlay.outputs.image-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ãƒãƒŠãƒ¼ãƒ†ã‚­ã‚¹ãƒˆåˆæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Flux Kontext Max)
        id: overlay
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ¨ Banner Text Overlay Agent Execution (Flux Kontext Max)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_CONCEPT="${{ inputs.concept }}"
          USER_TEXT_CONTENT="${{ inputs.text_content }}"
          BASE_IMAGE_URL="${{ inputs.image-url }}"
          TEXT_LAYOUT_STRATEGY="${{ inputs.text-layout-strategy }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          BANNER_INDEX="${{ inputs.banner_index }}"
          BANNERS_DIR="$FOLDER_NAME/banners-${BANNER_INDEX}"
          
          echo "User concept: $USER_CONCEPT"
          echo "User text content: $USER_TEXT_CONTENT"
          echo "Base image URL: $BASE_IMAGE_URL"
          echo "Text layout strategy: $TEXT_LAYOUT_STRATEGY"
          echo "Banner index: $BANNER_INDEX"
          echo "Target folder: $BANNERS_DIR"
          
          # ãƒãƒŠãƒ¼ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$BANNERS_DIR" ]; then
            mkdir -p "$BANNERS_DIR"
            echo "ğŸ“ Created banners folder: $BANNERS_DIR"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # MCPè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "âœ… MCP config file exists at: $MCP_CONFIG_ABS_PATH"
          else
            echo "âŒ MCP config file not found at: $MCP_CONFIG_ABS_PATH"
            exit 1
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ä»¥ä¸‹ã®æŒ‡å®šãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸€å­—ä¸€å¥å¤‰æ›´ã›ãšã«ãƒ™ãƒ¼ã‚¹ç”»åƒã«åˆæˆã—ã¦ãã ã•ã„ã€‚

          **é‡è¦ - åˆ©ç”¨å¯èƒ½ãƒ„ãƒ¼ãƒ«**:
          - mcp__i2i-fal-flux-kontext-max__flux_kontext_submit
          - mcp__i2i-fal-flux-kontext-max__flux_kontext_status
          - mcp__i2i-fal-flux-kontext-max__flux_kontext_result

          **çµ¶å¯¾ã«å¤‰æ›´ç¦æ­¢ã®ãƒ†ã‚­ã‚¹ãƒˆ**: '$USER_TEXT_CONTENT'
          **ãƒ™ãƒ¼ã‚¹ç”»åƒURL**: $BASE_IMAGE_URL
          **ãƒãƒŠãƒ¼ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $USER_CONCEPT
          **ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæˆ¦ç•¥**: $TEXT_LAYOUT_STRATEGY

          **æœ€é‡è¦åˆ¶ç´„**:
          - ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã€Œ$USER_TEXT_CONTENTã€ã¯çµ¶å¯¾ã«å¤‰æ›´ç¦æ­¢
          - ã‚¹ãƒšãƒ«ä¿®æ­£ãƒ»ç¿»è¨³ãƒ»æ„è¨³ãƒ»æ–‡å­—è¿½åŠ ãƒ»å‰Šé™¤ã¯ä¸€åˆ‡ç¦æ­¢
          - æ–‡å­—ã®å¤§æ–‡å­—å°æ–‡å­—å¤‰æ›ã‚‚ç¦æ­¢
          - å¥èª­ç‚¹ãƒ»è¨˜å·ã®å¤‰æ›´ã‚‚ç¦æ­¢
          - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»ãƒ•ã‚©ãƒ³ãƒˆãƒ»è‰²ãƒ»ã‚µã‚¤ã‚ºãƒ»ä½ç½®ã®ã¿èª¿æ•´å¯èƒ½

          **å®Ÿè¡Œæ‰‹é †**:
          1. mcp__i2i-fal-flux-kontext-max__flux_kontext_submit ãƒ„ãƒ¼ãƒ«ã§ãƒ†ã‚­ã‚¹ãƒˆåˆæˆã‚’é–‹å§‹
             - input_image_url: $BASE_IMAGE_URL
             - prompt: ã€Œãƒ†ã‚­ã‚¹ãƒˆ '$USER_TEXT_CONTENT' ã‚’ç”»åƒã«åˆæˆã—ã¦ãã ã•ã„ã€‚ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã¯ä¸€åˆ‡å¤‰æ›´ã›ãšã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ãƒ‡ã‚¶ã‚¤ãƒ³ã®ã¿æœ€é©åŒ–ã—ã¦ãã ã•ã„ã€‚$TEXT_LAYOUT_STRATEGYã€
          2. mcp__i2i-fal-flux-kontext-max__flux_kontext_status ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          3. mcp__i2i-fal-flux-kontext-max__flux_kontext_result ã§çµæœå–å¾—ã—ã¦Google URLã‚’å–å¾—
          4. **é‡è¦**: ç”Ÿæˆæ™‚ã«å–å¾—ã—ãŸGoogle URLã‚’ã€Œ$BANNERS_DIR/image-url.txtã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          5. å–å¾—ã—ãŸGoogle URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$BANNERS_DIR/image.pngã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜

          **ãƒ†ã‚­ã‚¹ãƒˆåˆæˆã®è©³ç´°æŒ‡ç¤º**:
          - ãƒ†ã‚­ã‚¹ãƒˆã€Œ$USER_TEXT_CONTENTã€ã®å†…å®¹ã¯çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„
          - $TEXT_LAYOUT_STRATEGY ã«åŸºã¥ã„ã¦é…ç½®ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ±ºå®š
          - èª­ã¿ã‚„ã™ã•ã‚’æœ€å¤§åŒ–ã™ã‚‹ãƒ•ã‚©ãƒ³ãƒˆé¸æŠ
          - èƒŒæ™¯ã¨ã®å¯¾æ¯”ã‚’è€ƒæ…®ã—ãŸè‰²é¸æŠ
          - ãƒãƒŠãƒ¼åºƒå‘Šã¨ã—ã¦åŠ¹æœçš„ãªè¦–è¦šã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ

          **å“è³ªè¦ä»¶**:
          - å•†ç”¨åˆ©ç”¨å¯èƒ½ãªé«˜å“è³ªãƒãƒŠãƒ¼
          - ãƒ†ã‚­ã‚¹ãƒˆã®è¦–èªæ€§ç¢ºä¿
          - ãƒ–ãƒ©ãƒ³ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã®èª¿å’Œ
          - æŒ‡å®šã•ã‚ŒãŸãƒãƒŠãƒ¼ã‚µã‚¤ã‚ºã«æœ€é©åŒ–

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - Google URLã®æœ‰åŠ¹æœŸé™ã¯ç´„1æ™‚é–“ã®ãŸã‚ã€ç”Ÿæˆå¾Œã™ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - å¿…ãšGoogleæä¾›ã®èªè¨¼æ¸ˆURLã‚’ä½¿ç”¨
          - ãƒãƒŠãƒ¼ç”»åƒã¯å¿…ãšã€Œ$BANNERS_DIRã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
          - ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œimage.pngã€ã¨ã™ã‚‹
          - **æœ€é‡è¦**: ç”Ÿæˆæ™‚ã®Google URLã‚’ã€Œ$BANNERS_DIR/image-url.txtã€ã«ä¿å­˜ã—ã€æ¬¡ã®ã‚¸ãƒ§ãƒ–ã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          - **ä¸¡æ–¹ã‚’å®Ÿè¡Œ**: â‘ Google URLã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ â‘¡Google URLã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜"
          
          echo "ğŸš€ Starting Banner Text Overlay Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__i2i-fal-flux-kontext-max__flux_kontext_submit,mcp__i2i-fal-flux-kontext-max__flux_kontext_status,mcp__i2i-fal-flux-kontext-max__flux_kontext_result,Bash" \
            --max-turns 40 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒãƒŠãƒ¼ã®ç¢ºèª
          echo ""
          echo "ğŸ¨ Checking generated banner..."
          if [ -d "$BANNERS_DIR" ]; then
            BANNER_COUNT=$(find "$BANNERS_DIR" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | wc -l)
            echo "::notice::ğŸ¨ Generated $BANNER_COUNT banner images"
            if [ "$BANNER_COUNT" -gt 0 ]; then
              # Google URLã‚’ç¢ºèªã—ã¦GitHub Outputã«è¨­å®š
              if [ -f "$BANNERS_DIR/image-url.txt" ]; then
                GOOGLE_IMAGE_URL=$(cat "$BANNERS_DIR/image-url.txt")
                echo "Google image URL: $GOOGLE_IMAGE_URL"
                echo "image-url=$GOOGLE_IMAGE_URL" >> $GITHUB_OUTPUT
              else
                echo "::warning::âš ï¸ Google image URL not found in file"
                echo "image-url=" >> $GITHUB_OUTPUT
              fi
            else
              echo "::error::âŒ No banner images were generated"
              exit 1
            fi
          else
            echo "::error::âŒ Banners directory not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push banner
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No banner files to commit"
          else
            git commit -m "Add generated banner with text overlay: ${{ inputs.concept }}

            Text: ${{ inputs.text_content }}

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi