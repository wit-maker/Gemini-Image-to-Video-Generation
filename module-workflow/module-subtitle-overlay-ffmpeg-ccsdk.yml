name: module-subtitle-overlay-ffmpeg-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      video-url:
        description: 'å…ƒå‹•ç”»URL'
        required: true
        type: string
      text-content:
        description: 'å­—å¹•ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹'
        required: true
        type: string
      subtitle-srt-content:
        description: 'SRTå­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹'
        required: true
        type: string
      target-language:
        description: 'å­—å¹•è¨€èª (japanese ã¾ãŸã¯ english)'
        required: false
        type: string
        default: 'japanese'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      video_index:
        description: 'å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      video-url:
        description: 'å­—å¹•ä»˜ãå‹•ç”»URL'
        value: ${{ jobs.subtitle-overlay.outputs.video-url }}
      completed:
        description: 'å‡¦ç†å®Œäº†ãƒ•ãƒ©ã‚°'
        value: ${{ jobs.subtitle-overlay.outputs.completed }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  subtitle-overlay:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      video-url: ${{ steps.subtitle-complete.outputs.video-url }}
      completed: ${{ steps.subtitle-complete.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-noto-cjk fonts-liberation
          
          echo "âœ… System dependencies installed successfully"
          
          # ffmpegã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
          echo "ğŸ“‹ FFmpeg version:"
          ffmpeg -version | head -5
          
          # ãƒ•ã‚©ãƒ³ãƒˆã®ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶™ç¶šï¼‰
          echo "ğŸ“‹ Available fonts:"
          fc-list | grep -i noto | head -5 || echo "Noto fonts not found"
          fc-list | grep -i liberation | head -3 || echo "Liberation fonts not found"
          fc-list | grep -i arial | head -3 || echo "Arial fonts not found (using Liberation instead)"
          
          echo "âœ… Font check completed"
      
      - name: ğŸ¬ å­—å¹•ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Claude Code SDK + ffmpeg)
        id: overlay-subtitles
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ¬ Subtitle Overlay Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_CONCEPT="${{ inputs.concept }}"
          VIDEO_URL="${{ inputs.video-url }}"
          TEXT_CONTENT="${{ inputs.text-content }}"
          SUBTITLE_SRT_CONTENT='${{ inputs.subtitle-srt-content }}'
          TARGET_LANGUAGE="${{ inputs.target-language }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          SUBTITLE_DIR="$FOLDER_NAME/subtitle-overlay-${{ inputs.video_index }}"
          VIDEO_INDEX="${{ inputs.video_index }}"
          
          echo "User concept: $USER_CONCEPT"
          echo "Video URL: $VIDEO_URL"
          echo "Target language: $TARGET_LANGUAGE"
          echo "Subtitle directory: $SUBTITLE_DIR"
          echo "Video index: $VIDEO_INDEX"
          
          # å­—å¹•ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p "$SUBTITLE_DIR"
          
          # SRTå­—å¹•ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆbase64ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼‰
          echo "$SUBTITLE_SRT_CONTENT" | base64 -d > "$SUBTITLE_DIR/subtitle.srt"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯ffmpegã‚’ä½¿ç”¨ã—ãŸå‹•ç”»å­—å¹•ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ã«å­—å¹•ã‚’æŒ¿å…¥ã—ã¦ãã ã•ã„ã€‚

          **å…¥åŠ›æƒ…å ±**:
          - **å‹•ç”»URL**: $VIDEO_URL
          - **SRTå­—å¹•ãƒ‡ãƒ¼ã‚¿**: å—ã‘å–ã£ãŸSRTå½¢å¼ã®å­—å¹•å†…å®¹
          - **å­—å¹•è¨€èª**: $TARGET_LANGUAGE
          - **å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: $SUBTITLE_DIR

          **é‡è¦**: å‹•ç”»URLãŒç©ºã¾ãŸã¯\"undefined\"ã®å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã—ã¦ãã ã•ã„

          **å®Ÿè¡Œæ‰‹é †**:

          1. **SRTå­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ**:
             - å—ã‘å–ã£ãŸSRTå­—å¹•ãƒ‡ãƒ¼ã‚¿ã‚’ $SUBTITLE_DIR/subtitle.srt ã«ä¿å­˜
             - SRTå½¢å¼ã®å¦¥å½“æ€§ã‚’ç¢ºèª

          2. **å‹•ç”»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**:
             ```bash
             cd $SUBTITLE_DIR
             wget \"$VIDEO_URL\" -O input-video.mp4
             
             # å‹•ç”»æƒ…å ±ã®ç¢ºèª
             ffprobe -v quiet -print_format json -show_format -show_streams input-video.mp4 > video-info.json
             ```

          3. **ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š**:
             - æ—¥æœ¬èªã®å ´åˆ: /usr/share/fonts/opentype/noto/NotoCJK-Regular.ttc ã¾ãŸã¯åˆ©ç”¨å¯èƒ½ãªCJKãƒ•ã‚©ãƒ³ãƒˆ
             - è‹±èªã®å ´åˆ: /usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf
             ```bash
             # åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚©ãƒ³ãƒˆã‚’ç¢ºèª
             fc-list | grep -i \"$TARGET_LANGUAGE == 'japanese' && 'noto\\|cjk' || 'liberation\\|arial'\"
             ```

          4. **ffmpegå­—å¹•ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å®Ÿè¡Œ**:
             SRTãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ffmpegã§å­—å¹•ã‚’åŸ‹ã‚è¾¼ã¿:
             ```bash
             # SRTãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ãŸå­—å¹•ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
             # FontSize=24: é©åˆ‡ãªå¯èª­æ€§ã‚’ç¢ºä¿ï¼ˆå¤§ãã™ããªã„ï¼‰
             # MarginV=50: ç”»é¢ä¸‹ã‹ã‚‰50ãƒ”ã‚¯ã‚»ãƒ«ä¸Šã«é…ç½®
             # Alignment=2: ä¸‹éƒ¨ä¸­å¤®é…ç½®
             # PrimaryColour=&Hffffff: ç™½æ–‡å­—
             # BackColour=&H80000000: åŠé€æ˜é»’èƒŒæ™¯
             # Outline=2,OutlineColour=&H000000: é»’ã„ç¸å–ã‚Š2px
             ffmpeg -i input-video.mp4 \\
               -vf \"subtitles=subtitle.srt:force_style='FontSize=24,PrimaryColour=&Hffffff,BackColour=&H80000000,Outline=2,OutlineColour=&H000000,Alignment=2,MarginV=50'\" \\
               -c:a copy \\
               video.mp4
             ```

          5. **å“è³ªç¢ºèª**:
             ```bash
             # å‡ºåŠ›å‹•ç”»ã®ç¢ºèª
             ffprobe video.mp4
             
             # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨é•·ã•ã®ç¢ºèª
             ls -lh video.mp4
             
             # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
             echo \"SRTå­—å¹•ä»˜ãå‹•ç”»ç”Ÿæˆå®Œäº†\" > subtitle-overlay-log.txt
             ```

          **é‡è¦ãªæŠ€è¡“ãƒã‚¤ãƒ³ãƒˆ**:
          - SRTãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ffmpegã®subtitlesãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§å‡¦ç†
          - æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
          - **å­—å¹•ã‚µã‚¤ã‚º**: FontSize=24ã§é©åˆ‡ãªå¯èª­æ€§ã‚’ç¢ºä¿ï¼ˆå¤§ãã™ããªã„ï¼‰
          - **å­—å¹•ä½ç½®**: ç”»é¢ä¸‹éƒ¨ä¸­å¤®ã€ä¸‹ã‹ã‚‰50ãƒ”ã‚¯ã‚»ãƒ«ä¸Šã«é…ç½®ï¼ˆAlignment=2, MarginV=50ï¼‰
          - **è¦–èªæ€§å‘ä¸Š**: ç™½æ–‡å­—ã€åŠé€æ˜é»’èƒŒæ™¯ã€é»’ã„ç¸å–ã‚Š2pxã§è¦–èªæ€§ã‚’æœ€å¤§åŒ–
          - éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ãã®ã¾ã¾ä¿æŒ (-c:a copy)
          - **æ¨™æº–çš„ãªSRTå‡¦ç†**: ffmpegã®æ¨™æº–å­—å¹•å‡¦ç†æ©Ÿèƒ½ã‚’æ´»ç”¨

          **ã‚¨ãƒ©ãƒ¼å‡¦ç†**:
          - å‹•ç”»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
          - SRTãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
          - ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
          - ffmpegå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
          
          **å‡ºåŠ›è¦æ±‚**:
          1. å­—å¹•ä»˜ãå‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ« (video.mp4) - ç›´æ¥ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã§å‡ºåŠ›ã™ã‚‹ã“ã¨
          2. å‡¦ç†ãƒ­ã‚° (subtitle-overlay-log.txt)"
          
          echo "ğŸš€ Starting Subtitle Overlay Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --max-turns 40 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          echo "::endgroup::"

      - name: Mark subtitle overlay complete
        id: subtitle-complete
        run: |
          SUBTITLE_DIR="${{ inputs.folder-name }}/subtitle-overlay-${{ inputs.video_index }}"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ğŸ“‹ Checking generated subtitle overlay files..."
          if [ -d "$SUBTITLE_DIR" ]; then
            echo "::notice::ğŸ“ Subtitle overlay directory contents:"
            ls -la "$SUBTITLE_DIR"
            
            # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -f "$SUBTITLE_DIR/video.mp4" ]; then
              echo "âœ… Found: video.mp4"
              echo "video-url=./$SUBTITLE_DIR/video.mp4" >> $GITHUB_OUTPUT
              echo "completed=true" >> $GITHUB_OUTPUT
              
            else
              echo "::error::âŒ Missing required file: video.mp4"
              echo "completed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
          else
            echo "::error::âŒ Subtitle overlay directory not found"
            echo "completed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Commit subtitle overlay files
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/subtitle-overlay-${{ inputs.video_index }}/
          if git diff --cached --quiet; then
            echo "No subtitle overlay files to commit"
          else
            git commit -m "ğŸ¬ Add subtitle overlay: ${{ inputs.concept }} (video-${{ inputs.video_index }})

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi