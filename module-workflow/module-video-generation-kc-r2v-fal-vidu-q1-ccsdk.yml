name: module-video-generation-kc-r2v-fal-vidu-q1-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      video-prompt:
        description: 'å‹•ç”»ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        required: true
        type: string
      image-url:
        description: 'ç”»åƒURL'
        required: true
        type: string
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      video_index:
        description: 'å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      video-url:
        description: 'å‹•ç”»URL'
        value: ${{ jobs.video-generation.outputs.video-url }}
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.video-generation.outputs.completed }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  video-generation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      video-url: ${{ steps.video.outputs.video-url }}
      completed: ${{ steps.video.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: å‹•ç”»ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Vidu Q1)
        id: video
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ¬ Video Generation Agent Execution (Vidu Q1)"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FOLDER_NAME="${{ inputs.folder-name }}"
          VIDEO_INDEX="${{ inputs.video_index }}"
          VIDEOS_DIR="$FOLDER_NAME/videos-${VIDEO_INDEX}"
          USER_CONCEPT="${{ inputs.concept }}"
          VIDEO_PROMPT="${{ inputs.video-prompt }}"
          GOOGLE_IMAGE_URL="${{ inputs.image-url }}"
          
          echo "Video index: $VIDEO_INDEX"
          echo "Videos folder: $VIDEOS_DIR"
          
          # å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$VIDEOS_DIR" ]; then
            mkdir -p "$VIDEOS_DIR"
            echo "ğŸ“ Created videos folder: $VIDEOS_DIR"
          fi
          
          # Googleç”»åƒURLã®ç¢ºèª
          if [ -z "$GOOGLE_IMAGE_URL" ]; then
            echo "::error::âŒ Google image URL not provided from previous job"
            exit 1
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          # å‹•ç”»ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨
          FINAL_VIDEO_PROMPT="$VIDEO_PROMPT"
          
          PROMPT="ä»¥ä¸‹ã®Googleç”»åƒURLã‚’ä½¿ç”¨ã—ã¦Vidu Q1ã§å‚ç…§å‹•ç”»ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          **ç”»åƒURL**: $GOOGLE_IMAGE_URL
          **å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤º**: $USER_CONCEPT
          **ç”»åƒèªè­˜ã«ã‚ˆã‚‹æœ€é©åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $FINAL_VIDEO_PROMPT

          **å®Ÿè¡Œæ‰‹é †**:
          1. æä¾›ã•ã‚ŒãŸGoogleç”»åƒURLï¼ˆ$GOOGLE_IMAGE_URLï¼‰ã‚’ä½¿ç”¨
          2. **æœ€é©åŒ–ã•ã‚ŒãŸå‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**ï¼ˆ$FINAL_VIDEO_PROMPTï¼‰ã‚’ä½¿ç”¨ã—ã¦Vidu Q1ã§å‹•ç”»ç”Ÿæˆ
          3. \`mcp__r2v-fal-vidu-q1__vidu_q1_submit\`ãƒ„ãƒ¼ãƒ«ã§å‹•ç”»ç”Ÿæˆã‚’é–‹å§‹ï¼ˆç”»åƒURLã‚’ç›´æ¥æŒ‡å®šï¼‰
          4. \`mcp__r2v-fal-vidu-q1__vidu_q1_status\`ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼ˆå‹•ç”»ç”Ÿæˆã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ã€é©åº¦ãªé–“éš”ã‚’ç©ºã‘ã¦ç¢ºèªï¼‰
          5. Bashãƒ„ãƒ¼ãƒ«ã§ \`sleep 60\` ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰å†åº¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼ˆå¿…è¦ã«å¿œã˜ã¦è¤‡æ•°å›ï¼‰
          6. \`mcp__r2v-fal-vidu-q1__vidu_q1_result\`ã§çµæœå–å¾—ã—ã¦å‹•ç”»URLã‚’å–å¾—
          7. **å¿…é ˆ**: å–å¾—ã—ãŸå‹•ç”»URLã‚’Bashãƒ„ãƒ¼ãƒ«ã§ã€Œ$VIDEOS_DIR/video.mp4ã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¿å­˜
          8. **å¿…é ˆ**: å‹•ç”»URLã‚’ã€Œ$VIDEOS_DIR/video-url.txtã€ã«ä¿å­˜
          9. **ç¢ºèª**: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã—ãŸã“ã¨ã‚’ç¢ºèªã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’è¡¨ç¤º

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - æä¾›ã•ã‚ŒãŸç”»åƒURLï¼ˆ$GOOGLE_IMAGE_URLï¼‰ã‚’ãã®ã¾ã¾ä½¿ç”¨
          - URLã®æœ‰åŠ¹æœŸé™ã¯ç´„1æ™‚é–“ã®ãŸã‚ã€ç”Ÿæˆå¾Œã™ãã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          - **å‹•ç”»ã¯å¿…ãšã€Œ$VIDEOS_DIRã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜**
          - **ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œvideo.mp4ã€ã¨ã™ã‚‹**
          - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯ä½¿ç”¨ç¦æ­¢ï¼ˆç”»åƒURLã®ã¿ä½¿ç”¨ï¼‰
          - **å‹•ç”»ç”Ÿæˆã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã®é–“ã«é©åº¦ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ60ç§’ç¨‹åº¦ï¼‰ã‚’å…¥ã‚Œã¦ãã ã•ã„
          - **å¿è€å¼·ã**: ç”Ÿæˆå®Œäº†ã¾ã§è¤‡æ•°å›ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™
          - **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¿…é ˆ**: å‹•ç”»URLã‚’å–å¾—ã—ãŸã‚‰å¿…ãšwgetã‚„curlã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          - **ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª**: ä¿å­˜å¾Œã«ls -lhã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¢ºèªã—ã€0ãƒã‚¤ãƒˆã§ãªã„ã“ã¨ã‚’ç¢ºèª"
          
          echo "ğŸš€ Starting Video Generation Agent Claude Code CLI..."
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --mcp-config="$MCP_CONFIG_ABS_PATH" \
            --allowedTools "mcp__r2v-fal-vidu-q1__vidu_q1_submit,mcp__r2v-fal-vidu-q1__vidu_q1_status,mcp__r2v-fal-vidu-q1__vidu_q1_result,Bash" \
            --max-turns 25 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸå‹•ç”»ã®ç¢ºèª
          echo ""
          echo "ğŸ¬ Checking generated videos..."
          if [ -d "$VIDEOS_DIR" ]; then
            VIDEO_COUNT=$(find "$VIDEOS_DIR" -name "*.mp4" -o -name "*.mov" -o -name "*.avi" | wc -l)
            echo "::notice::ğŸ¬ Generated $VIDEO_COUNT videos"
            if [ "$VIDEO_COUNT" -gt 0 ]; then
              # å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
              for video_file in $(find "$VIDEOS_DIR" -name "*.mp4" -o -name "*.mov" -o -name "*.avi" | head -3); do
                if [ -f "$video_file" ]; then
                  VIDEO_SIZE=$(stat -c%s "$video_file" 2>/dev/null || stat -f%z "$video_file" 2>/dev/null || echo "0")
                  echo "::notice::ğŸ“¹ Video file: $video_file (${VIDEO_SIZE} bytes)"
                  if [ "$VIDEO_SIZE" -eq 0 ]; then
                    echo "::error::âŒ Video file is empty: $video_file"
                    exit 1
                  fi
                fi
              done
              
              # å‹•ç”»URLãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªã¨å‡ºåŠ›è¨­å®š
              VIDEO_URL_FILE="$VIDEOS_DIR/video-url.txt"
              if [ -f "$VIDEO_URL_FILE" ]; then
                VIDEO_URL=$(cat "$VIDEO_URL_FILE")
                echo "âœ… Video URL found: $VIDEO_URL"
                echo "video-url=$VIDEO_URL" >> $GITHUB_OUTPUT
              else
                echo "âŒ Video URL file not found: $VIDEO_URL_FILE"
                echo "Creating empty URL file to continue workflow..."
                echo "" > "$VIDEO_URL_FILE"
              fi
            else
              echo "::error::âŒ No videos were generated - this is required for the workflow to succeed"
              exit 1
            fi
          else
            echo "::error::âŒ Videos directory not found - video generation failed"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push videos
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No videos to commit"
          else
            git commit -m "Add generated videos: ${{ inputs.concept }}"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi