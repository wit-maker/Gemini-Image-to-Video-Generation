name: module-news-planning-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¾ãŸã¯ãƒˆãƒ”ãƒƒã‚¯'
        required: true
        type: string
      news-content:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ãƒ‹ãƒ¥ãƒ¼ã‚¹å†…å®¹ï¼ˆãã®ã¾ã¾éŸ³å£°ç”Ÿæˆã«ä½¿ç”¨ï¼‰'
        required: true
        type: string
      target-language:
        description: 'ç¿»è¨³å…ˆè¨€èª (japanese ã¾ãŸã¯ english)'
        required: false
        type: string
        default: 'japanese'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      video_index:
        description: 'å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
      news-style:
        description: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆformal, casual, entertainmentï¼‰'
        required: false
        type: string
        default: 'formal'
      news-duration:
        description: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®é•·ã•ï¼ˆç§’ï¼‰'
        required: false
        type: string
        default: '60'
      anchor-type:
        description: 'ã‚¢ãƒ³ã‚«ãƒ¼ã®ã‚¿ã‚¤ãƒ—ï¼ˆprofessional, friendly, energeticï¼‰'
        required: false
        type: string
        default: 'professional'
      text-prompt:
        description: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ‹ãƒ¥ãƒ¼ã‚¹åŸç¨¿ï¼ˆæŒ‡å®šæ™‚ã¯news-contentã‚ˆã‚Šå„ªå…ˆï¼‰'
        required: false
        type: string
        default: ''
    outputs:
      planning-completed:
        description: 'ä¼ç”»å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.news-planning.outputs.planning-completed }}
      audio-prompt-1:
        description: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹åŸç¨¿ï¼ˆéŸ³å£°ç”Ÿæˆç”¨ï¼‰'
        value: ${{ jobs.news-planning.outputs.audio-prompt-1 }}
      audio-prompt-2:
        description: 'æœªä½¿ç”¨'
        value: ''
      audio-prompt-3:
        description: 'æœªä½¿ç”¨'
        value: ''
      audio-prompt-4:
        description: 'æœªä½¿ç”¨'
        value: ''
      audio-prompt-5:
        description: 'æœªä½¿ç”¨'
        value: ''
      audio-prompt-6:
        description: 'æœªä½¿ç”¨'
        value: ''
      audio-prompt-7:
        description: 'æœªä½¿ç”¨'
        value: ''
      audio-prompt-8:
        description: 'æœªä½¿ç”¨'
        value: ''
      image-prompt-1:
        description: 'ã‚¢ãƒ³ã‚«ãƒ¼ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.news-planning.outputs.image-prompt-1 }}
      image-prompt-2:
        description: 'æœªä½¿ç”¨'
        value: ''
      image-prompt-3:
        description: 'æœªä½¿ç”¨'
        value: ''
      image-prompt-4:
        description: 'æœªä½¿ç”¨'
        value: ''
      image-prompt-5:
        description: 'æœªä½¿ç”¨'
        value: ''
      image-prompt-6:
        description: 'æœªä½¿ç”¨'
        value: ''
      image-prompt-7:
        description: 'æœªä½¿ç”¨'
        value: ''
      image-prompt-8:
        description: 'æœªä½¿ç”¨'
        value: ''
      video-concept-1:
        description: 'ã‚¢ãƒ³ã‚«ãƒ¼å‹•ç”»ç”Ÿæˆç”¨ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        value: ${{ jobs.news-planning.outputs.video-concept-1 }}
      video-concept-2:
        description: 'æœªä½¿ç”¨'
        value: ''
      video-concept-3:
        description: 'æœªä½¿ç”¨'
        value: ''
      video-concept-4:
        description: 'æœªä½¿ç”¨'
        value: ''
      video-concept-5:
        description: 'æœªä½¿ç”¨'
        value: ''
      video-concept-6:
        description: 'æœªä½¿ç”¨'
        value: ''
      video-concept-7:
        description: 'æœªä½¿ç”¨'
        value: ''
      video-concept-8:
        description: 'æœªä½¿ç”¨'
        value: ''
      voice-settings:
        description: 'éŸ³å£°è¨­å®šï¼ˆJSONå½¢å¼ï¼‰'
        value: ${{ jobs.news-planning.outputs.voice-settings }}
      news-title:
        description: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ«'
        value: ${{ jobs.news-planning.outputs.news-title }}
      news-summary:
        description: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹è¦ç´„'
        value: ${{ jobs.news-planning.outputs.news-summary }}
      title-image-prompt:
        description: 'ã‚¿ã‚¤ãƒˆãƒ«èƒŒæ™¯ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.news-planning.outputs.title-image-prompt }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  news-planning:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      planning-completed: ${{ steps.planning.outputs.completed }}
      audio-prompt-1: ${{ steps.planning.outputs.audio-prompt-1 }}
      audio-prompt-2: ${{ steps.planning.outputs.audio-prompt-2 }}
      audio-prompt-3: ${{ steps.planning.outputs.audio-prompt-3 }}
      audio-prompt-4: ${{ steps.planning.outputs.audio-prompt-4 }}
      audio-prompt-5: ${{ steps.planning.outputs.audio-prompt-5 }}
      audio-prompt-6: ${{ steps.planning.outputs.audio-prompt-6 }}
      audio-prompt-7: ${{ steps.planning.outputs.audio-prompt-7 }}
      audio-prompt-8: ${{ steps.planning.outputs.audio-prompt-8 }}
      image-prompt-1: ${{ steps.planning.outputs.image-prompt-1 }}
      image-prompt-2: ${{ steps.planning.outputs.image-prompt-2 }}
      image-prompt-3: ${{ steps.planning.outputs.image-prompt-3 }}
      image-prompt-4: ${{ steps.planning.outputs.image-prompt-4 }}
      image-prompt-5: ${{ steps.planning.outputs.image-prompt-5 }}
      image-prompt-6: ${{ steps.planning.outputs.image-prompt-6 }}
      image-prompt-7: ${{ steps.planning.outputs.image-prompt-7 }}
      image-prompt-8: ${{ steps.planning.outputs.image-prompt-8 }}
      video-concept-1: ${{ steps.planning.outputs.video-concept-1 }}
      video-concept-2: ${{ steps.planning.outputs.video-concept-2 }}
      video-concept-3: ${{ steps.planning.outputs.video-concept-3 }}
      video-concept-4: ${{ steps.planning.outputs.video-concept-4 }}
      video-concept-5: ${{ steps.planning.outputs.video-concept-5 }}
      video-concept-6: ${{ steps.planning.outputs.video-concept-6 }}
      video-concept-7: ${{ steps.planning.outputs.video-concept-7 }}
      video-concept-8: ${{ steps.planning.outputs.video-concept-8 }}
      voice-settings: ${{ steps.planning.outputs.voice-settings }}
      news-title: ${{ steps.planning.outputs.news-title }}
      news-summary: ${{ steps.planning.outputs.news-summary }}
      title-image-prompt: ${{ steps.planning.outputs.title-image-prompt }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: ãƒ‹ãƒ¥ãƒ¼ã‚¹ä¼ç”»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ“° News Planning Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_CONCEPT="${{ inputs.concept }}"
          NEWS_CONTENT="${{ inputs.news-content }}"
          TARGET_LANGUAGE="${{ inputs.target-language }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          PLANNING_DIR="$FOLDER_NAME/planning"
          VIDEO_INDEX="${{ inputs.video_index }}"
          NEWS_STYLE="${{ inputs.news-style }}"
          NEWS_DURATION="${{ inputs.news-duration }}"
          ANCHOR_TYPE="${{ inputs.anchor-type }}"
          
          echo "User concept: $USER_CONCEPT"
          echo "News content: $NEWS_CONTENT"
          echo "Target language: $TARGET_LANGUAGE"
          echo "Planning folder: $PLANNING_DIR"
          echo "Video index: $VIDEO_INDEX"
          echo "News style: $NEWS_STYLE"
          echo "News duration: $NEWS_DURATION seconds"
          echo "Anchor type: $ANCHOR_TYPE"
          
          # ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p "$PLANNING_DIR"
          
          # ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç¢ºèª
          CUSTOM_TEXT_PROMPT=\"${{ inputs.text-prompt }}\"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯ãƒ—ãƒ­ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹åˆ¶ä½œãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã®ä¼ç”»ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒˆãƒ”ãƒƒã‚¯**: $USER_CONCEPT
          **ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ãƒ‹ãƒ¥ãƒ¼ã‚¹å†…å®¹**: $NEWS_CONTENT
          **ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $CUSTOM_TEXT_PROMPT
          **ç¿»è¨³å…ˆè¨€èª**: $TARGET_LANGUAGE
          **ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«**: $NEWS_STYLE
          **ãƒ‹ãƒ¥ãƒ¼ã‚¹é•·ã•**: $NEWS_DURATION ç§’
          **ã‚¢ãƒ³ã‚«ãƒ¼ã‚¿ã‚¤ãƒ—**: $ANCHOR_TYPE

          **ä½œæˆã™ã‚‹ã‚‚ã®**:

          1. **éŸ³å£°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹åŸç¨¿ï¼‰** ($PLANNING_DIR/audio-prompt-${VIDEO_INDEX}.txt)
             - **é‡è¦ãªæ¡ä»¶åˆ†å²**:
               * ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆ\"$CUSTOM_TEXT_PROMPT\" ãŒç©ºã§ãªã„å ´åˆï¼‰:
                 â†’ ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨
               * ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã®å ´åˆ:
                 â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ãƒ‹ãƒ¥ãƒ¼ã‚¹å†…å®¹ã€Œ$NEWS_CONTENTã€ã‚’ $TARGET_LANGUAGE ã«ç¿»è¨³ã—ã¦ä½¿ç”¨
             - é¸æŠã•ã‚ŒãŸå†…å®¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
             - ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯æ”¹è¡Œã‚’å«ã‚ãšã€1è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ä¿å­˜
             - ç¿»è¨³ãŒå¿…è¦ãªå ´åˆã¯è‡ªç„¶ã§æµæš¢ãªç¿»è¨³ã‚’å¿ƒãŒã‘ã‚‹
             - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡å®šã—ãŸåŸç¨¿ã®å†…å®¹ã‚’æ‹¡å¤§è§£é‡ˆã™ã‚‹ã“ã¨ãªãã€å¿ å®Ÿã«åæ˜ ã™ã‚‹ã“ã¨ã€‚

          2. **ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ** ($PLANNING_DIR/image-prompt-${VIDEO_INDEX}.txt)
             - æ—¥æœ¬äººå¥³æ€§ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ³ã‚«ãƒ¼ï¼ˆ$ANCHOR_TYPE ã‚¿ã‚¤ãƒ—ï¼‰
             - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå¥³æ€§ã‚‰ã—ã„æœè£…ï¼ˆã‚¹ãƒ¼ãƒ„ã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¹ï¼‰
             - æ—¥æœ¬ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¸ã‚ªã®èƒŒæ™¯
             - æ­£é¢å‘ãã€ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ã«é©ã—ãŸè¡¨æƒ…
             - é«˜å“è³ªã€ãƒ•ã‚©ãƒˆãƒªã‚¢ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯
             - æ—¥æœ¬äººã®ç‰¹å¾´ã‚’æŒã¤ç¾ã—ã„å¥³æ€§ã‚¢ãƒŠã‚¦ãƒ³ã‚µãƒ¼
             - è‹±èªã§ä½œæˆ

          3. **å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ** ($PLANNING_DIR/video-concept-${VIDEO_INDEX}.txt)
             - è‡ªç„¶ã«è©±ã—ã¦ã„ã‚‹æ§˜å­
             - é©åº¦ãªèº«æŒ¯ã‚Šæ‰‹æŒ¯ã‚Š
             - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªé›°å›²æ°—
             - ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ã«æœ€é©ãªå£ã®å‹•ã
             - è‹±èªã§ä½œæˆ

          4. **éŸ³å£°è¨­å®š** ($PLANNING_DIR/voice-settings.json)
             - æ—¥æœ¬äººå¥³æ€§ã‚¢ãƒŠã‚¦ãƒ³ã‚µãƒ¼ã®å£°ã§$ANCHOR_TYPE ã«åˆã£ãŸéŸ³å£°è¨­å®š
             - æ—¥æœ¬èªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã«é©ã—ãŸè©±é€Ÿ
             - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒˆãƒ¼ãƒ³ã¨æ„Ÿæƒ…ã®è¨­å®š
             - JSONå½¢å¼ã§ä½œæˆ
             ä¾‹: {\"voice_id\": \"Inspirational_girl\", \"pitch\": 1.2, \"language_boost\": \"Japanese\", \"emotion\": \"neutral\", \"speed\": 1.0}

          5. **ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ«** ($PLANNING_DIR/news-title.txt)
             - é­…åŠ›çš„ã§å†…å®¹ã‚’çš„ç¢ºã«è¡¨ã™ã‚¿ã‚¤ãƒˆãƒ«
             - 1è¡Œã§ç°¡æ½”ã«ï¼ˆ30æ–‡å­—ç¨‹åº¦ã¾ã§ï¼‰
             - è‹±èªã§ä½œæˆï¼ˆãƒãƒŠãƒ¼è¡¨ç¤ºç”¨ï¼‰

          6. **ãƒ‹ãƒ¥ãƒ¼ã‚¹è¦ç´„** ($PLANNING_DIR/news-summary.txt)
             - 3-5æ–‡ã§ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®è¦ç‚¹ã‚’ã¾ã¨ã‚ã‚‹

          7. **ã‚¿ã‚¤ãƒˆãƒ«èƒŒæ™¯ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ** ($PLANNING_DIR/title-image-prompt.txt)
             - ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºç”¨ã®èƒŒæ™¯ãƒ‡ã‚¶ã‚¤ãƒ³
             - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã®é›°å›²æ°—
             - ãƒ†ã‚­ã‚¹ãƒˆãŒèª­ã¿ã‚„ã™ã„èƒŒæ™¯è‰²ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³
             - $NEWS_STYLE ã«åˆã‚ã›ãŸãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆformal/casual/entertainmentï¼‰
             - è‹±èªã§ä½œæˆ

          8. **ä¼ç”»æ›¸** ($PLANNING_DIR/news-plan.md)
             - å…¨ä½“ã®ä¼ç”»å†…å®¹ã‚’Markdownå½¢å¼ã§ã¾ã¨ã‚ã‚‹
             - å„è¦ç´ ã®æ„å›³ã¨ç‹™ã„ã‚’èª¬æ˜

          **é‡è¦ãªæ³¨æ„ç‚¹**:
          - ãƒ‹ãƒ¥ãƒ¼ã‚¹åŸç¨¿ã¯$TARGET_LANGUAGEã§ä½œæˆ
          - ç”»åƒãƒ»å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯è‹±èªã§ä½œæˆ
          - **ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ«ã¯è‹±èªã§ä½œæˆ**ï¼ˆãƒãƒŠãƒ¼è¡¨ç¤ºç”¨ï¼‰
          - ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ã‚’å‰æã¨ã—ãŸå†…å®¹ã«ã™ã‚‹
          - $NEWS_STYLE ã¨ $ANCHOR_TYPE ã®ä¸€è²«æ€§ã‚’ä¿ã¤
          - **æ€§åˆ¥ãƒ»å›½ç±çµ±ä¸€**: ç”»åƒã€å‹•ç”»ã€éŸ³å£°ã™ã¹ã¦æ—¥æœ¬äººå¥³æ€§ã§çµ±ä¸€ã™ã‚‹ã“ã¨
          - å®Ÿéš›ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªä»•ä¸ŠãŒã‚Šã‚’ç›®æŒ‡ã™

          **GitHub Outputã®è¨­å®š**:
          å„ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå¾Œã€ä»¥ä¸‹ã®å½¢å¼ã§GitHub Outputsã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š
          - echo \"audio-prompt-${VIDEO_INDEX}=\$(cat $PLANNING_DIR/audio-prompt-${VIDEO_INDEX}.txt | tr '\n' ' ')\" >> \$GITHUB_OUTPUT
          - echo \"image-prompt-${VIDEO_INDEX}=\$(cat $PLANNING_DIR/image-prompt-${VIDEO_INDEX}.txt)\" >> \$GITHUB_OUTPUT
          - echo \"video-concept-${VIDEO_INDEX}=\$(cat $PLANNING_DIR/video-concept-${VIDEO_INDEX}.txt)\" >> \$GITHUB_OUTPUT
          - echo \"voice-settings=\$(cat $PLANNING_DIR/voice-settings.json | jq -c .)\" >> \$GITHUB_OUTPUT
          - echo \"news-title=\$(cat $PLANNING_DIR/news-title.txt)\" >> \$GITHUB_OUTPUT
          - echo \"news-summary=\$(cat $PLANNING_DIR/news-summary.txt | tr '\n' ' ')\" >> \$GITHUB_OUTPUT
          - echo \"title-image-prompt=\$(cat $PLANNING_DIR/title-image-prompt.txt)\" >> \$GITHUB_OUTPUT
          - echo \"completed=true\" >> \$GITHUB_OUTPUT"
          
          echo "ğŸš€ Starting News Planning Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --max-turns 40 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo ""
          echo "ğŸ“‹ Checking generated planning files..."
          if [ -d "$PLANNING_DIR" ]; then
            echo "::notice::ğŸ“ Planning directory contents:"
            ls -la "$PLANNING_DIR"
            
            # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            REQUIRED_FILES=(
              "audio-prompt-${VIDEO_INDEX}.txt"
              "image-prompt-${VIDEO_INDEX}.txt"
              "video-concept-${VIDEO_INDEX}.txt"
              "voice-settings.json"
              "news-title.txt"
              "news-summary.txt"
              "title-image-prompt.txt"
              "news-plan.md"
            )
            
            ALL_FILES_EXIST=true
            for file in "${REQUIRED_FILES[@]}"; do
              if [ ! -f "$PLANNING_DIR/$file" ]; then
                echo "::error::âŒ Missing required file: $file"
                ALL_FILES_EXIST=false
              else
                echo "âœ… Found: $file"
              fi
            done
            
            if [ "$ALL_FILES_EXIST" = false ]; then
              echo "::error::âŒ Not all required files were generated"
              exit 1
            fi
            
            # GitHub Outputsã®æ‰‹å‹•è¨­å®šï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè¨­å®šã—ã¦ã„ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            if [ -z "${AUDIO_PROMPT_OUTPUT:-}" ]; then
              echo "Setting GitHub Outputs manually..."
              echo "audio-prompt-${VIDEO_INDEX}=$(cat $PLANNING_DIR/audio-prompt-${VIDEO_INDEX}.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT
              echo "image-prompt-${VIDEO_INDEX}=$(cat $PLANNING_DIR/image-prompt-${VIDEO_INDEX}.txt)" >> $GITHUB_OUTPUT
              echo "video-concept-${VIDEO_INDEX}=$(cat $PLANNING_DIR/video-concept-${VIDEO_INDEX}.txt)" >> $GITHUB_OUTPUT
              if command -v jq >/dev/null 2>&1; then
                echo "voice-settings=$(cat $PLANNING_DIR/voice-settings.json | jq -c .)" >> $GITHUB_OUTPUT
              else
                echo "voice-settings=$(cat $PLANNING_DIR/voice-settings.json | tr -d '\n')" >> $GITHUB_OUTPUT
              fi
              echo "news-title=$(cat $PLANNING_DIR/news-title.txt)" >> $GITHUB_OUTPUT
              echo "news-summary=$(cat $PLANNING_DIR/news-summary.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT
              echo "title-image-prompt=$(cat $PLANNING_DIR/title-image-prompt.txt)" >> $GITHUB_OUTPUT
            fi
          else
            echo "::error::âŒ Planning directory not found"
            exit 1
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit planning files
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/planning/
          if git diff --cached --quiet; then
            echo "No planning files to commit"
          else
            git commit -m "Add news planning for: ${{ inputs.concept }}
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi