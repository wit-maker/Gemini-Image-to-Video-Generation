name: module-upload-fal-ccsdk

on:
  workflow_call:
    inputs:
      file-path:
        description: 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆç›¸å¯¾ãƒ‘ã‚¹ï¼‰'
        required: true
        type: string
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      output-filename:
        description: 'å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å'
        required: false
        type: string
        default: 'uploaded-url.txt'
      video_index:
        description: 'å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.upload-fal.outputs.completed }}
      fal-url:
        description: 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®FAL URL'
        value: ${{ jobs.upload-fal.outputs.fal-url }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      fal_key:
        description: 'FAL API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  upload-fal:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      completed: ${{ steps.upload-complete.outputs.completed }}
      fal-url: ${{ steps.upload-complete.outputs.fal-url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fal-client python-dotenv
      
      - name: ğŸ“¤ FALã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Claude Code SDK)
        id: upload-to-fal
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
          FAL_KEY: ${{ secrets.fal_key }}
        run: |
          echo "::group::ğŸ“¤ FAL Upload Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          FILE_PATH="${{ inputs.file-path }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          OUTPUT_FILENAME="${{ inputs.output-filename }}"
          VIDEO_INDEX="${{ inputs.video_index }}"
          IMAGES_DIR="$FOLDER_NAME/images-${VIDEO_INDEX}"
          LOCAL_IMAGE_DIR="$IMAGES_DIR/local-image-${VIDEO_INDEX}"
          
          echo "File path: $FILE_PATH"
          echo "Folder name: $FOLDER_NAME"
          echo "Output filename: $OUTPUT_FILENAME"
          echo "Video index: $VIDEO_INDEX"
          echo "Images dir: $IMAGES_DIR"
          echo "Local image dir: $LOCAL_IMAGE_DIR"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯FAL.aiãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’FAL.aiã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦URLã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚

          **å…¥åŠ›æƒ…å ±**:
          - **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: $FILE_PATH
          - **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€**: $FOLDER_NAME
          - **å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å**: $OUTPUT_FILENAME
          - **å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: $VIDEO_INDEX
          - **ç”»åƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: $IMAGES_DIR
          - **ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: $LOCAL_IMAGE_DIR
          - **FAL APIã‚­ãƒ¼**: ç’°å¢ƒå¤‰æ•° FAL_KEY ã«è¨­å®šæ¸ˆã¿

          **å®Ÿè¡Œæ‰‹é †**:

          1. **ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª**: 
             \`\`\`bash
             if [ -f \"$FILE_PATH\" ]; then
               echo \"âœ… ãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: $FILE_PATH\"
               ls -lh \"$FILE_PATH\"
             else
               echo \"âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãªã—: $FILE_PATH\"
               exit 1
             fi
             \`\`\`

          2. **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼**: 
             \`\`\`bash
             mkdir -p $LOCAL_IMAGE_DIR
             # å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
             cp \"$FILE_PATH\" \"$LOCAL_IMAGE_DIR/local-image.jpg\"
             echo \"âœ… ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒã‚³ãƒ”ãƒ¼å®Œäº†: $LOCAL_IMAGE_DIR/local-image.jpg\"
             \`\`\`

          3. **Pythonã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ**: 
             \`\`\`bash
             python3 -c 'import fal_client; url=fal_client.upload_file(\"$FILE_PATH\"); open(\"$LOCAL_IMAGE_DIR/$OUTPUT_FILENAME\", \"w\").write(url); print(\"Upload complete:\", url)'
             \`\`\`

          4. **çµæœã®ç¢ºèª**: 
             \`\`\`bash
             if [ -f \"$LOCAL_IMAGE_DIR/$OUTPUT_FILENAME\" ]; then
               echo \"âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†\"
               cat \"$LOCAL_IMAGE_DIR/$OUTPUT_FILENAME\"
             else
               echo \"âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—\"
               exit 1
             fi
             \`\`\`

          **é‡è¦ãªæŠ€è¡“ãƒã‚¤ãƒ³ãƒˆ**:
          - ç’°å¢ƒå¤‰æ•°FAL_KEYãŒè¨­å®šæ¸ˆã¿
          - fal_clientãŒè‡ªå‹•çš„ã«FAL_KEYã‚’ä½¿ç”¨
          - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨ã‚¿ã‚¤ãƒ—æƒ…å ±ã‚’è¡¨ç¤º
          - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°å‡ºåŠ›

          **å‡ºåŠ›è¦æ±‚**:
          1. ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« ($LOCAL_IMAGE_DIR/local-image.jpg) - å…ƒç”»åƒã®ã‚³ãƒ”ãƒ¼
          2. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰URLãƒ•ã‚¡ã‚¤ãƒ« ($LOCAL_IMAGE_DIR/$OUTPUT_FILENAME) - æœ€çµ‚çš„ãªFAL URLã‚’ä¿å­˜
          3. å‡¦ç†ãƒ­ã‚° (upload-log.txt)"
          
          echo "ğŸš€ Starting FAL Upload Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Bash,Write" \
            --max-turns 20 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          echo "::endgroup::"

      - name: Mark upload complete
        id: upload-complete
        run: |
          FOLDER_NAME="${{ inputs.folder-name }}"
          VIDEO_INDEX="${{ inputs.video_index }}"
          OUTPUT_FILENAME="${{ inputs.output-filename }}"
          IMAGES_DIR="$FOLDER_NAME/images-${VIDEO_INDEX}"
          LOCAL_IMAGE_DIR="$IMAGES_DIR/local-image-${VIDEO_INDEX}"
          LOCAL_IMAGE_FILE="$LOCAL_IMAGE_DIR/$OUTPUT_FILENAME"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ğŸ“‹ Checking uploaded files..."
          echo "Images dir: $IMAGES_DIR"
          echo "Local image dir: $LOCAL_IMAGE_DIR"
          echo "Local image file: $LOCAL_IMAGE_FILE"
          
          if [ -d "$LOCAL_IMAGE_DIR" ]; then
            echo "::notice::ğŸ“ Local image directory contents:"
            ls -la "$LOCAL_IMAGE_DIR"
            
            # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰URLãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -f "$LOCAL_IMAGE_FILE" ]; then
              echo "âœ… Found: $OUTPUT_FILENAME"
              FAL_URL=$(cat "$LOCAL_IMAGE_FILE")
              echo "ğŸ“ FAL URL: $FAL_URL"
              echo "fal-url=$FAL_URL" >> $GITHUB_OUTPUT
              echo "completed=true" >> $GITHUB_OUTPUT
              
            else
              echo "::error::âŒ Missing required file: $OUTPUT_FILENAME"
              echo "completed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
          else
            echo "::error::âŒ Local image directory not found: $LOCAL_IMAGE_DIR"
            echo "completed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Commit upload results
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No upload files to commit"
          else
            git commit -m "ğŸš€ Add FAL upload results: ${{ inputs.file-path }}

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi