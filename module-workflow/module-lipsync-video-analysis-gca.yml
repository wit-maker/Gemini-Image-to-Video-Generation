name: module-lipsync-video-analysis-gca

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      video-url:
        description: 'ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»URL'
        required: true
        type: string
      text-content:
        description: 'éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹'
        required: true
        type: string
      target-language:
        description: 'å­—å¹•è¨€èª (japanese ã¾ãŸã¯ english)'
        required: false
        type: string
        default: 'japanese'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      video_index:
        description: 'å‹•ç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹'
        required: false
        type: string
        default: '1'
    outputs:
      completed:
        description: 'è§£æå®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.lipsync-video-analysis.outputs.completed }}
      subtitle-timing-json:
        description: 'å­—å¹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­å®šJSON'
        value: ${{ jobs.lipsync-video-analysis.outputs.subtitle-timing-json }}
    secrets:
      gemini_api_key:
        description: 'Gemini API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  lipsync-video-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      completed: ${{ steps.analysis-complete.outputs.completed }}
      subtitle-timing-json: ${{ steps.analysis-complete.outputs.subtitle-timing-json }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
          
      - name: ğŸ“Š ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»å­—å¹•è§£æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Gemini Vision)
        id: analyze-lipsync-video
        uses: google-gemini/gemini-cli-action@main
        with:
          GEMINI_API_KEY: ${{ secrets.gemini_api_key }}
          prompt: |
            ğŸ“Š **ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»å­—å¹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°è§£æã‚¿ã‚¹ã‚¯ - Gemini Vision ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**
            
            **ã‚¿ã‚¹ã‚¯**: ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ã‚’åˆ†æã—ã€éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆã«åˆã‚ã›ãŸå­—å¹•è¡¨ç¤ºã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ±ºå®šã™ã‚‹
            
            **å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**:
            - **å‹•ç”»URL**: ${{ inputs.video-url }}
            - **éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆ**: "${{ inputs.text-content }}"
            - **å­—å¹•è¨€èª**: ${{ inputs.target-language }}
            - **åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: ${{ inputs.concept }}
            
            **é‡è¦**: å‹•ç”»URLãŒç©ºã¾ãŸã¯"undefined"ã®å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã—ã¦ãã ã•ã„
            
            **åˆ†ææ‰‹é †**:
            1. **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ**:
               ```bash
               mkdir -p ${{ inputs.folder-name }}/subtitle-analysis-${{ inputs.video_index }}
               ```
               
            2. **å‹•ç”»è§£æ**:
               - Gemini Vision APIã§å‹•ç”»ã®å£ã®å‹•ãã‚’åˆ†æ
               - è©±ã—ã¦ã„ã‚‹éƒ¨åˆ†ã¨ç„¡éŸ³éƒ¨åˆ†ã‚’ç‰¹å®š
               - ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ã®å“è³ªã¨åŒæœŸåº¦ã‚’è©•ä¾¡
               
            3. **ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ**:
               - éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆã‚’æ„å‘³ã®ã‚ã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«åˆ†å‰²
               - å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®èª­ã¿ä¸Šã’æ™‚é–“ã‚’æ¨å®š
               - è‡ªç„¶ãªåŒºåˆ‡ã‚Šãƒã‚¤ãƒ³ãƒˆã‚’ç‰¹å®š
               
            4. **å­—å¹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­è¨ˆ**:
               - å‹•ç”»ã®é•·ã•ã‚’ç¢ºèª
               - ãƒ†ã‚­ã‚¹ãƒˆé•·ã¨å‹•ç”»é•·ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®
               - èª­ã¿ã‚„ã™ã„å­—å¹•è¡¨ç¤ºæ™‚é–“ã‚’è¨­å®šï¼ˆæœ€ä½1.5ç§’ã€æœ€å¤§5ç§’ï¼‰
               - å­—å¹•ã®åˆ‡ã‚Šæ›¿ãˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å£ã®å‹•ãã«åŒæœŸ
               
            5. **å­—å¹•ã‚¹ã‚¿ã‚¤ãƒ«æœ€é©åŒ–**:
               - è¨€èªåˆ¥ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆæ—¥æœ¬èª: Noto Sans CJKã€è‹±èª: Arial/Helveticaï¼‰
               - å‹•ç”»ã‚µã‚¤ã‚ºã«é©ã—ãŸãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºæ±ºå®š
               - èƒŒæ™¯è‰²ã¨ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’è€ƒæ…®ã—ãŸæ–‡å­—è‰²è¨­å®š
               - å­—å¹•ä½ç½®ã®æœ€é©åŒ–ï¼ˆç”»é¢ä¸‹éƒ¨ä¸­å¤®ã‚’åŸºæœ¬ï¼‰
               
            6. **JSONè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ**:
               ä»¥ä¸‹ã®å½¢å¼ã§å­—å¹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°JSONã‚’ä½œæˆã—ã¦ãã ã•ã„:
               ```json
               {
                 "video_info": {
                   "duration": <å‹•ç”»ã®é•·ã•ï¼ˆç§’ï¼‰>,
                   "fps": 30,
                   "resolution": "1920x1080"
                 },
                 "subtitles": [
                   {
                     "id": 1,
                     "start_time": 0.0,
                     "end_time": 2.5,
                     "text": "å­—å¹•ãƒ†ã‚­ã‚¹ãƒˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆ1",
                     "position": "bottom_center",
                     "font_size": 24,
                     "font_color": "white",
                     "background_color": "rgba(0,0,0,0.7)",
                     "fade_in": 0.2,
                     "fade_out": 0.2
                   }
                 ],
                 "global_settings": {
                   "font_family": "${{ inputs.target-language == 'japanese' && 'NotoSansCJK-Regular' || 'Arial' }}",
                   "default_font_size": 24,
                   "default_position": "bottom_center",
                   "default_color": "white",
                   "default_background": "rgba(0,0,0,0.7)",
                   "line_spacing": 1.2,
                   "margin_bottom": 60,
                   "max_characters_per_line": 40,
                   "min_display_time": 1.5,
                   "max_display_time": 5.0
                 },
                 "analysis_metadata": {
                   "original_text": "${{ inputs.text-content }}",
                   "language": "${{ inputs.target-language }}",
                   "sync_quality": "é«˜å“è³ª/ä¸­å“è³ª/è¦æ”¹å–„",
                   "recommendations": ["æ”¹å–„ææ¡ˆ1", "æ”¹å–„ææ¡ˆ2"]
                 }
               }
               ```
               
            7. **åˆ†æçµæœä¿å­˜**:
               ```
               write_file(${{ inputs.folder-name }}/subtitle-analysis-${{ inputs.video_index }}/subtitle-timing.json, JSONè¨­å®šãƒ‡ãƒ¼ã‚¿)
               write_file(${{ inputs.folder-name }}/subtitle-analysis-${{ inputs.video_index }}/analysis-report.md, è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ)
               ```
               
            **åˆ†æãƒ¬ãƒãƒ¼ãƒˆå¿…é ˆé …ç›®**:
            - **å‹•ç”»å“è³ªè©•ä¾¡**: ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ã®ç²¾åº¦ã€éŸ³å£°åŒæœŸåº¦
            - **å­—å¹•è¨­è¨ˆåˆ¤æ–­**: ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­å®šã®æ ¹æ‹ 
            - **æŠ€è¡“çš„æ¨å¥¨äº‹é …**: ffmpegå®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹
            - **æ”¹å–„ææ¡ˆ**: ã‚ˆã‚Šè‰¯ã„å­—å¹•è¡¨ç¤ºã®ãŸã‚ã®ææ¡ˆ
            - **è¨€èªå›ºæœ‰è€ƒæ…®**: æ—¥æœ¬èª/è‹±èªãã‚Œãã‚Œã®æœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ
            
            **é‡è¦ãªè€ƒæ…®ç‚¹**:
            - å­—å¹•ã®å¯èª­æ€§ã‚’æœ€å„ªå…ˆ
            - å‹•ç”»ã®è¦–è¦šçš„è¦ç´ ã‚’é®ã‚‰ãªã„é…ç½®
            - å£ã®å‹•ãã¨å­—å¹•åˆ‡ã‚Šæ›¿ãˆã®è‡ªç„¶ãªåŒæœŸ
            - æ–‡ç« ã®æ„å‘³ã‚’ä¿æŒã—ãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å‰²
            - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼ˆèª­ã¿ã‚„ã™ã•ï¼‰ã¸ã®é…æ…®
            
            **å‡ºåŠ›è¦æ±‚**:
            1. subtitle-timing.jsonãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
            2. åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆanalysis-report.mdï¼‰ã®ä½œæˆ
            3. GitHub Outputsã¸ã®è¨­å®šå€¤å‡ºåŠ›

      - name: Mark analysis complete
        id: analysis-complete
        run: |
          ANALYSIS_DIR="${{ inputs.folder-name }}/subtitle-analysis-${{ inputs.video_index }}"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "$ANALYSIS_DIR/subtitle-timing.json" ]; then
            echo "âœ… å­—å¹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°JSONä½œæˆå®Œäº†"
            
            # JSONã®å†…å®¹ã‚’GitHub Outputã«è¨­å®š
            SUBTITLE_JSON=$(cat "$ANALYSIS_DIR/subtitle-timing.json" | jq -c .)
            echo "subtitle-timing-json=$SUBTITLE_JSON" >> $GITHUB_OUTPUT
            echo "completed=true" >> $GITHUB_OUTPUT
            
            # åˆ†æçµæœã®ç°¡æ˜“è¡¨ç¤º
            echo "::notice::å­—å¹•ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°: $(echo "$SUBTITLE_JSON" | jq '.subtitles | length')"
            echo "::notice::å‹•ç”»é•·: $(echo "$SUBTITLE_JSON" | jq -r '.video_info.duration')ç§’"
            
          else
            echo "::error::âŒ å­—å¹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "completed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Commit analysis results
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No analysis files to commit"
          else
            git commit -m "ğŸ“Š Add lipsync video subtitle analysis: ${{ inputs.concept }} (video-${{ inputs.video_index }})
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ãƒªãƒ™ãƒ¼ã‚¹ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ï¼‰
            git pull --rebase origin ${{ inputs.branch-name }} || true
            git push origin ${{ inputs.branch-name }}
          fi