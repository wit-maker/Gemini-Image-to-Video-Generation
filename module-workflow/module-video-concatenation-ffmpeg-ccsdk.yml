name: module-video-concatenation-ffmpeg-ccsdk

on:
  workflow_call:
    inputs:
      concept:
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
      total_segments:
        description: 'çµåˆã™ã‚‹å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°'
        required: true
        type: string
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
    outputs:
      video-url:
        description: 'çµåˆã•ã‚ŒãŸå‹•ç”»ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹'
        value: ${{ jobs.video-concatenation.outputs.video-url }}
      completed:
        description: 'å‡¦ç†å®Œäº†ãƒ•ãƒ©ã‚°'
        value: ${{ jobs.video-concatenation.outputs.completed }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  video-concatenation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      video-url: ${{ steps.concat-complete.outputs.video-url }}
      completed: ${{ steps.concat-complete.outputs.completed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
          echo "âœ… System dependencies installed successfully"
          
          # ffmpegã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
          echo "ğŸ“‹ FFmpeg version:"
          ffmpeg -version | head -5
      
      - name: ğŸ¬ å‹•ç”»çµåˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Claude Code SDK + ffmpeg)
        id: concatenate-videos
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
        run: |
          echo "::group::ğŸ¬ Video Concatenation Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          USER_CONCEPT="${{ inputs.concept }}"
          TOTAL_SEGMENTS="${{ inputs.total_segments }}"
          FOLDER_NAME="${{ inputs.folder-name }}"
          FINAL_VIDEO_DIR="$FOLDER_NAME/final-video"
          
          echo "User concept: $USER_CONCEPT"
          echo "Total segments: $TOTAL_SEGMENTS"
          echo "Folder name: $FOLDER_NAME"
          echo "Final video dir: $FINAL_VIDEO_DIR"
          
          # æœ€çµ‚å‹•ç”»ãƒ•ã‚©ãƒ«ãƒ€ã‚’äº‹å‰ã«ä½œæˆ
          if [ ! -d "$FINAL_VIDEO_DIR" ]; then
            mkdir -p "$FINAL_VIDEO_DIR"
            echo "ğŸ“ Created final video folder: $FINAL_VIDEO_DIR"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯å‹•ç”»çµåˆã®å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚è¤‡æ•°ã®ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ã‚’çµåˆã—ã¦æœ€çµ‚çš„ãªå‹•ç”»ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          **å…¥åŠ›æƒ…å ±**:
          - **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $USER_CONCEPT
          - **å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°**: $TOTAL_SEGMENTS
          - **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€**: $FOLDER_NAME
          - **æœ€çµ‚å‹•ç”»å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: $FINAL_VIDEO_DIR

          **å®Ÿè¡Œæ‰‹é †**:

          1. **å…¥åŠ›å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª**:
             \`\`\`bash
             # å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ã‚’ç¢ºèª
             for i in \$(seq 1 $TOTAL_SEGMENTS); do
               LIPSYNC_DIR=\"$FOLDER_NAME/lipsync-\$i\"
               if [ -d \"\$LIPSYNC_DIR\" ]; then
                 echo \"âœ… ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç™ºè¦‹: \$LIPSYNC_DIR\"
                 ls -la \"\$LIPSYNC_DIR\"
                 
                 # å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
                 VIDEO_FILE=\$(find \"\$LIPSYNC_DIR\" -name \"*.mp4\" -o -name \"*.mov\" -o -name \"*.avi\" | head -1)
                 if [ -f \"\$VIDEO_FILE\" ]; then
                   echo \"âœ… å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: \$VIDEO_FILE\"
                   echo \"\$VIDEO_FILE\" >> /tmp/video_list.txt
                 else
                   echo \"âŒ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãªã—: \$LIPSYNC_DIR\"
                 fi
               else
                 echo \"âŒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—: \$LIPSYNC_DIR\"
               fi
             done
             \`\`\`

          2. **ffmpegç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆä½œæˆ**:
             \`\`\`bash
             # ffmpeg concatãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ä½œæˆ
             echo \"# FFmpeg concat file list\" > \"$FINAL_VIDEO_DIR/concat_list.txt\"
             if [ -f \"/tmp/video_list.txt\" ]; then
               while read -r video_file; do
                 if [ -f \"\$video_file\" ]; then
                   echo \"file '\$(realpath \"\$video_file\")\'\" >> \"$FINAL_VIDEO_DIR/concat_list.txt\"
                 fi
               done < \"/tmp/video_list.txt\"
             fi
             
             echo \"ğŸ“‹ Concat list created:\"
             cat \"$FINAL_VIDEO_DIR/concat_list.txt\"
             \`\`\`

          3. **å‹•ç”»çµåˆã®å®Ÿè¡Œ**:
             \`\`\`bash
             # ffmpegã§å‹•ç”»ã‚’çµåˆ
             OUTPUT_VIDEO=\"$FINAL_VIDEO_DIR/concatenated-video.mp4\"
             
             ffmpeg -f concat -safe 0 -i \"$FINAL_VIDEO_DIR/concat_list.txt\" \\
                    -c copy \\
                    -avoid_negative_ts make_zero \\
                    \"\$OUTPUT_VIDEO\" -y
             
             if [ -f \"\$OUTPUT_VIDEO\" ]; then
               echo \"âœ… å‹•ç”»çµåˆå®Œäº†: \$OUTPUT_VIDEO\"
               
               # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
               OUTPUT_SIZE=\$(stat -c%s \"\$OUTPUT_VIDEO\" 2>/dev/null || stat -f%z \"\$OUTPUT_VIDEO\" 2>/dev/null || echo \"0\")
               OUTPUT_SIZE_MB=\$(echo \"scale=2; \$OUTPUT_SIZE / 1024 / 1024\" | bc -l 2>/dev/null || echo \"0\")
               echo \"ğŸ“‹ çµåˆå‹•ç”»ã‚µã‚¤ã‚º: \${OUTPUT_SIZE_MB}MB\"
               
               # å‹•ç”»ã®é•·ã•ã‚’ç¢ºèª
               if command -v ffprobe >/dev/null 2>&1; then
                 VIDEO_DURATION=\$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 \"\$OUTPUT_VIDEO\" 2>/dev/null || echo \"0\")
                 echo \"ğŸ“‹ çµåˆå‹•ç”»é•·ã•: \${VIDEO_DURATION}ç§’\"
               fi
               
               echo \"\$OUTPUT_VIDEO\" > \"$FINAL_VIDEO_DIR/final-video-path.txt\"
             else
               echo \"âŒ å‹•ç”»çµåˆå¤±æ•—\"
               exit 1
             fi
             \`\`\`

          4. **ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ**:
             \`\`\`bash
             # çµåˆãƒ­ã‚°ã‚’ä½œæˆ
             echo \"# å‹•ç”»çµåˆãƒ­ã‚°\" > \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             echo \"## çµåˆå¯¾è±¡å‹•ç”»\" >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             cat /tmp/video_list.txt >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\" 2>/dev/null || echo \"å‹•ç”»ãƒªã‚¹ãƒˆãªã—\" >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             echo \"## çµåˆã‚³ãƒãƒ³ãƒ‰\" >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             echo \"ffmpeg -f concat -safe 0 -i concat_list.txt -c copy -avoid_negative_ts make_zero concatenated-video.mp4\" >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             echo \"## çµåˆæ—¥æ™‚\" >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             date >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             echo \"## æœ€çµ‚å‹•ç”»æƒ…å ±\" >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             echo \"ãƒ•ã‚¡ã‚¤ãƒ«: concatenated-video.mp4\" >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             echo \"ã‚µã‚¤ã‚º: \${OUTPUT_SIZE_MB}MB\" >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             echo \"é•·ã•: \${VIDEO_DURATION}ç§’\" >> \"$FINAL_VIDEO_DIR/concatenation-log.txt\"
             \`\`\`

          **é‡è¦ãªæŠ€è¡“ãƒã‚¤ãƒ³ãƒˆ**:
          - ffmpeg concatãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ãŸé«˜å“è³ªçµåˆ
          - \`-c copy\`ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãªã—ã®é«˜é€Ÿå‡¦ç†
          - \`-avoid_negative_ts make_zero\`ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å•é¡Œã‚’å›é¿
          - å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆçµ±ä¸€ã‚’ç¢ºèª
          - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°å‡ºåŠ›

          **å‡ºåŠ›è¦æ±‚**:
          1. çµåˆå‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ« ($FINAL_VIDEO_DIR/concatenated-video.mp4)
          2. æœ€çµ‚å‹•ç”»ãƒ‘ã‚¹ãƒ•ã‚¡ã‚¤ãƒ« ($FINAL_VIDEO_DIR/final-video-path.txt)  
          3. çµåˆãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ« ($FINAL_VIDEO_DIR/concatenation-log.txt)
          4. ffmpegç”¨ãƒªã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« ($FINAL_VIDEO_DIR/concat_list.txt)"
          
          echo "ğŸš€ Starting Video Concatenation Agent Claude Code CLI..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Bash,Write" \
            --max-turns 30 \
            --verbose \
            --permission-mode "acceptEdits" \
            -p "$PROMPT" || {
              echo "::error::âŒ Claude Code CLI execution failed"
              exit 1
            }
          
          echo "::endgroup::"

      - name: Mark concatenation complete
        id: concat-complete
        run: |
          FOLDER_NAME="${{ inputs.folder-name }}"
          FINAL_VIDEO_DIR="$FOLDER_NAME/final-video"
          FINAL_VIDEO_PATH_FILE="$FINAL_VIDEO_DIR/final-video-path.txt"
          
          # çµåˆã•ã‚ŒãŸå‹•ç”»ã®ç¢ºèª
          echo "ğŸ“‹ Checking concatenated video..."
          echo "Final video dir: $FINAL_VIDEO_DIR"
          echo "Final video path file: $FINAL_VIDEO_PATH_FILE"
          
          if [ -d "$FINAL_VIDEO_DIR" ]; then
            echo "::notice::ğŸ“ Final video directory contents:"
            ls -la "$FINAL_VIDEO_DIR"
            
            # æœ€çµ‚å‹•ç”»ãƒ‘ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            if [ -f "$FINAL_VIDEO_PATH_FILE" ]; then
              echo "âœ… Found: final-video-path.txt"
              FINAL_VIDEO_PATH=$(cat "$FINAL_VIDEO_PATH_FILE")
              echo "ğŸ“ Final video path: $FINAL_VIDEO_PATH"
              
              if [ -f "$FINAL_VIDEO_PATH" ]; then
                FINAL_SIZE=$(stat -c%s "$FINAL_VIDEO_PATH" 2>/dev/null || stat -f%z "$FINAL_VIDEO_PATH" 2>/dev/null || echo "0")
                FINAL_SIZE_MB=$(echo "scale=2; $FINAL_SIZE / 1024 / 1024" | bc -l 2>/dev/null || echo "0")
                echo "::notice::ğŸ¬ Final video created successfully: ${FINAL_SIZE_MB}MB"
                echo "video-url=$FINAL_VIDEO_PATH" >> $GITHUB_OUTPUT
                echo "completed=true" >> $GITHUB_OUTPUT
              else
                echo "::error::âŒ Final video file not found: $FINAL_VIDEO_PATH"
                echo "completed=false" >> $GITHUB_OUTPUT
                exit 1
              fi
              
            else
              echo "::error::âŒ Missing required file: final-video-path.txt"
              echo "completed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
          else
            echo "::error::âŒ Final video directory not found: $FINAL_VIDEO_DIR"
            echo "completed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Commit concatenation results
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No concatenation files to commit"
          else
            git commit -m "ğŸ¬ Add concatenated video results: ${{ inputs.concept }}

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi