name: module-banner-autonomous-generation-ccsdk

on:
  workflow_call:
    inputs:
      image-prompt:
        description: 'ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã§æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        required: true
        type: string
      concept:
        description: 'å…ƒã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼ˆè©•ä¾¡ç”¨ï¼‰'
        required: true
        type: string
      text-overlay-prompt:
        description: 'ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        required: true
        type: string
      text_content:
        description: 'ç”»åƒã«è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ'
        required: true
        type: string
      banner_size:
        description: 'ãƒãƒŠãƒ¼ã‚µã‚¤ã‚º'
        required: false
        type: string
        default: 'square_1_1'
      input_mode:
        description: 'å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ (prompt_only/with_image)'
        required: false
        type: string
        default: 'prompt_only'
      branch-name:
        description: 'ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        type: string
      folder-name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
    outputs:
      completed:
        description: 'å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
        value: ${{ jobs.autonomous-generation.outputs.completed }}
      image-url:
        description: 'ç”Ÿæˆã•ã‚ŒãŸãƒãƒŠãƒ¼ç”»åƒã®URL'
        value: ${{ jobs.autonomous-generation.outputs.image-url }}
      image-prompt:
        description: 'æœ€çµ‚çš„ã«ä½¿ç”¨ã•ã‚ŒãŸç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.autonomous-generation.outputs.image-prompt }}
      text-overlay-prompt:
        description: 'æœ€çµ‚çš„ã«ä½¿ç”¨ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        value: ${{ jobs.autonomous-generation.outputs.text-overlay-prompt }}
      iterations:
        description: 'æ”¹å–„ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°'
        value: ${{ jobs.autonomous-generation.outputs.iterations }}
      final-score:
        description: 'æœ€çµ‚è©•ä¾¡ã‚¹ã‚³ã‚¢'
        value: ${{ jobs.autonomous-generation.outputs.final-score }}
    secrets:
      anthropic_api_key:
        description: 'Anthropic API Key'
        required: true
      gemini_api_key:
        description: 'Gemini API Key'
        required: true
      github_pat:
        description: 'GitHub Token'
        required: true

jobs:
  autonomous-generation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      completed: ${{ steps.generate.outputs.completed }}
      image-url: ${{ steps.generate.outputs.image-url }}
      image-prompt: ${{ steps.generate.outputs.image-prompt }}
      text-overlay-prompt: ${{ steps.generate.outputs.text-overlay-prompt }}
      iterations: ${{ steps.generate.outputs.iterations }}
      final-score: ${{ steps.generate.outputs.final-score }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch-name }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install @anthropic-ai/claude-code
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Python dependencies
        run: |
          pip install google-generativeai
          pip install requests
      
      - name: Install ImageMagick
        run: |
          # GitHub Actions ubuntu-latest ã«ImageMagickã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get update
          sudo apt-get install -y imagemagick
      
      - name: ğŸ¯ è‡ªå¾‹ä¿®æ­£ãƒãƒŠãƒ¼ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.anthropic_api_key }}
          GEMINI_API_KEY: ${{ secrets.gemini_api_key }}
        run: |
          echo "::group::ğŸ¯ Autonomous Banner Generation Agent Execution"
          echo "Starting at: $(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
          
          # è¨­å®š
          IMAGE_PROMPT='${{ inputs.image-prompt }}'
          CONCEPT='${{ inputs.concept }}'
          TEXT_OVERLAY_PROMPT='${{ inputs.text-overlay-prompt }}'
          USER_TEXT_CONTENT='${{ inputs.text_content }}'
          BANNER_SIZE='${{ inputs.banner_size }}'
          INPUT_MODE='${{ inputs.input_mode }}'
          FOLDER_NAME='${{ inputs.folder-name }}'
          MAX_ITERATIONS="5"
          
          echo "âœ… Planning results received:"
          echo "Image prompt: $IMAGE_PROMPT"
          echo "Concept: $CONCEPT"
          echo "Text overlay prompt: $TEXT_OVERLAY_PROMPT"
          echo "User text content: $USER_TEXT_CONTENT"
          echo "Banner size: $BANNER_SIZE"
          echo "Input mode: $INPUT_MODE"
          echo "Project folder: $FOLDER_NAME"
          
          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’äº‹å‰ã«ä½œæˆ
          mkdir -p "$FOLDER_NAME/config"
          mkdir -p "$FOLDER_NAME/planning"
          mkdir -p "$FOLDER_NAME/iterations"
          mkdir -p "$FOLDER_NAME/final"
          mkdir -p "$FOLDER_NAME/logs"
          if [ "$INPUT_MODE" = "with_image" ]; then
            mkdir -p "$FOLDER_NAME/input"
          fi
          
          # MCPè¨­å®šã®ç¢ºèª
          MCP_CONFIG_PATH=".claude/mcp-kamuicode.json"
          MCP_CONFIG_ABS_PATH="$(pwd)/$MCP_CONFIG_PATH"
          
          if [ -f "$MCP_CONFIG_ABS_PATH" ]; then
            echo "âœ… MCP config file exists at: $MCP_CONFIG_ABS_PATH"
          else
            echo "âŒ MCP config file not found at: $MCP_CONFIG_ABS_PATH"
            exit 1
          fi
          
          # CCSDKãƒ­ã‚°ãƒ‘ãƒ¼ã‚µãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          if [ -f "scripts/ccsdk-log-parser.sh" ]; then
            chmod +x scripts/ccsdk-log-parser.sh
            LOG_PARSER="| scripts/ccsdk-log-parser.sh"
            echo "âœ… CCSDK log parser enabled"
          else
            LOG_PARSER=""
            echo "âš ï¸ CCSDK log parser not found, using standard output"
          fi
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯è‡ªå¾‹çš„ãƒãƒŠãƒ¼ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚è©•ä¾¡åŸºæº–ã‚’æº€ãŸã™ã¾ã§è‡ªå‹•çš„ã«æ”¹å–„ã‚’ç¹°ã‚Šè¿”ã—ã¦ãã ã•ã„ã€‚

          åŸºæœ¬æƒ…å ±:
          - å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰: $INPUT_MODE
          - ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: $CONCEPT ï¼ˆè©•ä¾¡ãƒ»æ”¹å–„æ™‚ã®ç›®æ¨™åŸºæº–ã¨ã—ã¦å‚ç…§ï¼‰
          - åˆæœŸç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $IMAGE_PROMPT
          - åˆæœŸãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $TEXT_OVERLAY_PROMPT
          - è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ: '$USER_TEXT_CONTENT' ï¼ˆä¸€å­—ä¸€å¥å¤‰æ›´ç¦æ­¢ï¼‰
          - ãƒãƒŠãƒ¼ã‚µã‚¤ã‚º: $BANNER_SIZE
          - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€: $FOLDER_NAME
          - æœ€å¤§ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: $MAX_ITERATIONS

          é‡è¦ - åˆ©ç”¨å¯èƒ½ãƒ„ãƒ¼ãƒ«:
          - Read/Write/Edit: ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
          - Bash: ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆGemini Vision APIå‘¼ã³å‡ºã—å«ã‚€ï¼‰
          - mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit/status/result: ç”»åƒç”Ÿæˆ
          - mcp__i2i-fal-flux-kontext-max__flux_kontext_submit/status/result: ãƒ†ã‚­ã‚¹ãƒˆåˆæˆ
          - ffmpeg: ç”»åƒã®è‰²èª¿ãƒ»æ˜åº¦ãƒ»ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ»ã‚¬ãƒ³ãƒè£œæ­£ãƒ»ã‚·ãƒ£ãƒ¼ãƒ—ãƒã‚¹ãƒ»ãƒã‚¤ã‚ºé™¤å»ï¼ˆè©³ç´°ã¯ .github/workflows/usage/ffmpeg-usage.md å‚ç…§ï¼‰
          - ImageMagick (magick): åŒ…æ‹¬çš„ãªç”»åƒå‡¦ç†ãƒ»åŠ å·¥ï¼ˆè©³ç´°ã¯ .github/workflows/usage/imagemagick-usage.md å‚ç…§ï¼‰

          å®Ÿè¡Œæ‰‹é †:

          1. åˆæœŸè¨­å®š:
             - è©•ä¾¡åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿: .github/workflows/docs/banner-evaluation-criteria.md
             - ç”Ÿæˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ: $FOLDER_NAME/config/banner-generation-templates.md
             - ImageMagickä½¿ç”¨æ–¹æ³•ã‚’ç¢ºèª: .github/workflows/usage/imagemagick-usage.md ã‚’èª­ã¿è¾¼ã‚€
             - FFmpegä½¿ç”¨æ–¹æ³•ã‚’ç¢ºèª: .github/workflows/usage/ffmpeg-usage.md ã‚’èª­ã¿è¾¼ã‚€
             - GitHub Actions Summaryã®åˆæœŸåŒ–

          2. å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®å‡¦ç†:
             ${INPUT_MODE}ãƒ¢ãƒ¼ãƒ‰ã§è©•ä¾¡åŸºæº–ã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åŸºã¥ãè‡ªå¾‹ä¿®æ­£ãƒ«ãƒ¼ãƒ—ã§å“è³ªå‘ä¸Š

          3. è‡ªå¾‹ä¿®æ­£ãƒ«ãƒ¼ãƒ— (æœ€å¤§$MAX_ITERATIONSå›):
             å„ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
             
             a) ãƒãƒŠãƒ¼ç”Ÿæˆ:
                - ãƒ™ãƒ¼ã‚¹ç”»åƒç”Ÿæˆï¼ˆmcp__t2i-fal-imagen4-ultra__*ï¼‰
                - ãƒ†ã‚­ã‚¹ãƒˆåˆæˆï¼ˆmcp__i2i-fal-flux-kontext-max__*ï¼‰
                - å¿…è¦ã«å¿œã˜ã¦ç”»åƒå¾Œå‡¦ç†ï¼ˆffmpegã€ImageMagickä½µç”¨ï¼‰
                - $FOLDER_NAME/iterations/banner-v{N}.png ã¨ã—ã¦ä¿å­˜
             
             b) Gemini Visionè©•ä¾¡:
                - curlã‚³ãƒãƒ³ãƒ‰ã§Gemini Vision APIã‚’ç›´æ¥å‘¼ã³å‡ºã—
                - ç”»åƒã‚’base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦é€ä¿¡
                - è©•ä¾¡åŸºæº–ã«åŸºã¥ã„ã¦1-100ç‚¹ã§æ¡ç‚¹
                - æŠ€è¡“å“è³ªã€ãƒ‡ã‚¶ã‚¤ãƒ³å“è³ªã€å•†ç”¨ä¾¡å€¤ã‚’è©³ç´°è©•ä¾¡
                - æ”¹å–„ææ¡ˆã‚‚åŒæ™‚ã«ç”Ÿæˆ
                
             c) è©•ä¾¡çµæœåˆ¤å®š:
                - ç·åˆã‚¹ã‚³ã‚¢70ç‚¹ä»¥ä¸Šã§åˆæ ¼
                - å„é …ç›®ã®æœ€ä½åŸºæº–ã‚‚ãƒã‚§ãƒƒã‚¯
             
             d) GitHub Actions Summaryæ›´æ–°:
                - å„ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã‚’è¨˜éŒ²
                - ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€è©•ä¾¡ã‚¹ã‚³ã‚¢ã€æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜è¼‰
             
             e) æœªé”æˆæ™‚ã®æ”¹å–„:
                - è©•ä¾¡çµæœã‹ã‚‰å•é¡Œç‚¹ã‚’ç‰¹å®š
                - **ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨ã®æ•´åˆæ€§ã‚’å¿…ãšç¢ºèª**
                - æ”¹å–„æ–¹æ³•ã‚’é¸æŠï¼š
                  1) ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´ â†’ AIå†ç”Ÿæˆ
                  2) ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´ â†’ AIå†ç”Ÿæˆ  
                  3) ç”»åƒå¾Œå‡¦ç†èª¿æ•´ â†’ ffmpeg/ImageMagickå‡¦ç†
                - æ”¹å–„ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦å†ç”Ÿæˆ
                - æ”¹å–„å±¥æ­´ã‚’è¨˜éŒ²ï¼ˆã©ã®æ–¹æ³•ã§ã©ã†èª¿æ•´ã—ãŸã‹ï¼‰

          4. æœ€çµ‚å‡¦ç†:
             - æœ€è‰¯ã®ãƒãƒŠãƒ¼ã‚’ $FOLDER_NAME/final/banner.png ã«ã‚³ãƒ”ãƒ¼
             - æœ€çµ‚çš„ã«ä½¿ç”¨ã—ãŸç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ $FOLDER_NAME/final/image-prompt.txt ã«ä¿å­˜
             - æœ€çµ‚çš„ã«ä½¿ç”¨ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ $FOLDER_NAME/final/text-overlay-prompt.txt ã«ä¿å­˜
             - è©•ä¾¡å±¥æ­´ã‚’ $FOLDER_NAME/evaluation-history.md ã«ä¿å­˜
             - GitHub Outputsã«çµæœã‚’è¨­å®šï¼ˆimage-promptã€text-overlay-promptå«ã‚€ï¼‰

          è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ :
          - è©•ä¾¡åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.github/workflows/docs/banner-evaluation-criteria.mdï¼‰ã®è©³ç´°åŸºæº–ã‚’ä½¿ç”¨
          - Gemini Vision APIã§1-100ç‚¹ã®å³æ ¼ãªæ¡ç‚¹ã‚’å®Ÿè¡Œ
          - ç·åˆã‚¹ã‚³ã‚¢70ç‚¹ä»¥ä¸Šã§åˆæ ¼ã€æœªé”æˆæ™‚ã¯è‡ªå‹•æ”¹å–„

          **æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ**:
          1. **ã‚³ãƒ³ã‚»ãƒ—ãƒˆéµå®ˆ**: æ”¹å–„æ™‚ã¯å¿…ãšã‚³ãƒ³ã‚»ãƒ—ãƒˆã«ç«‹ã¡æˆ»ã‚Šã€æœ¬è³ªã‹ã‚‰å¤–ã‚Œãªã„ã‚ˆã†æ³¨æ„
          2. **ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´**: è‰²èª¿ã€æ§‹å›³ã€é›°å›²æ°—ã€èƒŒæ™¯ãƒ‡ã‚¶ã‚¤ãƒ³ã®æ”¹å–„
          3. **ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´**: ãƒ•ã‚©ãƒ³ãƒˆã€é…ç½®ã€è‰²ã€èª­ã¿ã‚„ã™ã•ã®æ”¹å–„
          4. **ç”»åƒå¾Œå‡¦ç†èª¿æ•´**: AIç”Ÿæˆã ã‘ã§è§£æ±ºã—ãªã„å“è³ªå•é¡Œã¸ã®å¯¾å‡¦
          5. **ä¸¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é€£æº**: ç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆãŒèª¿å’Œã™ã‚‹ç·åˆçš„ãªãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ç›®æŒ‡ã™
          6. **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨˜éŒ²**: å„å›ã®æ”¹å–„ç†ç”±ã¨çµæœã‚’è©³ç´°ã«è¨˜éŒ²
          
          **ç”»åƒå¾Œå‡¦ç†ã®å…·ä½“ä¾‹**:
          ImageMagickã®è©³ç´°ãªä½¿ç”¨æ–¹æ³•ã¯ .github/workflows/usage/imagemagick-usage.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
          FFmpegã®è©³ç´°ãªä½¿ç”¨æ–¹æ³•ã¯ .github/workflows/usage/ffmpeg-usage.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
          
          ```bash
          # ImageMagickã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèªã¨è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          if ! command -v magick &> /dev/null; then
              echo \"ImageMagick not found, installing...\"
              brew install imagemagick
          fi
          ```
          
          é‡è¦: è©•ä¾¡æ™‚ã¯å¿…ãšè©•ä¾¡åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°é …ç›®ã«å¾“ã£ã¦æ¡ç‚¹ã—ã¦ãã ã•ã„

          Gemini Vision APIå‘¼ã³å‡ºã—ä¾‹:
          ä»¥ä¸‹ã®ã‚ˆã†ãªBashã‚³ãƒ¼ãƒ‰ã§Gemini Vision APIã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š

          ```bash
          # ç”»åƒã‚’base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
          IMAGE_BASE64=\$(base64 -w 0 \${FOLDER_NAME}/iterations/banner-v1.png)
          
          # Gemini Vision APIå‘¼ã³å‡ºã—
          RESPONSE=\$(curl -s -X POST \\
            \"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent\" \\
            -H \"x-goog-api-key: \${GEMINI_API_KEY}\" \\
            -H \"Content-Type: application/json\" \\
            -d \"{
              \\\"contents\\\": [
                {
                  \\\"parts\\\": [
                    {\\\"text\\\": \\\"ã“ã®ãƒãƒŠãƒ¼ç”»åƒã‚’è©•ä¾¡åŸºæº–ã«åŸºã¥ã„ã¦1-100ç‚¹ã§æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚æŠ€è¡“å“è³ª30ç‚¹ã€ãƒ‡ã‚¶ã‚¤ãƒ³å“è³ª40ç‚¹ã€å•†ç”¨ä¾¡å€¤30ç‚¹ã§è©•ä¾¡ã—ã€æ”¹å–„ææ¡ˆã‚‚å«ã‚ã¦ãã ã•ã„ã€‚\\\"},
                    {\\\"inline_data\\\": {\\\"mime_type\\\": \\\"image/png\\\", \\\"data\\\": \\\"\$IMAGE_BASE64\\\"}}
                  ]
                }
              ]
            }\")
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰è©•ä¾¡çµæœã‚’æŠ½å‡º
          EVALUATION=\$(echo \"\$RESPONSE\" | jq -r '.candidates[0].content.parts[0].text')
          ```

          - ãƒ†ã‚­ã‚¹ãƒˆã€Œ$USER_TEXT_CONTENTã€ã¯çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„
          - å„ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã‚’å¿…ãšä¿å­˜
          - è©•ä¾¡ã¯å³æ ¼ã«è¡Œã†ï¼ˆå¦¥å”ã—ãªã„ï¼‰
          - å…¨ãƒ—ãƒ­ã‚»ã‚¹ã‚’GitHub Summaryã§å¯è¦–åŒ–
          - Gemini API Keyã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—: \$GEMINI_API_KEY"

          echo "ğŸš€ Starting Autonomous Banner Generation Agent..."
          echo "ğŸ“ Prompt length: ${#PROMPT}"
          
          # Claude Code CLIã®å®Ÿè¡Œï¼ˆãƒ­ã‚°ãƒ‘ãƒ¼ã‚µãƒ¼ä»˜ãï¼‰
          if [ -n "$LOG_PARSER" ]; then
            npx @anthropic-ai/claude-code \
              --mcp-config="$MCP_CONFIG_ABS_PATH" \
              --allowedTools "Read,Write,Edit,Bash,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result,mcp__i2i-fal-flux-kontext-max__flux_kontext_submit,mcp__i2i-fal-flux-kontext-max__flux_kontext_status,mcp__i2i-fal-flux-kontext-max__flux_kontext_result" \
              --max-turns 140 \
              --verbose \
              --output-format stream-json \
              --permission-mode "acceptEdits" \
              -p "$PROMPT" 2>&1 | scripts/ccsdk-log-parser.sh | tee "$FOLDER_NAME/logs/ccsdk-output.log"
          else
            npx @anthropic-ai/claude-code \
              --mcp-config="$MCP_CONFIG_ABS_PATH" \
              --allowedTools "Read,Write,Edit,Bash,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_submit,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_status,mcp__t2i-fal-imagen4-ultra__imagen4_ultra_result,mcp__i2i-fal-flux-kontext-max__flux_kontext_submit,mcp__i2i-fal-flux-kontext-max__flux_kontext_status,mcp__i2i-fal-flux-kontext-max__flux_kontext_result" \
              --max-turns 140 \
              --verbose \
              --permission-mode "acceptEdits" \
              -p "$PROMPT" || {
                echo "::error::âŒ Claude Code CLI execution failed"
                exit 1
              }
          fi
          
          # ç”Ÿæˆçµæœã®ç¢ºèªã¨GitHub Outputsã®è¨­å®š
          echo ""
          echo "ğŸ¨ Checking generated banners..."
          
          # æœ€çµ‚ãƒãƒŠãƒ¼ã®ç¢ºèª
          if [ -f "$FOLDER_NAME/final/banner.png" ]; then
            echo "âœ… Final banner generated successfully"
            echo "image-url=$FOLDER_NAME/final/banner.png" >> $GITHUB_OUTPUT
          else
            echo "::warning::âš ï¸ Final banner not found, checking iterations..."
            # ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰æœ€æ–°ã®ãƒãƒŠãƒ¼ã‚’æ¢ã™
            LATEST_BANNER=$(ls -t "$FOLDER_NAME/iterations/banner-v"*.png 2>/dev/null | head -1)
            if [ -n "$LATEST_BANNER" ]; then
              cp "$LATEST_BANNER" "$FOLDER_NAME/final/banner.png"
              echo "image-url=$FOLDER_NAME/final/banner.png" >> $GITHUB_OUTPUT
            else
              echo "::error::âŒ No banner images were generated"
              exit 1
            fi
          fi
          
          # ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°ã®ç¢ºèª
          ITERATION_COUNT=$(ls "$FOLDER_NAME/iterations/banner-v"*.png 2>/dev/null | wc -l)
          echo "iterations=$ITERATION_COUNT" >> $GITHUB_OUTPUT
          echo "::notice::ğŸ“Š Total iterations: $ITERATION_COUNT"
          
          # è©•ä¾¡å±¥æ­´ã‹ã‚‰æœ€çµ‚ã‚¹ã‚³ã‚¢ã‚’æŠ½å‡ºï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          if [ -f "$FOLDER_NAME/evaluation-history.md" ]; then
            FINAL_SCORE=$(grep -oP "æœ€çµ‚ã‚¹ã‚³ã‚¢.*?(\d+)" "$FOLDER_NAME/evaluation-history.md" | grep -oP "\d+" | tail -1)
            if [ -n "$FINAL_SCORE" ]; then
              echo "final-score=$FINAL_SCORE" >> $GITHUB_OUTPUT
              echo "::notice::ğŸ¯ Final score: $FINAL_SCORE"
            else
              echo "final-score=N/A" >> $GITHUB_OUTPUT
            fi
          else
            echo "final-score=N/A" >> $GITHUB_OUTPUT
          fi
          
          # æœ€çµ‚çš„ã«ä½¿ç”¨ã•ã‚ŒãŸimage-promptã®ç¢ºèª
          if [ -f "$FOLDER_NAME/final/image-prompt.txt" ]; then
            FINAL_IMAGE_PROMPT=$(cat "$FOLDER_NAME/final/image-prompt.txt" | tr '\n' ' ')
            echo "image-prompt=$FINAL_IMAGE_PROMPT" >> $GITHUB_OUTPUT
            echo "::notice::ğŸ¯ Final image prompt: $FINAL_IMAGE_PROMPT"
          else
            echo "image-prompt=N/A" >> $GITHUB_OUTPUT
            echo "::warning::âš ï¸ Final image prompt not found"
          fi
          
          # æœ€çµ‚çš„ã«ä½¿ç”¨ã•ã‚ŒãŸtext-overlay-promptã®ç¢ºèª
          if [ -f "$FOLDER_NAME/final/text-overlay-prompt.txt" ]; then
            FINAL_TEXT_OVERLAY_PROMPT=$(cat "$FOLDER_NAME/final/text-overlay-prompt.txt" | tr '\n' ' ')
            echo "text-overlay-prompt=$FINAL_TEXT_OVERLAY_PROMPT" >> $GITHUB_OUTPUT
            echo "::notice::ğŸ¯ Final text overlay prompt: $FINAL_TEXT_OVERLAY_PROMPT"
          else
            echo "text-overlay-prompt=N/A" >> $GITHUB_OUTPUT
            echo "::warning::âš ï¸ Final text overlay prompt not found"
          fi
          
          # GitHub Actions Summaryç”Ÿæˆ
          echo "# ğŸ¯ è‡ªå¾‹ãƒãƒŠãƒ¼ç”Ÿæˆçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: $(echo "$CONCEPT" | cut -c1-100)..." >> $GITHUB_STEP_SUMMARY
          echo "- **è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ**: $USER_TEXT_CONTENT" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒãƒŠãƒ¼ã‚µã‚¤ã‚º**: $BANNER_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ€å¤§ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°**: $MAX_ITERATIONS" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°**: $ITERATION_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ¨ æœ€çµ‚ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$(echo "$IMAGE_PROMPT" | cut -c1-500)..." >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$(echo "$TEXT_OVERLAY_PROMPT" | cut -c1-300)..." >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœè¡¨ç¤ºï¼ˆã‚µã‚¤ã‚ºåˆ¶é™å¯¾å¿œï¼‰
          if [ -d "$FOLDER_NAME/iterations" ] && [ $ITERATION_COUNT -gt 0 ]; then
            echo "## ğŸ”„ ç”Ÿæˆã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # æœ€å¤§3ã¤ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿è¡¨ç¤ºï¼ˆã‚µã‚¤ã‚ºåˆ¶é™å¯¾ç­–ï¼‰
            iteration_count=0
            for banner_file in $(find "$FOLDER_NAME/iterations" -name "banner-v*.png" | sort -V); do
              if [ -f "$banner_file" ] && [ $iteration_count -lt 3 ]; then
                banner_name=$(basename "$banner_file")
                iteration_num=$(echo "$banner_name" | grep -oP 'v\K\d+')
                
                echo "### ğŸ“¸ Iteration $iteration_num" >> $GITHUB_STEP_SUMMARY
                # ç”»åƒã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ã¿è¡¨ç¤ºï¼ˆBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å›é¿ï¼‰
                echo "**ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«**: \`$banner_file\`" >> $GITHUB_STEP_SUMMARY
                
                # è©•ä¾¡çµæœãŒã‚ã‚Œã°è¡¨ç¤ºï¼ˆç°¡æ½”ç‰ˆï¼‰
                eval_file="$FOLDER_NAME/iterations/evaluation-v$iteration_num.md"
                if [ -f "$eval_file" ]; then
                  echo "**è©•ä¾¡çµæœ**:" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  head -5 "$eval_file" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                fi
                echo "" >> $GITHUB_STEP_SUMMARY
                iteration_count=$((iteration_count + 1))
              fi
            done
            
            # æ®‹ã‚Šã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯æ•°ã®ã¿è¡¨ç¤º
            if [ $ITERATION_COUNT -gt 3 ]; then
              remaining=$((ITERATION_COUNT - 3))
              echo "**ãã®ä»–**: $remaining å€‹ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¿½åŠ ã§å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # æœ€çµ‚çµæœ
          echo "## ğŸ† æœ€çµ‚çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "$FOLDER_NAME/final/banner.png" ]; then
            # æœ€çµ‚ç”»åƒã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ã¿è¡¨ç¤ºï¼ˆã‚µã‚¤ã‚ºåˆ¶é™å¯¾ç­–ï¼‰
            echo "**æœ€çµ‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«**: \`$FOLDER_NAME/final/banner.png\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # æœ€çµ‚ã‚¹ã‚³ã‚¢è¡¨ç¤º
            if [ -n "$FINAL_SCORE" ] && [ "$FINAL_SCORE" != "N/A" ]; then
              echo "**æœ€çµ‚ã‚¹ã‚³ã‚¢**: $FINAL_SCORE/100ç‚¹" >> $GITHUB_STEP_SUMMARY
              if [ "$FINAL_SCORE" -ge 70 ]; then
                echo "âœ… **åˆæ ¼** (70ç‚¹ä»¥ä¸Šé”æˆ)" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ **è¦æ”¹å–„** (70ç‚¹æœªæº€)" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "**æœ€çµ‚ã‚¹ã‚³ã‚¢**: è©•ä¾¡ä¸­" >> $GITHUB_STEP_SUMMARY
            fi
            
            # æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæƒ…å ±
            if [ -f "$FOLDER_NAME/final/image-prompt.txt" ] && [ -f "$FOLDER_NAME/final/text-overlay-prompt.txt" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸ“ æœ€çµ‚ä½¿ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" >> $GITHUB_STEP_SUMMARY
              echo "**ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $(head -1 "$FOLDER_NAME/final/image-prompt.txt" | cut -c1-100)..." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: $(head -1 "$FOLDER_NAME/final/text-overlay-prompt.txt" | cut -c1-100)..." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ æœ€çµ‚ãƒãƒŠãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "::endgroup::"
      
      - name: Commit and push results
        env:
          GH_TOKEN: ${{ secrets.github_pat }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ inputs.folder-name }}/
          if git diff --cached --quiet; then
            echo "No files to commit"
          else
            git commit -m "Add autonomous banner generation results: ${{ inputs.concept }}

            Text: ${{ inputs.text_content }}
            Mode: ${{ inputs.input_mode }}
            Iterations: ${{ steps.generate.outputs.iterations }}
            Final Score: ${{ steps.generate.outputs.final-score }}

            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            # ä¸¦åˆ—å®Ÿè¡Œã§ã®ç«¶åˆã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
            for i in {1..3}; do
              git pull --rebase origin ${{ inputs.branch-name }} || true
              if git push origin ${{ inputs.branch-name }}; then
                echo "âœ… Push successful on attempt $i"
                break
              else
                echo "âš ï¸ Push failed on attempt $i, retrying..."
                # ãƒ©ãƒ³ãƒ€ãƒ ãªå¾…æ©Ÿæ™‚é–“ï¼ˆ1-5ç§’ï¼‰
                sleep $((RANDOM % 5 + 1))
              fi
            done
          fi